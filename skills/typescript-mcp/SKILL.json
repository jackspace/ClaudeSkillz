{
  "description": "|",
  "metadata": {
    "allowedTools": "[Read, Write, Edit, Bash, Grep, Glob]",
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/authentication-guide.md",
      "references/cloudflare-agents-vs-standalone.md",
      "references/cloudflare-integration.md",
      "references/common-errors.md",
      "references/deployment-guide.md",
      "references/testing-guide.md",
      "references/tool-patterns.md"
    ]
  },
  "content": "Build production-ready Model Context Protocol (MCP) servers using TypeScript and deploy them on Cloudflare Workers. This skill covers the official `@modelcontextprotocol/sdk`, HTTP transport setup, authentication patterns, Cloudflare service integrations, and comprehensive error prevention.\r\n\r\n---\r\n\r\n\r\n### Pattern 1: API Key (Recommended for Most Cases)\r\n\r\n**Setup:**\r\n1. Create KV namespace: `wrangler kv namespace create MCP_API_KEYS`\r\n2. Add to `wrangler.jsonc`:\r\n```jsonc\r\n{\r\n  \"kv_namespaces\": [\r\n    { \"binding\": \"MCP_API_KEYS\", \"id\": \"YOUR_NAMESPACE_ID\" }\r\n  ]\r\n}\r\n```\r\n\r\n**Implementation:**\r\n```typescript\r\nasync function verifyApiKey(key: string, env: Env): Promise<boolean> {\r\n  const storedKey = await env.MCP_API_KEYS.get(`key:${key}`);\r\n  return storedKey !== null;\r\n}\r\n```\r\n\r\n**Manage keys:**\r\n```bash\r\nwrangler kv key put --binding=MCP_API_KEYS \"key:abc123\" \"true\"\r\n\r\n\r\n### 1. Unit Testing with Vitest\r\n\r\n```typescript\r\nimport { describe, it, expect } from 'vitest';\r\nimport { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';\r\nimport { z } from 'zod';\r\n\r\ndescribe('Calculator Tool', () => {\r\n  it('should add two numbers', async () => {\r\n    const server = new McpServer({ name: 'test', version: '1.0.0' });\r\n\r\n    server.registerTool(\r\n      'add',\r\n      {\r\n        description: 'Adds two numbers',\r\n        inputSchema: z.object({\r\n          a: z.number(),\r\n          b: z.number()\r\n        })\r\n      },\r\n      async ({ a, b }) => ({\r\n        content: [{ type: 'text', text: String(a + b) }]\r\n      })\r\n    );\r\n\r\n    // Test tool execution\r\n    const result = await server.callTool('add', { a: 5, b: 3 });\r\n    expect(result.content[0].text).toBe('8');\r\n  });\r\n});\r\n```\r\n\r\n**Install:**\r\n```bash\r\nnpm install -D vitest @cloudflare/vitest-pool-workers\r\n```\r\n\r\n**Run:**\r\n```bash\r\nnpx vitest\r\n```\r\n\r\n### 2. Integration Testing with MCP Inspector\r\n\r\n```bash\r\nnpm run dev\r\n\r\nnpx @modelcontextprotocol/inspector\r\n\r\n\r\nThis skill prevents 10+ production issues documented in official MCP SDK and Cloudflare repos:\r\n\r\n### Issue #1: Export Syntax Issues (CRITICAL)\r\n**Error**: `\"Cannot read properties of undefined (reading 'map')\"`\r\n**Source**: honojs/hono#3955, honojs/vite-plugins#237\r\n**Why It Happens**: Incorrect export format with Vite build causes cryptic errors\r\n**Prevention**:\r\n```typescript\r\n// ❌ WRONG - Causes cryptic build errors\r\nexport default { fetch: app.fetch };\r\n\r\n// ✅ CORRECT - Direct export\r\nexport default app;\r\n```\r\n\r\n### Issue #2: Unclosed Transport Connections\r\n**Error**: Memory leaks, hanging connections\r\n**Source**: Best practice from SDK maintainers\r\n**Why It Happens**: Not closing StreamableHTTPServerTransport on request end\r\n**Prevention**:\r\n```typescript\r\napp.post('/mcp', async (c) => {\r\n  const transport = new StreamableHTTPServerTransport(/*...*/);\r\n\r\n  // CRITICAL: Always close on response end\r\n  c.res.raw.on('close', () => transport.close());\r\n\r\n  // ... handle request\r\n});\r\n```\r\n\r\n### Issue #3: Tool Schema Validation Failure\r\n**Error**: `ListTools request handler fails to generate inputSchema`\r\n**Source**: GitHub modelcontextprotocol/typescript-sdk#1028\r\n**Why It Happens**: Zod schemas not properly converted to JSON Schema\r\n**Prevention**:\r\n```typescript\r\n// ✅ CORRECT - SDK handles Zod schema conversion automatically\r\nserver.registerTool(\r\n  'tool-name',\r\n  {\r\n    inputSchema: z.object({ a: z.number() })\r\n  },\r\n  handler\r\n);\r\n\r\n// No need for manual zodToJsonSchema() unless custom validation\r\n```\r\n\r\n### Issue #4: Tool Arguments Not Passed to Handler\r\n**Error**: Handler receives `undefined` arguments\r\n**Source**: GitHub modelcontextprotocol/typescript-sdk#1026\r\n**Why It Happens**: Schema type mismatch between registration and invocation\r\n**Prevention**:\r\n```typescript\r\nconst schema = z.object({ a: z.number(), b: z.number() });\r\ntype Input = z.infer<typeof schema>;\r\n\r\nserver.registerTool(\r\n  'add',\r\n  { inputSchema: schema },\r\n  async (args: Input) => {\r\n    // args.a and args.b properly typed and passed\r\n    return { content: [{ type: 'text', text: String(args.a + args.b) }] };\r\n  }\r\n);\r\n```\r\n\r\n### Issue #5: CORS Misconfiguration\r\n**Error**: Browser clients can't connect to MCP server\r\n**Source**: Common production issue\r\n**Why It Happens**: Missing CORS headers for HTTP transport\r\n**Prevention**:\r\n```typescript\r\nimport { cors } from 'hono/cors';\r\n\r\napp.use('/mcp', cors({\r\n  origin: ['http://localhost:3000', 'https://your-app.com'],\r\n  allowMethods: ['POST', 'OPTIONS'],\r\n  allowHeaders: ['Content-Type', 'Authorization']\r\n}));\r\n```\r\n\r\n### Issue #6: Missing Rate Limiting\r\n**Error**: API abuse, DDoS vulnerability\r\n**Source**: Production security best practice\r\n**Why It Happens**: No rate limiting on MCP endpoints\r\n**Prevention**:\r\n```typescript\r\napp.post('/mcp', async (c) => {\r\n  const ip = c.req.header('CF-Connecting-IP');\r\n  const rateLimitKey = `ratelimit:${ip}`;\r\n\r\n  const count = await c.env.CACHE.get(rateLimitKey);\r\n  if (count && parseInt(count) > 100) {\r\n    return c.json({ error: 'Rate limit exceeded' }, 429);\r\n  }\r\n\r\n  await c.env.CACHE.put(\r\n    rateLimitKey,\r\n    String((parseInt(count || '0') + 1)),\r\n    { expirationTtl: 60 }\r\n  );\r\n\r\n  // Continue...\r\n});\r\n```\r\n\r\n### Issue #7: TypeScript Compilation Memory Issues\r\n**Error**: `Out of memory` during `tsc` build\r\n**Source**: GitHub modelcontextprotocol/typescript-sdk#985\r\n**Why It Happens**: Large dependency tree in MCP SDK\r\n**Prevention**:\r\n```bash\r\n\r\n### Local Development\r\n\r\n```bash\r\nnpm install\r\n\r\nnpm run dev\r\nwrangler dev\r\n\r\n```\r\n\r\n### Production Deployment\r\n\r\n```bash\r\nnpm run build\r\n\r\nwrangler deploy",
  "name": "typescript-mcp",
  "id": "typescript-mcp",
  "sections": {
    "Complete Setup Checklist": "Use this checklist to verify your MCP server setup:\r\n\r\n- [ ] SDK version is 1.20.2 or later\r\n- [ ] Export syntax is correct (direct export, not object wrapper)\r\n- [ ] Transport is closed on response end\r\n- [ ] Authentication is implemented (if production)\r\n- [ ] Rate limiting is configured (if public-facing)\r\n- [ ] CORS headers are set (if browser clients)\r\n- [ ] All tools have clear descriptions and Zod schemas\r\n- [ ] Environment variables are used for secrets\r\n- [ ] wrangler.jsonc includes all necessary bindings\r\n- [ ] Local testing with `wrangler dev` succeeds\r\n- [ ] MCP Inspector can connect and list tools\r\n- [ ] Production deployment succeeds\r\n- [ ] All tools/resources return expected responses\r\n\r\n---",
    "When to Use Cloudflare Agents SDK Instead": "Use **Cloudflare Agents MCP** when you need:\r\n- **Stateful agents** with persistent storage (SQLite up to 1GB)\r\n- **WebSocket support** for real-time bidirectional communication\r\n- **Long-running sessions** with conversation history\r\n- **Scheduled agent tasks** with Durable Objects alarms\r\n- **Global distribution** with automatic state replication\r\n\r\nUse **this skill (standalone TypeScript MCP)** when you need:\r\n- **Stateless tools** and API integrations\r\n- **Edge deployment** with minimal cold start latency\r\n- **Simple authentication** (API keys, OAuth)\r\n- **Pay-per-request pricing** (no Durable Objects overhead)\r\n- **Maximum portability** (works on any platform, not just Cloudflare)\r\n\r\nSee `references/cloudflare-agents-vs-standalone.md` for detailed comparison.\r\n\r\n---",
    "Known Issues Prevention": "\"build\": \"NODE_OPTIONS='--max-old-space-size=4096' tsc && vite build\"\r\n```\r\n\r\n### Issue #8: UriTemplate ReDoS Vulnerability\r\n**Error**: Server hangs on malicious URI patterns\r\n**Source**: GitHub modelcontextprotocol/typescript-sdk#965 (Security)\r\n**Why It Happens**: Regex denial-of-service in URI template parsing\r\n**Prevention**: Update to SDK v1.20.2 or later (includes fix)\r\n\r\n### Issue #9: Authentication Bypass\r\n**Error**: Unauthenticated access to MCP tools\r\n**Source**: Production security best practice\r\n**Why It Happens**: Missing or improperly implemented authentication\r\n**Prevention**: Always implement authentication for production servers (see Authentication Patterns section)\r\n\r\n### Issue #10: Environment Variable Leakage\r\n**Error**: Secrets exposed in error messages or logs\r\n**Source**: Cloudflare Workers security best practice\r\n**Why It Happens**: Environment variables logged or returned in responses\r\n**Prevention**:\r\n```typescript\r\n// ❌ WRONG - Exposes secrets\r\nconsole.log('Env:', JSON.stringify(env));\r\n\r\n// ✅ CORRECT - Never log env objects\r\ntry {\r\n  // ... use env.SECRET_KEY\r\n} catch (error) {\r\n  // Don't include env in error context\r\n  console.error('Operation failed:', error.message);\r\n}\r\n```\r\n\r\n---",
    "Testing Strategies": "```\r\n\r\n### 3. E2E Testing with Claude Agent SDK\r\n\r\nSee `references/testing-guide.md` for comprehensive testing patterns.\r\n\r\n---",
    "Core Concepts": "### MCP Protocol Components\r\n\r\n**1. Tools** - Functions LLMs can invoke\r\n- Input/output schemas defined with Zod\r\n- Async handlers return structured content\r\n- Can call external APIs, databases, or computations\r\n\r\n**2. Resources** - Static or dynamic data exposure\r\n- URI-based addressing (e.g., `config://app/settings`)\r\n- Templates support parameters (e.g., `user://{userId}`)\r\n- Return text, JSON, or binary data\r\n\r\n**3. Prompts** - Pre-configured prompt templates\r\n- Provide reusable conversation starters\r\n- Can include placeholders and dynamic content\r\n- Help standardize LLM interactions\r\n\r\n**4. Completions** (Optional) - Argument auto-complete\r\n- Suggest valid values for tool arguments\r\n- Improve developer experience\r\n\r\n---",
    "When to Use This Skill": "Use this skill when:\r\n- Building **MCP servers** to expose APIs, tools, or data to LLMs\r\n- Deploying **serverless MCP endpoints** on Cloudflare Workers\r\n- Integrating **external APIs** as MCP tools (REST, GraphQL, databases)\r\n- Creating **stateless MCP servers** for edge deployment\r\n- Exposing **Cloudflare services** (D1, KV, R2, Vectorize) via MCP protocol\r\n- Implementing **authenticated MCP servers** with API keys, OAuth, or Zero Trust\r\n- Building **multi-tool MCP servers** with resources and prompts\r\n- Needing **production-ready templates** that prevent common MCP errors\r\n\r\n**Do NOT use this skill when**:\r\n- Building **Python MCP servers** (use FastMCP skill instead)\r\n- Needing **stateful agents** with WebSockets (use Cloudflare Agents SDK)\r\n- Wanting **long-running persistent agents** with SQLite storage (use Durable Objects)\r\n- Building **local CLI tools** (use stdio transport, not HTTP)\r\n\r\n---",
    "Cloudflare Service Integration": "### D1 Database Tool Example\r\n\r\n```typescript\r\nserver.registerTool(\r\n  'query-database',\r\n  {\r\n    description: 'Executes SQL query on D1 database',\r\n    inputSchema: z.object({\r\n      query: z.string(),\r\n      params: z.array(z.union([z.string(), z.number()])).optional()\r\n    })\r\n  },\r\n  async ({ query, params }, env) => {\r\n    const result = await env.DB.prepare(query).bind(...(params || [])).all();\r\n\r\n    return {\r\n      content: [{\r\n        type: 'text',\r\n        text: JSON.stringify(result.results, null, 2)\r\n      }]\r\n    };\r\n  }\r\n);\r\n```\r\n\r\n**Wrangler config:**\r\n```jsonc\r\n{\r\n  \"d1_databases\": [\r\n    { \"binding\": \"DB\", \"database_name\": \"my-db\", \"database_id\": \"...\" }\r\n  ]\r\n}\r\n```\r\n\r\n### KV Storage Tool Example\r\n\r\n```typescript\r\nserver.registerTool(\r\n  'get-cache',\r\n  {\r\n    description: 'Retrieves cached value by key',\r\n    inputSchema: z.object({ key: z.string() })\r\n  },\r\n  async ({ key }, env) => {\r\n    const value = await env.CACHE.get(key);\r\n    return {\r\n      content: [{ type: 'text', text: value || 'Key not found' }]\r\n    };\r\n  }\r\n);\r\n```\r\n\r\n### R2 Object Storage Tool Example\r\n\r\n```typescript\r\nserver.registerTool(\r\n  'upload-file',\r\n  {\r\n    description: 'Uploads file to R2 bucket',\r\n    inputSchema: z.object({\r\n      key: z.string(),\r\n      content: z.string(),\r\n      contentType: z.string().optional()\r\n    })\r\n  },\r\n  async ({ key, content, contentType }, env) => {\r\n    await env.BUCKET.put(key, content, {\r\n      httpMetadata: { contentType: contentType || 'text/plain' }\r\n    });\r\n\r\n    return {\r\n      content: [{ type: 'text', text: `File uploaded: ${key}` }]\r\n    };\r\n  }\r\n);\r\n```\r\n\r\n### Vectorize Search Tool Example\r\n\r\n```typescript\r\nserver.registerTool(\r\n  'semantic-search',\r\n  {\r\n    description: 'Searches vector database',\r\n    inputSchema: z.object({\r\n      query: z.string(),\r\n      topK: z.number().default(5)\r\n    })\r\n  },\r\n  async ({ query, topK }, env) => {\r\n    const embedding = await env.AI.run('@cf/baai/bge-base-en-v1.5', {\r\n      text: query\r\n    });\r\n\r\n    const results = await env.VECTORIZE.query(embedding.data[0], {\r\n      topK,\r\n      returnMetadata: true\r\n    });\r\n\r\n    return {\r\n      content: [{\r\n        type: 'text',\r\n        text: JSON.stringify(results.matches, null, 2)\r\n      }]\r\n    };\r\n  }\r\n);\r\n```\r\n\r\n---",
    "Critical Rules": "### Always Do\r\n\r\n✅ Close transport on response end to prevent memory leaks\r\n✅ Use direct export syntax (`export default app`) not object wrapper\r\n✅ Implement authentication for production servers\r\n✅ Add rate limiting to prevent API abuse\r\n✅ Use Zod schemas for type-safe tool definitions\r\n✅ Test with MCP Inspector before deploying to production\r\n✅ Update to SDK v1.20.2+ for security fixes\r\n✅ Document all tools with clear descriptions\r\n✅ Handle errors gracefully and return meaningful messages\r\n✅ Use environment variables for secrets (never hardcode)\r\n\r\n### Never Do\r\n\r\n❌ Export with object wrapper (`export default { fetch: app.fetch }`)\r\n❌ Forget to close StreamableHTTPServerTransport\r\n❌ Deploy without authentication in production\r\n❌ Log environment variables or secrets\r\n❌ Use CommonJS format (must use ES modules)\r\n❌ Skip CORS configuration for browser clients\r\n❌ Hardcode API keys or credentials\r\n❌ Return raw error objects (may leak sensitive data)\r\n❌ Deploy without testing tools/resources locally\r\n❌ Use outdated SDK versions with known vulnerabilities\r\n\r\n---",
    "Deployment Workflow": "wrangler deploy --env production\r\n```\r\n\r\n### CI/CD with GitHub Actions\r\n\r\n```yaml\r\nname: Deploy MCP Server\r\non:\r\n  push:\r\n    branches: [main]\r\n\r\njobs:\r\n  deploy:\r\n    runs-on: ubuntu-latest\r\n    steps:\r\n      - uses: actions/checkout@v4\r\n      - uses: actions/setup-node@v4\r\n        with:\r\n          node-version: '20'\r\n\r\n      - run: npm ci\r\n      - run: npm test\r\n\r\n      - name: Deploy to Cloudflare Workers\r\n        uses: cloudflare/wrangler-action@v3\r\n        with:\r\n          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}\r\n          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}\r\n```\r\n\r\n---",
    "Production Example": "This skill is based on patterns from:\r\n- **Official MCP TypeScript SDK examples**: https://github.com/modelcontextprotocol/servers\r\n- **Cloudflare MCP server**: https://github.com/cloudflare/mcp-server-cloudflare\r\n- **Errors**: 0 (all 10+ known issues prevented)\r\n- **Token Savings**: ~70% vs manual implementation\r\n- **Validation**: ✅ All templates tested on Cloudflare Workers\r\n\r\n---\r\n\r\n**Questions? Issues?**\r\n\r\n1. Check `references/common-errors.md` for troubleshooting\r\n2. Verify all steps in the Quick Start section\r\n3. Test with MCP Inspector: `npx @modelcontextprotocol/inspector`\r\n4. Check official docs: https://spec.modelcontextprotocol.io/\r\n5. Ensure SDK version is 1.20.2 or later\r\n\r\n---\r\n\r\n**Last Updated**: 2025-10-28\r\n**SDK Version**: @modelcontextprotocol/sdk@1.20.2\r\n**Maintainer**: Claude Skills Repository",
    "Official Documentation": "- **MCP Specification**: https://spec.modelcontextprotocol.io/\r\n- **TypeScript SDK**: https://github.com/modelcontextprotocol/typescript-sdk\r\n- **Cloudflare Workers**: https://developers.cloudflare.com/workers/\r\n- **Hono Framework**: https://hono.dev/\r\n- **Context7 Library ID**: `/websites/modelcontextprotocol` (if available)\r\n\r\n**Example Servers**:\r\n- Official examples: https://github.com/modelcontextprotocol/servers\r\n- Cloudflare MCP server: https://github.com/cloudflare/mcp-server-cloudflare\r\n\r\n---",
    "Using Bundled Resources": "### Templates (templates/)\r\n\r\nAll templates are production-ready and tested on Cloudflare Workers:\r\n\r\n- `templates/basic-mcp-server.ts` - Minimal working server (echo tool example)\r\n- `templates/tool-server.ts` - Multiple tools implementation (API integrations, calculations)\r\n- `templates/resource-server.ts` - Resource-only server (static and dynamic resources)\r\n- `templates/full-server.ts` - Complete server (tools + resources + prompts)\r\n- `templates/authenticated-server.ts` - Production server with API key authentication\r\n- `templates/wrangler.jsonc` - Cloudflare Workers configuration with all bindings\r\n\r\n**When Claude should use these**: When creating a new MCP server, copy the appropriate template based on the use case (tools-only, resources-only, authenticated, or full-featured).\r\n\r\n### Reference Guides (references/)\r\n\r\nComprehensive documentation for advanced topics:\r\n\r\n- `references/tool-patterns.md` - Common tool implementation patterns (API wrappers, database queries, calculations, file operations)\r\n- `references/authentication-guide.md` - All authentication methods detailed (API keys, OAuth 2.0, Zero Trust, JWT)\r\n- `references/testing-guide.md` - Unit testing, integration testing with MCP Inspector, E2E testing with Claude Agent SDK\r\n- `references/deployment-guide.md` - Wrangler workflows, environment management, CI/CD with GitHub Actions\r\n- `references/cloudflare-integration.md` - Using D1, KV, R2, Vectorize, Workers AI, Queues, Durable Objects\r\n- `references/common-errors.md` - All 10+ errors with detailed solutions, root causes, and prevention strategies\r\n- `references/cloudflare-agents-vs-standalone.md` - Decision matrix for choosing between standalone MCP and Cloudflare Agents SDK\r\n\r\n**When Claude should load these**: When developer needs advanced implementation details, debugging help, or architectural guidance.\r\n\r\n### Scripts (scripts/)\r\n\r\nAutomation scripts for initializing and testing MCP servers:\r\n\r\n- `scripts/init-mcp-server.sh` - Initializes new MCP server project with dependencies, wrangler config, and template selection\r\n- `scripts/test-mcp-connection.sh` - Tests MCP server connectivity and validates tool/resource endpoints\r\n\r\n**When Claude should use these**: When setting up a new project or debugging connectivity issues.\r\n\r\n---",
    "Authentication Patterns": "wrangler kv key delete --binding=MCP_API_KEYS \"key:abc123\"\r\n```\r\n\r\n### Pattern 2: Cloudflare Zero Trust Access\r\n\r\n```typescript\r\nimport { verifyJWT } from '@cloudflare/workers-jwt';\r\n\r\nconst jwt = c.req.header('Cf-Access-Jwt-Assertion');\r\nif (!jwt) {\r\n  return c.json({ error: 'Access denied' }, 403);\r\n}\r\n\r\nconst payload = await verifyJWT(jwt, c.env.CF_ACCESS_TEAM_DOMAIN);\r\n// User authenticated via Cloudflare Access\r\n```\r\n\r\n### Pattern 3: OAuth 2.0\r\n\r\nSee `references/authentication-guide.md` for complete OAuth implementation.\r\n\r\n---",
    "Package Versions (Verified 2025-10-28)": "```json\r\n{\r\n  \"dependencies\": {\r\n    \"@modelcontextprotocol/sdk\": \"^1.20.2\",\r\n    \"@cloudflare/workers-types\": \"^4.20251011.0\",\r\n    \"hono\": \"^4.10.1\",\r\n    \"zod\": \"^3.23.8\",\r\n    \"zod-to-json-schema\": \"^3.24.1\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@cloudflare/vitest-pool-workers\": \"^0.5.29\",\r\n    \"vitest\": \"^3.0.0\",\r\n    \"wrangler\": \"^4.43.0\",\r\n    \"typescript\": \"^5.7.0\"\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Quick Start": "### 1. Basic MCP Server Template\r\n\r\nUse the `basic-mcp-server.ts` template for a minimal working server:\r\n\r\n```typescript\r\n// See templates/basic-mcp-server.ts\r\nimport { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';\r\nimport { StreamableHTTPServerTransport } from '@modelcontextprotocol/sdk/server/streamableHttp.js';\r\nimport { Hono } from 'hono';\r\nimport { z } from 'zod';\r\n\r\nconst server = new McpServer({\r\n  name: 'my-mcp-server',\r\n  version: '1.0.0'\r\n});\r\n\r\n// Register a simple tool\r\nserver.registerTool(\r\n  'echo',\r\n  {\r\n    description: 'Echoes back the input text',\r\n    inputSchema: z.object({\r\n      text: z.string().describe('Text to echo back')\r\n    })\r\n  },\r\n  async ({ text }) => ({\r\n    content: [{ type: 'text', text }]\r\n  })\r\n);\r\n\r\n// HTTP endpoint setup\r\nconst app = new Hono();\r\n\r\napp.post('/mcp', async (c) => {\r\n  const transport = new StreamableHTTPServerTransport({\r\n    sessionIdGenerator: undefined,\r\n    enableJsonResponse: true\r\n  });\r\n\r\n  // CRITICAL: Close transport on response end to prevent memory leaks\r\n  c.res.raw.on('close', () => transport.close());\r\n\r\n  await server.connect(transport);\r\n  await transport.handleRequest(c.req.raw, c.res.raw, await c.req.json());\r\n\r\n  return c.body(null);\r\n});\r\n\r\nexport default app;\r\n```\r\n\r\n**Install dependencies:**\r\n```bash\r\nnpm install @modelcontextprotocol/sdk hono zod\r\nnpm install -D @cloudflare/workers-types wrangler typescript\r\n```\r\n\r\n**Deploy:**\r\n```bash\r\nwrangler deploy\r\n```\r\n\r\n---\r\n\r\n### 2. Tool-Server Template\r\n\r\nUse `tool-server.ts` for exposing multiple tools (API integrations, calculations):\r\n\r\n```typescript\r\n// Example: Weather API tool\r\nserver.registerTool(\r\n  'get-weather',\r\n  {\r\n    description: 'Fetches current weather for a city',\r\n    inputSchema: z.object({\r\n      city: z.string().describe('City name'),\r\n      units: z.enum(['metric', 'imperial']).default('metric')\r\n    })\r\n  },\r\n  async ({ city, units }, env) => {\r\n    const response = await fetch(\r\n      `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=${units}&appid=${env.WEATHER_API_KEY}`\r\n    );\r\n    const data = await response.json();\r\n\r\n    return {\r\n      content: [{\r\n        type: 'text',\r\n        text: `Temperature in ${city}: ${data.main.temp}°${units === 'metric' ? 'C' : 'F'}`\r\n      }]\r\n    };\r\n  }\r\n);\r\n```\r\n\r\n---\r\n\r\n### 3. Resource-Server Template\r\n\r\nUse `resource-server.ts` for exposing data:\r\n\r\n```typescript\r\nimport { ResourceTemplate } from '@modelcontextprotocol/sdk/types.js';\r\n\r\n// Static resource\r\nserver.registerResource(\r\n  'config',\r\n  new ResourceTemplate('config://app', { list: undefined }),\r\n  { description: 'Application configuration' },\r\n  async (uri) => ({\r\n    contents: [{\r\n      uri: uri.href,\r\n      mimeType: 'application/json',\r\n      text: JSON.stringify({ version: '1.0.0', features: ['tool1', 'tool2'] })\r\n    }]\r\n  })\r\n);\r\n\r\n// Dynamic resource with parameter\r\nserver.registerResource(\r\n  'user-profile',\r\n  new ResourceTemplate('user://{userId}', { list: undefined }),\r\n  { description: 'User profile data' },\r\n  async (uri, { userId }, env) => {\r\n    const user = await env.DB.prepare('SELECT * FROM users WHERE id = ?').bind(userId).first();\r\n\r\n    return {\r\n      contents: [{\r\n        uri: uri.href,\r\n        mimeType: 'application/json',\r\n        text: JSON.stringify(user)\r\n      }]\r\n    };\r\n  }\r\n);\r\n```\r\n\r\n---\r\n\r\n### 4. Authenticated Server Template\r\n\r\nUse `authenticated-server.ts` for production security:\r\n\r\n```typescript\r\nimport { Hono } from 'hono';\r\n\r\nconst app = new Hono();\r\n\r\n// API Key authentication middleware\r\napp.use('/mcp', async (c, next) => {\r\n  const authHeader = c.req.header('Authorization');\r\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n    return c.json({ error: 'Unauthorized' }, 401);\r\n  }\r\n\r\n  const apiKey = authHeader.replace('Bearer ', '');\r\n  const isValid = await c.env.MCP_API_KEYS.get(`key:${apiKey}`);\r\n\r\n  if (!isValid) {\r\n    return c.json({ error: 'Invalid API key' }, 403);\r\n  }\r\n\r\n  await next();\r\n});\r\n\r\napp.post('/mcp', async (c) => {\r\n  // MCP server logic (user is authenticated)\r\n  // ... transport setup and handling\r\n});\r\n```\r\n\r\n---"
  }
}
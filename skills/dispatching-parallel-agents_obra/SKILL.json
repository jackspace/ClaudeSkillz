{
  "sections": {
    "Agent Prompt Structure": "Good agent prompts are:\r\n1. **Focused** - One clear problem domain\r\n2. **Self-contained** - All context needed to understand the problem\r\n3. **Specific about output** - What should the agent return?\r\n\r\n```markdown\r\nFix the 3 failing tests in src/agents/agent-tool-abort.test.ts:\r\n\r\n1. \"should abort tool with partial output capture\" - expects 'interrupted at' in message\r\n2. \"should handle mixed completed and aborted tools\" - fast tool aborted instead of completed\r\n3. \"should properly track pendingToolCount\" - expects 3 results but gets 0\r\n\r\nThese are timing/race condition issues. Your task:\r\n\r\n1. Read the test file and understand what each test verifies\r\n2. Identify root cause - timing issues or actual bugs?\r\n3. Fix by:\r\n   - Replacing arbitrary timeouts with event-based waiting\r\n   - Fixing bugs in abort implementation if found\r\n   - Adjusting test expectations if testing changed behavior\r\n\r\nDo NOT just increase timeouts - find the real issue.\r\n\r\nReturn: Summary of what you found and what you fixed.\r\n```",
    "Real Example from Session": "**Scenario:** 6 test failures across 3 files after major refactoring\r\n\r\n**Failures:**\r\n- agent-tool-abort.test.ts: 3 failures (timing issues)\r\n- batch-completion-behavior.test.ts: 2 failures (tools not executing)\r\n- tool-approval-race-conditions.test.ts: 1 failure (execution count = 0)\r\n\r\n**Decision:** Independent domains - abort logic separate from batch completion separate from race conditions\r\n\r\n**Dispatch:**\r\n```\r\nAgent 1 → Fix agent-tool-abort.test.ts\r\nAgent 2 → Fix batch-completion-behavior.test.ts\r\nAgent 3 → Fix tool-approval-race-conditions.test.ts\r\n```\r\n\r\n**Results:**\r\n- Agent 1: Replaced timeouts with event-based waiting\r\n- Agent 2: Fixed event structure bug (threadId in wrong place)\r\n- Agent 3: Added wait for async tool execution to complete\r\n\r\n**Integration:** All fixes independent, no conflicts, full suite green\r\n\r\n**Time saved:** 3 problems solved in parallel vs sequentially",
    "When to Use": "```dot\r\ndigraph when_to_use {\r\n    \"Multiple failures?\" [shape=diamond];\r\n    \"Are they independent?\" [shape=diamond];\r\n    \"Single agent investigates all\" [shape=box];\r\n    \"One agent per problem domain\" [shape=box];\r\n    \"Can they work in parallel?\" [shape=diamond];\r\n    \"Sequential agents\" [shape=box];\r\n    \"Parallel dispatch\" [shape=box];\r\n\r\n    \"Multiple failures?\" -> \"Are they independent?\" [label=\"yes\"];\r\n    \"Are they independent?\" -> \"Single agent investigates all\" [label=\"no - related\"];\r\n    \"Are they independent?\" -> \"Can they work in parallel?\" [label=\"yes\"];\r\n    \"Can they work in parallel?\" -> \"Parallel dispatch\" [label=\"yes\"];\r\n    \"Can they work in parallel?\" -> \"Sequential agents\" [label=\"no - shared state\"];\r\n}\r\n```\r\n\r\n**Use when:**\r\n- 3+ test files failing with different root causes\r\n- Multiple subsystems broken independently\r\n- Each problem can be understood without context from others\r\n- No shared state between investigations\r\n\r\n**Don't use when:**\r\n- Failures are related (fix one might fix others)\r\n- Need to understand full system state\r\n- Agents would interfere with each other",
    "Common Mistakes": "**❌ Too broad:** \"Fix all the tests\" - agent gets lost\r\n**✅ Specific:** \"Fix agent-tool-abort.test.ts\" - focused scope\r\n\r\n**❌ No context:** \"Fix the race condition\" - agent doesn't know where\r\n**✅ Context:** Paste the error messages and test names\r\n\r\n**❌ No constraints:** Agent might refactor everything\r\n**✅ Constraints:** \"Do NOT change production code\" or \"Fix tests only\"\r\n\r\n**❌ Vague output:** \"Fix it\" - you don't know what changed\r\n**✅ Specific:** \"Return summary of root cause and changes\"",
    "The Pattern": "### 1. Identify Independent Domains\r\n\r\nGroup failures by what's broken:\r\n- File A tests: Tool approval flow\r\n- File B tests: Batch completion behavior\r\n- File C tests: Abort functionality\r\n\r\nEach domain is independent - fixing tool approval doesn't affect abort tests.\r\n\r\n### 2. Create Focused Agent Tasks\r\n\r\nEach agent gets:\r\n- **Specific scope:** One test file or subsystem\r\n- **Clear goal:** Make these tests pass\r\n- **Constraints:** Don't change other code\r\n- **Expected output:** Summary of what you found and fixed\r\n\r\n### 3. Dispatch in Parallel\r\n\r\n```typescript\r\n// In Claude Code / AI environment\r\nTask(\"Fix agent-tool-abort.test.ts failures\")\r\nTask(\"Fix batch-completion-behavior.test.ts failures\")\r\nTask(\"Fix tool-approval-race-conditions.test.ts failures\")\r\n// All three run concurrently\r\n```\r\n\r\n### 4. Review and Integrate\r\n\r\nWhen agents return:\r\n- Read each summary\r\n- Verify fixes don't conflict\r\n- Run full test suite\r\n- Integrate all changes",
    "Overview": "When you have multiple unrelated failures (different test files, different subsystems, different bugs), investigating them sequentially wastes time. Each investigation is independent and can happen in parallel.\r\n\r\n**Core principle:** Dispatch one agent per independent problem domain. Let them work concurrently.",
    "When NOT to Use": "**Related failures:** Fixing one might fix others - investigate together first\r\n**Need full context:** Understanding requires seeing entire system\r\n**Exploratory debugging:** You don't know what's broken yet\r\n**Shared state:** Agents would interfere (editing same files, using same resources)",
    "Verification": "After agents return:\r\n1. **Review each summary** - Understand what changed\r\n2. **Check for conflicts** - Did agents edit same code?\r\n3. **Run full suite** - Verify all fixes work together\r\n4. **Spot check** - Agents can make systematic errors",
    "Key Benefits": "1. **Parallelization** - Multiple investigations happen simultaneously\r\n2. **Focus** - Each agent has narrow scope, less context to track\r\n3. **Independence** - Agents don't interfere with each other\r\n4. **Speed** - 3 problems solved in time of 1",
    "Real-World Impact": "From debugging session (2025-10-03):\r\n- 6 failures across 3 files\r\n- 3 agents dispatched in parallel\r\n- All investigations completed concurrently\r\n- All fixes integrated successfully\r\n- Zero conflicts between agent changes"
  },
  "id": "dispatching-parallel-agents_obra",
  "name": "dispatching-parallel-agents",
  "description": "Use when facing 3+ independent failures that can be investigated without shared state or dependencies - dispatches multiple Claude agents to investigate and fix independent problems concurrently"
}
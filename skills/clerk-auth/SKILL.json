{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/common-errors.md",
      "references/example-reference.md",
      "references/jwt-claims-guide.md",
      "references/testing-guide.md"
    ]
  },
  "content": "**Status**: Production Ready ✅\r\n**Last Updated**: 2025-10-28\r\n**Dependencies**: None\r\n**Latest Versions**: @clerk/nextjs@6.33.3, @clerk/backend@2.17.2, @clerk/clerk-react@5.51.0, @clerk/testing@1.4.4\r\n\r\n---\r\n\r\n\r\n### 1. Install Clerk\r\n\r\n\\`\\`\\`bash\r\nnpm install @clerk/nextjs\r\n\\`\\`\\`\r\n\r\n**Latest Version**: @clerk/nextjs@6.33.3 (verified 2025-10-22)\r\n- **New in v6**: Async auth() helper, Next.js 15 support, static rendering by default\r\n- Source: https://clerk.com/changelog/2024-10-22-clerk-nextjs-v6\r\n\r\n### 2. Configure Environment Variables\r\n\r\nCreate \\`.env.local\\`:\r\n\r\n\\`\\`\\`bash\r\nNEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...\r\nCLERK_SECRET_KEY=sk_test_...\r\n\r\n\r\nClerk provides comprehensive testing tools for local development and CI/CD pipelines.\r\n\r\n### Quick Start: Test Credentials\r\n\r\n**Test Emails** (no emails sent, fixed OTP):\r\n```\r\njohn+clerk_test@example.com\r\njane+clerk_test@gmail.com\r\n```\r\n\r\n**Test Phone Numbers** (no SMS sent, fixed OTP):\r\n```\r\n+12015550100\r\n+19735550133\r\n```\r\n\r\n**Fixed OTP Code**: `424242` (works for all test credentials)\r\n\r\n### Generate Session Tokens\r\n\r\nFor testing API endpoints, generate valid session tokens (60-second lifetime):\r\n\r\n```bash\r\nCLERK_SECRET_KEY=sk_test_... node scripts/generate-session-token.js\r\n\r\nCLERK_SECRET_KEY=sk_test_... node scripts/generate-session-token.js --create-user",
  "name": "clerk-auth",
  "id": "clerk-auth",
  "sections": {
    "Quick Start (10 Minutes)": "Choose your framework:\r\n- [React (Vite)](#react-vite-setup) - ClerkProvider + hooks\r\n- [Next.js App Router](#nextjs-app-router-setup) - Middleware + async auth()\r\n- [Cloudflare Workers](#cloudflare-workers-setup) - Backend verification\r\n\r\n---",
    "Official Documentation": "- **Clerk Docs**: https://clerk.com/docs\r\n- **Next.js Guide**: https://clerk.com/docs/references/nextjs/overview\r\n- **React Guide**: https://clerk.com/docs/references/react/overview\r\n- **Backend SDK**: https://clerk.com/docs/reference/backend/overview\r\n- **JWT Templates**: https://clerk.com/docs/guides/sessions/jwt-templates\r\n- **shadcn/ui Integration**: https://clerk.com/docs/guides/development/shadcn-cli\r\n- **Context7 Library ID**: \\`/clerk/clerk-docs\\`\r\n\r\n---",
    "Next.js App Router Setup": "NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in\r\nNEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up\r\nNEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard\r\nNEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/onboarding\r\n\\`\\`\\`\r\n\r\n**CRITICAL**:\r\n- \\`CLERK_SECRET_KEY\\` must NEVER be exposed to client\r\n- Use \\`NEXT_PUBLIC_\\` prefix for client-side vars only\r\n- Source: https://clerk.com/docs/guides/development/clerk-environment-variables\r\n\r\n### 3. Add Middleware for Route Protection\r\n\r\nCreate \\`middleware.ts\\` in project root:\r\n\r\n\\`\\`\\`typescript\r\nimport { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'\r\n\r\n// Define which routes are public (everything else requires auth)\r\nconst isPublicRoute = createRouteMatcher([\r\n  '/',\r\n  '/sign-in(.*)',\r\n  '/sign-up(.*)',\r\n  '/api/webhooks(.*)', // Clerk webhooks should be public\r\n])\r\n\r\nexport default clerkMiddleware(async (auth, request) => {\r\n  // Protect all routes except public ones\r\n  if (!isPublicRoute(request)) {\r\n    await auth.protect()\r\n  }\r\n})\r\n\r\nexport const config = {\r\n  matcher: [\r\n    // Skip Next.js internals and static files\r\n    '/((?!_next|[^?]*\\\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',\r\n    // Always run for API routes\r\n    '/(api|trpc)(.*)',\r\n  ],\r\n}\r\n\\`\\`\\`\r\n\r\n**CRITICAL**:\r\n- \\`auth.protect()\\` is async in v6 (breaking change from v5)\r\n- \\`createRouteMatcher()\\` accepts glob patterns\r\n- Alternative: protect specific routes instead of inverting logic\r\n- Source: https://clerk.com/docs/reference/nextjs/clerk-middleware\r\n\r\n### 4. Wrap App with ClerkProvider\r\n\r\nUpdate \\`app/layout.tsx\\`:\r\n\r\n\\`\\`\\`typescript\r\nimport { ClerkProvider } from '@clerk/nextjs'\r\nimport './globals.css'\r\n\r\nexport default function RootLayout({\r\n  children,\r\n}: {\r\n  children: React.ReactNode\r\n}) {\r\n  return (\r\n    <ClerkProvider>\r\n      <html lang=\"en\">\r\n        <body>{children}</body>\r\n      </html>\r\n    </ClerkProvider>\r\n  )\r\n}\r\n\\`\\`\\`\r\n\r\n### 5. Use auth() in Server Components\r\n\r\n\\`\\`\\`typescript\r\nimport { auth, currentUser } from '@clerk/nextjs/server'\r\n\r\nexport default async function DashboardPage() {\r\n  // Get auth state (lightweight)\r\n  const { userId, sessionId } = await auth()\r\n\r\n  // Get full user object (heavier, fewer calls)\r\n  const user = await currentUser()\r\n\r\n  if (!userId) {\r\n    return <div>Unauthorized</div>\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <h1>Dashboard</h1>\r\n      <p>User ID: {userId}</p>\r\n      <p>Email: {user?.primaryEmailAddress?.emailAddress}</p>\r\n    </div>\r\n  )\r\n}\r\n\\`\\`\\`\r\n\r\n**CRITICAL**:\r\n- \\`auth()\\` is async in v6 (breaking change)\r\n- Use \\`auth()\\` for lightweight checks\r\n- Use \\`currentUser()\\` when you need full user object\r\n\r\n---",
    "React (Vite) Setup": "### 1. Install Clerk\r\n\r\n\\`\\`\\`bash\r\nnpm install @clerk/clerk-react\r\n\\`\\`\\`\r\n\r\n**Latest Version**: @clerk/clerk-react@5.51.0 (verified 2025-10-22)\r\n\r\n### 2. Configure ClerkProvider\r\n\r\nUpdate \\`src/main.tsx\\`:\r\n\r\n\\`\\`\\`typescript\r\nimport React from 'react'\r\nimport ReactDOM from 'react-dom/client'\r\nimport { ClerkProvider } from '@clerk/clerk-react'\r\nimport App from './App.tsx'\r\nimport './index.css'\r\n\r\n// Get publishable key from environment\r\nconst PUBLISHABLE_KEY = import.meta.env.VITE_CLERK_PUBLISHABLE_KEY\r\n\r\nif (!PUBLISHABLE_KEY) {\r\n  throw new Error('Missing Publishable Key')\r\n}\r\n\r\nReactDOM.createRoot(document.getElementById('root')!).render(\r\n  <React.StrictMode>\r\n    <ClerkProvider publishableKey={PUBLISHABLE_KEY}>\r\n      <App />\r\n    </ClerkProvider>\r\n  </React.StrictMode>,\r\n)\r\n\\`\\`\\`\r\n\r\n**CRITICAL**:\r\n- Use \\`VITE_\\` prefix for environment variables in Vite\r\n- ClerkProvider must wrap your entire app\r\n- Source: https://clerk.com/docs/references/react/clerk-provider\r\n\r\n### 3. Add Environment Variables\r\n\r\nCreate \\`.env.local\\`:\r\n\r\n\\`\\`\\`bash\r\nVITE_CLERK_PUBLISHABLE_KEY=pk_test_...\r\n\\`\\`\\`\r\n\r\n**Security Note**: Only \\`VITE_\\` prefixed vars are exposed to client code.\r\n\r\n### 4. Use Authentication Hooks\r\n\r\n\\`\\`\\`typescript\r\nimport { useUser, useAuth, useClerk } from '@clerk/clerk-react'\r\n\r\nfunction App() {\r\n  // Get user object (includes email, metadata, etc.)\r\n  const { isLoaded, isSignedIn, user } = useUser()\r\n\r\n  // Get auth state and session methods\r\n  const { userId, sessionId, getToken } = useAuth()\r\n\r\n  // Get Clerk instance for advanced operations\r\n  const { openSignIn, signOut } = useClerk()\r\n\r\n  // Always check isLoaded before rendering auth-dependent UI\r\n  if (!isLoaded) {\r\n    return <div>Loading...</div>\r\n  }\r\n\r\n  if (!isSignedIn) {\r\n    return <button onClick={() => openSignIn()}>Sign In</button>\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <h1>Welcome {user.firstName}!</h1>\r\n      <p>Email: {user.primaryEmailAddress?.emailAddress}</p>\r\n      <button onClick={() => signOut()}>Sign Out</button>\r\n    </div>\r\n  )\r\n}\r\n\\`\\`\\`\r\n\r\n**Why This Matters**:\r\n- \\`isLoaded\\` prevents flash of wrong content\r\n- \\`useUser()\\` provides full user object with metadata\r\n- \\`useAuth()\\` provides session tokens and auth state\r\n- Source: https://clerk.com/docs/references/react/use-user\r\n\r\n---",
    "JWT Templates & Custom Claims": "Clerk allows customizing JWT (JSON Web Token) structure using templates. This enables integration with third-party services, role-based access control, and multi-tenant applications.\r\n\r\n### Quick Start: Create a JWT Template\r\n\r\n**1. Navigate to Clerk Dashboard**:\r\n- Go to **Sessions** page\r\n- Click **Customize session token**\r\n- Click **Create template**\r\n\r\n**2. Define Template**:\r\n```json\r\n{\r\n  \"user_id\": \"{{user.id}}\",\r\n  \"email\": \"{{user.primary_email_address}}\",\r\n  \"role\": \"{{user.public_metadata.role || 'user'}}\"\r\n}\r\n```\r\n\r\n**3. Use Template in Code**:\r\n```typescript\r\n// Frontend (React/Next.js)\r\nconst { getToken } = useAuth()\r\nconst token = await getToken({ template: 'my-template' })\r\n\r\n// Backend (Cloudflare Workers)\r\nconst sessionClaims = c.get('sessionClaims')\r\nconst role = sessionClaims?.role\r\n```\r\n\r\n### Available Shortcodes\r\n\r\n| Category | Shortcodes | Example |\r\n|----------|-----------|---------|\r\n| **User ID & Name** | `{{user.id}}`, `{{user.first_name}}`, `{{user.last_name}}`, `{{user.full_name}}` | `\"John Doe\"` |\r\n| **Contact** | `{{user.primary_email_address}}`, `{{user.primary_phone_address}}` | `\"john@example.com\"` |\r\n| **Profile** | `{{user.image_url}}`, `{{user.username}}`, `{{user.created_at}}` | `\"https://...\"` |\r\n| **Verification** | `{{user.email_verified}}`, `{{user.phone_number_verified}}` | `true` |\r\n| **Metadata** | `{{user.public_metadata}}`, `{{user.public_metadata.FIELD}}` | `{\"role\": \"admin\"}` |\r\n| **Organization** | `org_id`, `org_slug`, `org_role` (in sessionClaims) | `\"org:admin\"` |\r\n\r\n### Advanced Features\r\n\r\n**String Interpolation**:\r\n```json\r\n{\r\n  \"full_name\": \"{{user.last_name}} {{user.first_name}}\",\r\n  \"greeting\": \"Hello, {{user.first_name}}!\"\r\n}\r\n```\r\n\r\n**Conditional Fallbacks**:\r\n```json\r\n{\r\n  \"role\": \"{{user.public_metadata.role || 'user'}}\",\r\n  \"age\": \"{{user.public_metadata.age || 18}}\",\r\n  \"verified\": \"{{user.email_verified || user.phone_number_verified}}\"\r\n}\r\n```\r\n\r\n**Nested Metadata with Dot Notation**:\r\n```json\r\n{\r\n  \"interests\": \"{{user.public_metadata.profile.interests}}\",\r\n  \"department\": \"{{user.public_metadata.department}}\"\r\n}\r\n```\r\n\r\n### Default Claims (Auto-Included)\r\n\r\nEvery JWT includes these claims automatically (cannot be overridden):\r\n\r\n```json\r\n{\r\n  \"azp\": \"http://localhost:3000\",              // Authorized party\r\n  \"exp\": 1639398300,                            // Expiration time\r\n  \"iat\": 1639398272,                            // Issued at\r\n  \"iss\": \"https://your-app.clerk.accounts.dev\", // Issuer\r\n  \"jti\": \"10db7f531a90cb2faea4\",               // JWT ID\r\n  \"nbf\": 1639398220,                            // Not before\r\n  \"sub\": \"user_1deJLArSTiWiF1YdsEWysnhJLLY\"    // User ID\r\n}\r\n```\r\n\r\n### Size Limitation: 1.2KB for Custom Claims\r\n\r\n**Problem**: Browser cookies limited to 4KB. Clerk's default claims consume ~2.8KB, leaving **1.2KB for custom claims**.\r\n\r\n**⚠️ Development Note**: When testing custom claims in Vite dev mode, you may encounter **\"431 Request Header Fields Too Large\"** error. This is caused by Clerk's handshake token in the URL exceeding Vite's 8KB limit. See [Issue #11](#issue-11-431-request-header-fields-too-large-vite-dev-mode) for solution.\r\n\r\n**Solution**:\r\n```json\r\n// ✅ GOOD: Minimal claims\r\n{\r\n  \"user_id\": \"{{user.id}}\",\r\n  \"email\": \"{{user.primary_email_address}}\",\r\n  \"role\": \"{{user.public_metadata.role}}\"\r\n}\r\n\r\n// ❌ BAD: Exceeds limit\r\n{\r\n  \"bio\": \"{{user.public_metadata.bio}}\",  // 6KB field\r\n  \"all_metadata\": \"{{user.public_metadata}}\"  // Entire object\r\n}\r\n```\r\n\r\n**Best Practice**: Store large data in database, include only identifiers/roles in JWT.\r\n\r\n### TypeScript Type Safety\r\n\r\nAdd global type declarations for auto-complete:\r\n\r\n**Create `types/globals.d.ts`**:\r\n```typescript\r\nexport {}\r\n\r\ndeclare global {\r\n  interface CustomJwtSessionClaims {\r\n    metadata: {\r\n      role?: 'admin' | 'moderator' | 'user'\r\n      onboardingComplete?: boolean\r\n      organizationId?: string\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n### Common Use Cases\r\n\r\n**Role-Based Access Control**:\r\n```json\r\n{\r\n  \"email\": \"{{user.primary_email_address}}\",\r\n  \"role\": \"{{user.public_metadata.role || 'user'}}\",\r\n  \"permissions\": \"{{user.public_metadata.permissions}}\"\r\n}\r\n```\r\n\r\n**Multi-Tenant Applications**:\r\n```json\r\n{\r\n  \"user_id\": \"{{user.id}}\",\r\n  \"org_id\": \"{{user.public_metadata.org_id}}\",\r\n  \"org_role\": \"{{user.public_metadata.org_role}}\"\r\n}\r\n```\r\n\r\n**Supabase Integration**:\r\n```json\r\n{\r\n  \"email\": \"{{user.primary_email_address}}\",\r\n  \"app_metadata\": {\r\n    \"provider\": \"clerk\"\r\n  },\r\n  \"user_metadata\": {\r\n    \"full_name\": \"{{user.full_name}}\"\r\n  }\r\n}\r\n```\r\n\r\n### See Also\r\n\r\n- **Complete Reference**: See `references/jwt-claims-guide.md` for comprehensive documentation\r\n- **Template Examples**: See `templates/jwt/` directory for working examples\r\n- **TypeScript Types**: See `templates/typescript/custom-jwt-types.d.ts`\r\n- **Official Docs**: https://clerk.com/docs/guides/sessions/jwt-templates\r\n\r\n---",
    "Known Issues Prevention": "This skill prevents **11 documented issues**:\r\n\r\n### Issue #1: Missing Clerk Secret Key\r\n**Error**: \"Missing Clerk Secret Key or API Key\"\r\n**Source**: https://stackoverflow.com/questions/77620604\r\n**Prevention**: Always set in \\`.env.local\\` or via \\`wrangler secret put\\`\r\n\r\n### Issue #2: API Key → Secret Key Migration\r\n**Error**: \"apiKey is deprecated, use secretKey\"\r\n**Source**: https://clerk.com/docs/upgrade-guides/core-2/backend\r\n**Prevention**: Replace \\`apiKey\\` with \\`secretKey\\` in all calls\r\n\r\n### Issue #3: JWKS Cache Race Condition\r\n**Error**: \"No JWK available\"\r\n**Source**: https://github.com/clerk/javascript/blob/main/packages/backend/CHANGELOG.md\r\n**Prevention**: Use @clerk/backend@2.17.2 or later (fixed)\r\n\r\n### Issue #4: Missing authorizedParties (CSRF)\r\n**Error**: No error, but CSRF vulnerability\r\n**Source**: https://clerk.com/docs/reference/backend/verify-token\r\n**Prevention**: Always set \\`authorizedParties: ['https://yourdomain.com']\\`\r\n\r\n### Issue #5: Import Path Changes (Core 2)\r\n**Error**: \"Cannot find module\"\r\n**Source**: https://clerk.com/docs/upgrade-guides/core-2/backend\r\n**Prevention**: Update import paths for Core 2\r\n\r\n### Issue #6: JWT Size Limit Exceeded\r\n**Error**: Token exceeds size limit\r\n**Source**: https://clerk.com/docs/backend-requests/making/custom-session-token\r\n**Prevention**: Keep custom claims under 1.2KB\r\n\r\n### Issue #7: Deprecated API Version v1\r\n**Error**: \"API version v1 is deprecated\"\r\n**Source**: https://clerk.com/docs/upgrade-guides/core-2/backend\r\n**Prevention**: Use latest SDK versions (API v2025-04-10)\r\n\r\n### Issue #8: ClerkProvider JSX Component Error\r\n**Error**: \"cannot be used as a JSX component\"\r\n**Source**: https://stackoverflow.com/questions/79265537\r\n**Prevention**: Ensure React 19 compatibility with @clerk/clerk-react@5.51.0+\r\n\r\n### Issue #9: Async auth() Helper Confusion\r\n**Error**: \"auth() is not a function\"\r\n**Source**: https://clerk.com/changelog/2024-10-22-clerk-nextjs-v6\r\n**Prevention**: Always await: \\`const { userId } = await auth()\\`\r\n\r\n### Issue #10: Environment Variable Misconfiguration\r\n**Error**: \"Missing Publishable Key\" or secret leaked\r\n**Prevention**: Use correct prefixes (\\`NEXT_PUBLIC_\\`, \\`VITE_\\`), never commit secrets\r\n\r\n### Issue #11: 431 Request Header Fields Too Large (Vite Dev Mode)\r\n**Error**: \"431 Request Header Fields Too Large\" when signing in\r\n**Source**: Common in Vite dev mode when testing custom JWT claims\r\n**Cause**: Clerk's `__clerk_handshake` token in URL exceeds Vite's 8KB header limit\r\n**Prevention**:\r\n\r\nAdd to `package.json`:\r\n\\`\\`\\`json\r\n{\r\n  \"scripts\": {\r\n    \"dev\": \"NODE_OPTIONS='--max-http-header-size=32768' vite\"\r\n  }\r\n}\r\n\\`\\`\\`\r\n\r\n**Temporary Workaround**: Clear browser cache, sign out, sign back in\r\n\r\n**Why**: Clerk dev tokens are larger than production; custom JWT claims increase handshake token size\r\n\r\n**Note**: This is different from Issue #6 (session token size). Issue #6 is about cookies (1.2KB), this is about URL parameters in dev mode (8KB → 32KB).\r\n\r\n---",
    "Testing": "CLERK_SECRET_KEY=sk_test_... node scripts/generate-session-token.js --refresh\r\n```\r\n\r\n**Manual Flow**:\r\n1. Create user: `POST /v1/users`\r\n2. Create session: `POST /v1/sessions`\r\n3. Generate token: `POST /v1/sessions/{session_id}/tokens`\r\n4. Use in header: `Authorization: Bearer <token>`\r\n\r\n### E2E Testing with Playwright\r\n\r\nInstall `@clerk/testing` for automatic Testing Token management:\r\n\r\n```bash\r\nnpm install -D @clerk/testing\r\n```\r\n\r\n**Global Setup** (`global.setup.ts`):\r\n```typescript\r\nimport { clerkSetup } from '@clerk/testing/playwright'\r\nimport { test as setup } from '@playwright/test'\r\n\r\nsetup('global setup', async ({}) => {\r\n  await clerkSetup()\r\n})\r\n```\r\n\r\n**Test File** (`auth.spec.ts`):\r\n```typescript\r\nimport { setupClerkTestingToken } from '@clerk/testing/playwright'\r\nimport { test } from '@playwright/test'\r\n\r\ntest('sign up', async ({ page }) => {\r\n  await setupClerkTestingToken({ page })\r\n\r\n  await page.goto('/sign-up')\r\n  await page.fill('input[name=\"emailAddress\"]', 'test+clerk_test@example.com')\r\n  await page.fill('input[name=\"password\"]', 'TestPassword123!')\r\n  await page.click('button[type=\"submit\"]')\r\n\r\n  // Verify with fixed OTP\r\n  await page.fill('input[name=\"code\"]', '424242')\r\n  await page.click('button[type=\"submit\"]')\r\n\r\n  await expect(page).toHaveURL('/dashboard')\r\n})\r\n```\r\n\r\n### Testing Tokens (Bot Detection Bypass)\r\n\r\nTesting Tokens bypass bot detection in test suites.\r\n\r\n**Obtain Token**:\r\n```bash\r\ncurl -X POST https://api.clerk.com/v1/testing_tokens \\\r\n  -H \"Authorization: Bearer sk_test_...\"\r\n```\r\n\r\n**Use in Frontend API Requests**:\r\n```\r\nPOST https://your-app.clerk.accounts.dev/v1/client/sign_ups?__clerk_testing_token=TOKEN\r\n```\r\n\r\n**Note**: `@clerk/testing` handles this automatically for Playwright/Cypress.\r\n\r\n### Production Limitations\r\n\r\nTesting Tokens work in both development and production, but:\r\n- ❌ Code-based auth (SMS/Email OTP) not supported in production\r\n- ✅ Email + password authentication supported\r\n- ✅ Magic links supported\r\n\r\n### See Also\r\n\r\n- **Complete Guide**: See `references/testing-guide.md` for comprehensive testing documentation\r\n- **Session Token Script**: See `scripts/generate-session-token.js`\r\n- **Demo Repository**: https://github.com/clerk/clerk-playwright-nextjs\r\n- **Official Docs**: https://clerk.com/docs/guides/development/testing/overview\r\n\r\n---",
    "Package Versions (Verified 2025-10-22)": "\\`\\`\\`json\r\n{\r\n  \"dependencies\": {\r\n    \"@clerk/nextjs\": \"^6.33.3\",\r\n    \"@clerk/clerk-react\": \"^5.51.0\",\r\n    \"@clerk/backend\": \"^2.17.2\"\r\n  }\r\n}\r\n\\`\\`\\`",
    "Cloudflare Workers Setup": "### 1. Install Dependencies\r\n\r\n\\`\\`\\`bash\r\nnpm install @clerk/backend hono\r\n\\`\\`\\`\r\n\r\n**Latest Versions**:\r\n- @clerk/backend@2.17.2 (verified 2025-10-22)\r\n- hono@4.10.1\r\n\r\n### 2. Configure Environment Variables\r\n\r\nCreate \\`.dev.vars\\` for local development:\r\n\r\n\\`\\`\\`bash\r\nCLERK_SECRET_KEY=sk_test_...\r\nCLERK_PUBLISHABLE_KEY=pk_test_...\r\n\\`\\`\\`\r\n\r\n**Production**: Use \\`wrangler secret put CLERK_SECRET_KEY\\`\r\n\r\n### 3. Implement Token Verification\r\n\r\nCreate \\`src/index.ts\\`:\r\n\r\n\\`\\`\\`typescript\r\nimport { Hono } from 'hono'\r\nimport { verifyToken } from '@clerk/backend'\r\n\r\ntype Bindings = {\r\n  CLERK_SECRET_KEY: string\r\n  CLERK_PUBLISHABLE_KEY: string\r\n}\r\n\r\ntype Variables = {\r\n  userId: string | null\r\n  sessionClaims: any | null\r\n}\r\n\r\nconst app = new Hono<{ Bindings: Bindings; Variables: Variables }>()\r\n\r\n// Middleware: Verify Clerk token\r\napp.use('/api/*', async (c, next) => {\r\n  const authHeader = c.req.header('Authorization')\r\n\r\n  if (!authHeader) {\r\n    c.set('userId', null)\r\n    c.set('sessionClaims', null)\r\n    return next()\r\n  }\r\n\r\n  const token = authHeader.replace('Bearer ', '')\r\n\r\n  try {\r\n    const { data, error } = await verifyToken(token, {\r\n      secretKey: c.env.CLERK_SECRET_KEY,\r\n      // IMPORTANT: Set authorizedParties to prevent CSRF attacks\r\n      authorizedParties: ['https://yourdomain.com'],\r\n    })\r\n\r\n    if (error) {\r\n      console.error('Token verification failed:', error)\r\n      c.set('userId', null)\r\n      c.set('sessionClaims', null)\r\n    } else {\r\n      c.set('userId', data.sub)\r\n      c.set('sessionClaims', data)\r\n    }\r\n  } catch (err) {\r\n    console.error('Token verification error:', err)\r\n    c.set('userId', null)\r\n    c.set('sessionClaims', null)\r\n  }\r\n\r\n  return next()\r\n})\r\n\r\n// Protected route\r\napp.get('/api/protected', (c) => {\r\n  const userId = c.get('userId')\r\n\r\n  if (!userId) {\r\n    return c.json({ error: 'Unauthorized' }, 401)\r\n  }\r\n\r\n  return c.json({\r\n    message: 'This is protected',\r\n    userId,\r\n    sessionClaims: c.get('sessionClaims'),\r\n  })\r\n})\r\n\r\nexport default app\r\n\\`\\`\\`\r\n\r\n**CRITICAL**:\r\n- Always set \\`authorizedParties\\` to prevent CSRF attacks\r\n- Use \\`secretKey\\`, not deprecated \\`apiKey\\`\r\n- Source: https://clerk.com/docs/reference/backend/verify-token\r\n\r\n---",
    "Critical Rules": "### Always Do\r\n\r\n✅ Set \\`authorizedParties\\` when verifying tokens\r\n✅ Use \\`CLERK_SECRET_KEY\\` environment variable\r\n✅ Check \\`isLoaded\\` before rendering auth UI\r\n✅ Use \\`getToken()\\` fresh for each request\r\n✅ Await \\`auth()\\` in Next.js v6+\r\n✅ Use \\`NEXT_PUBLIC_\\` prefix for client vars only\r\n✅ Store secrets via \\`wrangler secret put\\`\r\n✅ Implement middleware for route protection\r\n✅ Use API version 2025-04-10 or later\r\n\r\n### Never Do\r\n\r\n❌ Store \\`CLERK_SECRET_KEY\\` in client code\r\n❌ Use deprecated \\`apiKey\\` parameter\r\n❌ Store tokens in localStorage\r\n❌ Skip \\`authorizedParties\\` check\r\n❌ Exceed 1.2KB for custom JWT claims\r\n❌ Forget to check \\`isLoaded\\`\r\n❌ Expose secrets with \\`NEXT_PUBLIC_\\` prefix\r\n❌ Use API version v1\r\n\r\n---"
  }
}
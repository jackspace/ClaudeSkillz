{
  "description": "\"Differential gene expression analysis (Python DESeq2). Identify DE genes from bulk RNA-seq counts, Wald tests, FDR correction, volcano/MA plots, for RNA-seq analysis.\"",
  "references": {
    "files": [
      "references/api_reference.md",
      "references/workflow_guide.md"
    ]
  },
  "content": "For users who want to perform a standard differential expression analysis:\r\n\r\n```python\r\nimport pandas as pd\r\nfrom pydeseq2.dds import DeseqDataSet\r\nfrom pydeseq2.ds import DeseqStats\r\n\r\ncounts_df = pd.read_csv(\"counts.csv\", index_col=0).T  # Transpose to samples × genes\r\nmetadata = pd.read_csv(\"metadata.csv\", index_col=0)\r\n\r\ngenes_to_keep = counts_df.columns[counts_df.sum(axis=0) >= 10]\r\ncounts_df = counts_df[genes_to_keep]\r\n\r\ndds = DeseqDataSet(\r\n    counts=counts_df,\r\n    metadata=metadata,\r\n    design=\"~condition\",\r\n    refit_cooks=True\r\n)\r\ndds.deseq2()\r\n\r\nds = DeseqStats(dds, contrast=[\"condition\", \"treated\", \"control\"])\r\nds.summary()\r\n\r\n\r\n### Step 1: Data Preparation\r\n\r\n**Input requirements:**\r\n- **Count matrix:** Samples × genes DataFrame with non-negative integer read counts\r\n- **Metadata:** Samples × variables DataFrame with experimental factors\r\n\r\n**Common data loading patterns:**\r\n\r\n```python\r\ncounts_df = pd.read_csv(\"counts.csv\", index_col=0).T\r\nmetadata = pd.read_csv(\"metadata.csv\", index_col=0)\r\n\r\ncounts_df = pd.read_csv(\"counts.tsv\", sep=\"\\t\", index_col=0).T\r\n\r\nimport anndata as ad\r\nadata = ad.read_h5ad(\"data.h5ad\")\r\ncounts_df = pd.DataFrame(adata.X, index=adata.obs_names, columns=adata.var_names)\r\nmetadata = adata.obs\r\n```\r\n\r\n**Data filtering:**\r\n\r\n```python\r\ngenes_to_keep = counts_df.columns[counts_df.sum(axis=0) >= 10]\r\ncounts_df = counts_df[genes_to_keep]\r\n\r\nsamples_to_keep = ~metadata.condition.isna()\r\ncounts_df = counts_df.loc[samples_to_keep]\r\nmetadata = metadata.loc[samples_to_keep]\r\n```\r\n\r\n### Step 2: Design Specification\r\n\r\nThe design formula specifies how gene expression is modeled.\r\n\r\n**Single-factor designs:**\r\n```python\r\ndesign = \"~condition\"  # Simple two-group comparison\r\n```\r\n\r\n**Multi-factor designs:**\r\n```python\r\ndesign = \"~batch + condition\"  # Control for batch effects\r\ndesign = \"~age + condition\"     # Include continuous covariate\r\ndesign = \"~group + condition + group:condition\"  # Interaction effects\r\n```\r\n\r\n**Design formula guidelines:**\r\n- Use Wilkinson formula notation (R-style)\r\n- Put adjustment variables (e.g., batch) before the main variable of interest\r\n- Ensure variables exist as columns in the metadata DataFrame\r\n- Use appropriate data types (categorical for discrete variables)\r\n\r\n### Step 3: DESeq2 Fitting\r\n\r\nInitialize the DeseqDataSet and run the complete pipeline:\r\n\r\n```python\r\nfrom pydeseq2.dds import DeseqDataSet\r\n\r\ndds = DeseqDataSet(\r\n    counts=counts_df,\r\n    metadata=metadata,\r\n    design=\"~condition\",\r\n    refit_cooks=True,  # Refit after removing outliers\r\n    n_cpus=1           # Parallel processing (adjust as needed)\r\n)\r\n\r\ndds.deseq2()\r\n```\r\n\r\n**What `deseq2()` does:**\r\n1. Computes size factors (normalization)\r\n2. Fits genewise dispersions\r\n3. Fits dispersion trend curve\r\n4. Computes dispersion priors\r\n5. Fits MAP dispersions (shrinkage)\r\n6. Fits log fold changes\r\n7. Calculates Cook's distances (outlier detection)\r\n8. Refits if outliers detected (optional)\r\n\r\n### Step 4: Statistical Testing\r\n\r\nPerform Wald tests to identify differentially expressed genes:\r\n\r\n```python\r\nfrom pydeseq2.ds import DeseqStats\r\n\r\nds = DeseqStats(\r\n    dds,\r\n    contrast=[\"condition\", \"treated\", \"control\"],  # Test treated vs control\r\n    alpha=0.05,                # Significance threshold\r\n    cooks_filter=True,         # Filter outliers\r\n    independent_filter=True    # Filter low-power tests\r\n)\r\n\r\nds.summary()\r\n```\r\n\r\n**Contrast specification:**\r\n- Format: `[variable, test_level, reference_level]`\r\n- Example: `[\"condition\", \"treated\", \"control\"]` tests treated vs control\r\n- If `None`, uses the last coefficient in the design\r\n\r\n**Result DataFrame columns:**\r\n- `baseMean`: Mean normalized count across samples\r\n- `log2FoldChange`: Log2 fold change between conditions\r\n- `lfcSE`: Standard error of LFC\r\n- `stat`: Wald test statistic\r\n- `pvalue`: Raw p-value\r\n- `padj`: Adjusted p-value (FDR-corrected via Benjamini-Hochberg)\r\n\r\n### Step 5: Optional LFC Shrinkage\r\n\r\nApply shrinkage to reduce noise in fold change estimates:\r\n\r\n```python\r\nds.lfc_shrink()  # Applies apeGLM shrinkage\r\n```\r\n\r\n**When to use LFC shrinkage:**\r\n- For visualization (volcano plots, heatmaps)\r\n- For ranking genes by effect size\r\n- When prioritizing genes for follow-up experiments\r\n\r\n**Important:** Shrinkage affects only the log2FoldChange values, not the statistical test results (p-values remain unchanged). Use shrunk values for visualization but report unshrunken p-values for significance.\r\n\r\n### Step 6: Result Export\r\n\r\nSave results and intermediate objects:\r\n\r\n```python\r\nimport pickle\r\n\r\nds.results_df.to_csv(\"deseq2_results.csv\")\r\n\r\nsignificant = ds.results_df[ds.results_df.padj < 0.05]\r\nsignificant.to_csv(\"significant_genes.csv\")\r\n\r\n\r\n### Two-Group Comparison\r\n\r\nStandard case-control comparison:\r\n\r\n```python\r\ndds = DeseqDataSet(counts=counts_df, metadata=metadata, design=\"~condition\")\r\ndds.deseq2()\r\n\r\nds = DeseqStats(dds, contrast=[\"condition\", \"treated\", \"control\"])\r\nds.summary()\r\n\r\nresults = ds.results_df\r\nsignificant = results[results.padj < 0.05]\r\n```\r\n\r\n### Multiple Comparisons\r\n\r\nTesting multiple treatment groups against control:\r\n\r\n```python\r\ndds = DeseqDataSet(counts=counts_df, metadata=metadata, design=\"~condition\")\r\ndds.deseq2()\r\n\r\ntreatments = [\"treatment_A\", \"treatment_B\", \"treatment_C\"]\r\nall_results = {}\r\n\r\nfor treatment in treatments:\r\n    ds = DeseqStats(dds, contrast=[\"condition\", treatment, \"control\"])\r\n    ds.summary()\r\n    all_results[treatment] = ds.results_df\r\n\r\n    sig_count = len(ds.results_df[ds.results_df.padj < 0.05])\r\n    print(f\"{treatment}: {sig_count} significant genes\")\r\n```\r\n\r\n### Accounting for Batch Effects\r\n\r\nControl for technical variation:\r\n\r\n```python\r\ndds = DeseqDataSet(counts=counts_df, metadata=metadata, design=\"~batch + condition\")\r\ndds.deseq2()\r\n\r\nds = DeseqStats(dds, contrast=[\"condition\", \"treated\", \"control\"])\r\nds.summary()\r\n```\r\n\r\n### Continuous Covariates\r\n\r\nInclude continuous variables like age or dosage:\r\n\r\n```python\r\n\r\nThis skill includes a complete command-line script for standard analyses:\r\n\r\n```bash\r\npython scripts/run_deseq2_analysis.py \\\r\n  --counts counts.csv \\\r\n  --metadata metadata.csv \\\r\n  --design \"~condition\" \\\r\n  --contrast condition treated control \\\r\n  --output results/\r\n\r\n\r\n### Identifying Significant Genes\r\n\r\n```python\r\nsignificant = ds.results_df[ds.results_df.padj < 0.05]\r\n\r\nsig_and_large = ds.results_df[\r\n    (ds.results_df.padj < 0.05) &\r\n    (abs(ds.results_df.log2FoldChange) > 1)\r\n]\r\n\r\nupregulated = significant[significant.log2FoldChange > 0]\r\ndownregulated = significant[significant.log2FoldChange < 0]\r\n\r\nprint(f\"Upregulated: {len(upregulated)}\")\r\nprint(f\"Downregulated: {len(downregulated)}\")\r\n```\r\n\r\n### Ranking and Sorting\r\n\r\n```python\r\ntop_by_padj = ds.results_df.sort_values(\"padj\").head(20)\r\n\r\nds.lfc_shrink()\r\nds.results_df[\"abs_lfc\"] = abs(ds.results_df.log2FoldChange)\r\ntop_by_lfc = ds.results_df.sort_values(\"abs_lfc\", ascending=False).head(20)\r\n\r\nds.results_df[\"score\"] = -np.log10(ds.results_df.padj) * abs(ds.results_df.log2FoldChange)\r\ntop_combined = ds.results_df.sort_values(\"score\", ascending=False).head(20)\r\n```\r\n\r\n### Quality Metrics\r\n\r\n```python\r\nprint(\"Size factors:\", dds.obsm[\"size_factors\"])\r\n\r\nimport matplotlib.pyplot as plt\r\nplt.hist(dds.varm[\"dispersions\"], bins=50)\r\nplt.xlabel(\"Dispersion\")\r\nplt.ylabel(\"Frequency\")\r\nplt.title(\"Dispersion Distribution\")\r\nplt.show()\r\n\r\n\r\n### Data Format Problems\r\n\r\n**Issue:** \"Index mismatch between counts and metadata\"\r\n\r\n**Solution:** Ensure sample names match exactly\r\n```python\r\nprint(\"Counts samples:\", counts_df.index.tolist())\r\nprint(\"Metadata samples:\", metadata.index.tolist())\r\n\r\ncommon = counts_df.index.intersection(metadata.index)\r\ncounts_df = counts_df.loc[common]\r\nmetadata = metadata.loc[common]\r\n```\r\n\r\n**Issue:** \"All genes have zero counts\"\r\n\r\n**Solution:** Check if data needs transposition\r\n```python\r\nprint(f\"Counts shape: {counts_df.shape}\")\r\nif counts_df.shape[1] < counts_df.shape[0]:\r\n    counts_df = counts_df.T\r\n```\r\n\r\n### Design Matrix Issues\r\n\r\n**Issue:** \"Design matrix is not full rank\"\r\n\r\n**Cause:** Confounded variables (e.g., all treated samples in one batch)\r\n\r\n**Solution:** Remove confounded variable or add interaction term\r\n```python\r\nprint(pd.crosstab(metadata.condition, metadata.batch))\r\n\r\ndesign = \"~condition\"  # Remove batch\r\ndesign = \"~condition + batch + condition:batch\"  # Model interaction\r\n```\r\n\r\n### No Significant Genes\r\n\r\n**Diagnostics:**\r\n```python\r\nplt.hist(dds.varm[\"dispersions\"], bins=50)\r\nplt.show()\r\n\r\nprint(dds.obsm[\"size_factors\"])\r\n\r\n\r\nPyDESeq2 can be installed via pip or conda:\r\n\r\n```bash\r\npip install pydeseq2",
  "name": "pydeseq2",
  "id": "scientific-pkg-pydeseq2",
  "sections": {
    "Key Reminders": "1. **Data orientation matters:** Count matrices typically load as genes × samples but need to be samples × genes. Always transpose with `.T` if needed.\r\n\r\n2. **Sample filtering:** Remove samples with missing metadata before analysis to avoid errors.\r\n\r\n3. **Gene filtering:** Filter low-count genes (e.g., < 10 total reads) to improve power and reduce computational time.\r\n\r\n4. **Design formula order:** Put adjustment variables before the variable of interest (e.g., `\"~batch + condition\"` not `\"~condition + batch\"`).\r\n\r\n5. **LFC shrinkage timing:** Apply shrinkage after statistical testing and only for visualization/ranking purposes. P-values remain based on unshrunken estimates.\r\n\r\n6. **Result interpretation:** Use `padj < 0.05` for significance, not raw p-values. The Benjamini-Hochberg procedure controls false discovery rate.\r\n\r\n7. **Contrast specification:** The format is `[variable, test_level, reference_level]` where test_level is compared against reference_level.\r\n\r\n8. **Save intermediate objects:** Use pickle to save DeseqDataSet objects for later use or additional analyses without re-running the expensive fitting step.",
    "Common Analysis Patterns": "metadata[\"age\"] = pd.to_numeric(metadata[\"age\"])\r\n\r\ndds = DeseqDataSet(counts=counts_df, metadata=metadata, design=\"~age + condition\")\r\ndds.deseq2()\r\n\r\nds = DeseqStats(dds, contrast=[\"condition\", \"treated\", \"control\"])\r\nds.summary()\r\n```",
    "Additional Resources": "- **Official Documentation:** https://pydeseq2.readthedocs.io\r\n- **GitHub Repository:** https://github.com/owkin/PyDESeq2\r\n- **Publication:** Muzellec et al. (2023) Bioinformatics, DOI: 10.1093/bioinformatics/btad547\r\n- **Original DESeq2 (R):** Love et al. (2014) Genome Biology, DOI: 10.1186/s13059-014-0550-8",
    "Overview": "PyDESeq2 is a Python implementation of DESeq2 for differential expression analysis with bulk RNA-seq data. Design and execute complete workflows from data loading through result interpretation, including single-factor and multi-factor designs, Wald tests with multiple testing correction, optional apeGLM shrinkage, and integration with pandas and AnnData.",
    "Reference Documentation": "For comprehensive details beyond this workflow-oriented guide:\r\n\r\n- **API Reference** (`references/api_reference.md`): Complete documentation of PyDESeq2 classes, methods, and data structures. Use when needing detailed parameter information or understanding object attributes.\r\n\r\n- **Workflow Guide** (`references/workflow_guide.md`): In-depth guide covering complete analysis workflows, data loading patterns, multi-factor designs, troubleshooting, and best practices. Use when handling complex experimental designs or encountering issues.\r\n\r\nLoad these references into context when users need:\r\n- Detailed API documentation: `Read references/api_reference.md`\r\n- Comprehensive workflow examples: `Read references/workflow_guide.md`\r\n- Troubleshooting guidance: `Read references/workflow_guide.md` (see Troubleshooting section)",
    "Visualization Guidelines": "### Volcano Plot\r\n\r\nVisualize significance vs effect size:\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\nresults = ds.results_df.copy()\r\nresults[\"-log10(padj)\"] = -np.log10(results.padj)\r\n\r\nplt.figure(figsize=(10, 6))\r\nsignificant = results.padj < 0.05\r\n\r\nplt.scatter(\r\n    results.loc[~significant, \"log2FoldChange\"],\r\n    results.loc[~significant, \"-log10(padj)\"],\r\n    alpha=0.3, s=10, c='gray', label='Not significant'\r\n)\r\nplt.scatter(\r\n    results.loc[significant, \"log2FoldChange\"],\r\n    results.loc[significant, \"-log10(padj)\"],\r\n    alpha=0.6, s=10, c='red', label='padj < 0.05'\r\n)\r\n\r\nplt.axhline(-np.log10(0.05), color='blue', linestyle='--', alpha=0.5)\r\nplt.xlabel(\"Log2 Fold Change\")\r\nplt.ylabel(\"-Log10(Adjusted P-value)\")\r\nplt.title(\"Volcano Plot\")\r\nplt.legend()\r\nplt.savefig(\"volcano_plot.png\", dpi=300)\r\n```\r\n\r\n### MA Plot\r\n\r\nShow fold change vs mean expression:\r\n\r\n```python\r\nplt.figure(figsize=(10, 6))\r\n\r\nplt.scatter(\r\n    np.log10(results.loc[~significant, \"baseMean\"] + 1),\r\n    results.loc[~significant, \"log2FoldChange\"],\r\n    alpha=0.3, s=10, c='gray'\r\n)\r\nplt.scatter(\r\n    np.log10(results.loc[significant, \"baseMean\"] + 1),\r\n    results.loc[significant, \"log2FoldChange\"],\r\n    alpha=0.6, s=10, c='red'\r\n)\r\n\r\nplt.axhline(0, color='blue', linestyle='--', alpha=0.5)\r\nplt.xlabel(\"Log10(Base Mean + 1)\")\r\nplt.ylabel(\"Log2 Fold Change\")\r\nplt.title(\"MA Plot\")\r\nplt.savefig(\"ma_plot.png\", dpi=300)\r\n```",
    "Core Workflow Steps": "with open(\"dds_result.pkl\", \"wb\") as f:\r\n    pickle.dump(dds.to_picklable_anndata(), f)\r\n```",
    "When to Use This Skill": "This skill should be used when:\r\n- Analyzing bulk RNA-seq count data for differential expression\r\n- Comparing gene expression between experimental conditions (e.g., treated vs control)\r\n- Performing multi-factor designs accounting for batch effects or covariates\r\n- Converting R-based DESeq2 workflows to Python\r\n- Integrating differential expression analysis into Python-based pipelines\r\n- Users mention \"DESeq2\", \"differential expression\", \"RNA-seq analysis\", or \"PyDESeq2\"",
    "Installation and Requirements": "conda install -c bioconda pydeseq2\r\n```\r\n\r\n**System requirements:**\r\n- Python 3.10-3.11\r\n- pandas 1.4.3+\r\n- numpy 1.23.0+\r\n- scipy 1.11.0+\r\n- scikit-learn 1.1.1+\r\n- anndata 0.8.0+\r\n\r\n**Optional for visualization:**\r\n- matplotlib\r\n- seaborn",
    "Using the Analysis Script": "python scripts/run_deseq2_analysis.py \\\r\n  --counts counts.csv \\\r\n  --metadata metadata.csv \\\r\n  --design \"~batch + condition\" \\\r\n  --contrast condition treated control \\\r\n  --output results/ \\\r\n  --min-counts 10 \\\r\n  --alpha 0.05 \\\r\n  --n-cpus 4 \\\r\n  --plots\r\n```\r\n\r\n**Script features:**\r\n- Automatic data loading and validation\r\n- Gene and sample filtering\r\n- Complete DESeq2 pipeline execution\r\n- Statistical testing with customizable parameters\r\n- Result export (CSV, pickle)\r\n- Optional visualization (volcano and MA plots)\r\n\r\nRefer users to `scripts/run_deseq2_analysis.py` when they need a standalone analysis tool or want to batch process multiple datasets.",
    "Quick Start Workflow": "results = ds.results_df\r\nsignificant = results[results.padj < 0.05]\r\nprint(f\"Found {len(significant)} significant genes\")\r\n```",
    "Troubleshooting Common Issues": "print(ds.results_df.nsmallest(20, \"pvalue\"))\r\n```\r\n\r\n**Possible causes:**\r\n- Small effect sizes\r\n- High biological variability\r\n- Insufficient sample size\r\n- Technical issues (batch effects, outliers)",
    "Result Interpretation": "plt.hist(ds.results_df.pvalue.dropna(), bins=50)\r\nplt.xlabel(\"P-value\")\r\nplt.ylabel(\"Frequency\")\r\nplt.title(\"P-value Distribution\")\r\nplt.show()\r\n```"
  }
}
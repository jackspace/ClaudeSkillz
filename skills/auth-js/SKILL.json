{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/common-errors.md",
      "references/edge-compatibility.md",
      "references/jwt-customization.md",
      "references/middleware-patterns.md",
      "references/provider-setup-guides.md",
      "references/session-strategies.md",
      "references/v5-migration-guide.md"
    ]
  },
  "content": "**Production-tested**: Multiple Next.js and Cloudflare Workers projects\r\n**Last Updated**: 2025-10-26\r\n**Status**: Production Ready ✅\r\n**Official Docs**: https://authjs.dev\r\n\r\n---\r\n\r\n\r\n### Prerequisites\r\n\r\n```bash\r\nnpm create next-app@latest my-app\r\ncd my-app\r\n```\r\n\r\n### Installation\r\n\r\n```bash\r\nnpm install next-auth@latest\r\nnpm install @auth/core@latest\r\n\r\nnpm install @auth/prisma-adapter  # For PostgreSQL/MySQL\r\nnpm install @auth/d1-adapter      # For Cloudflare D1\r\n```\r\n\r\n### 1. Create Auth Configuration\r\n\r\n**Option A: Simple Setup (JWT sessions, no database)**\r\n\r\n```typescript\r\n// auth.ts\r\nimport NextAuth from \"next-auth\"\r\nimport GitHub from \"next-auth/providers/github\"\r\n\r\nexport const { handlers, auth, signIn, signOut } = NextAuth({\r\n  providers: [\r\n    GitHub({\r\n      clientId: process.env.AUTH_GITHUB_ID,\r\n      clientSecret: process.env.AUTH_GITHUB_SECRET,\r\n    }),\r\n  ],\r\n})\r\n```\r\n\r\n**Option B: Edge-Compatible Setup (recommended for middleware)**\r\n\r\n```typescript\r\n// auth.config.ts (edge-compatible, no database)\r\nimport type { NextAuthConfig } from \"next-auth\"\r\nimport GitHub from \"next-auth/providers/github\"\r\n\r\nexport default {\r\n  providers: [\r\n    GitHub({\r\n      clientId: process.env.AUTH_GITHUB_ID,\r\n      clientSecret: process.env.AUTH_GITHUB_SECRET,\r\n    }),\r\n  ],\r\n} satisfies NextAuthConfig\r\n```\r\n\r\n```typescript\r\n// auth.ts (full config with database)\r\nimport NextAuth from \"next-auth\"\r\nimport { PrismaAdapter } from \"@auth/prisma-adapter\"\r\nimport { PrismaClient } from \"@prisma/client\"\r\nimport authConfig from \"./auth.config\"\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nexport const { handlers, auth, signIn, signOut } = NextAuth({\r\n  adapter: PrismaAdapter(prisma),\r\n  session: { strategy: \"jwt\" }, // CRITICAL: Force JWT for edge compatibility\r\n  ...authConfig,\r\n})\r\n```\r\n\r\n### 2. Create API Route Handler\r\n\r\n```typescript\r\n// app/api/auth/[...nextauth]/route.ts\r\nimport { handlers } from \"@/auth\"\r\n\r\nexport const { GET, POST } = handlers\r\n```\r\n\r\n### 3. Add Middleware (Optional but Recommended)\r\n\r\n```typescript\r\n// middleware.ts\r\nexport { auth as middleware } from \"@/auth\"\r\n\r\nexport const config = {\r\n  matcher: [\"/((?!api|_next/static|_next/image|favicon.ico).*)\"],\r\n}\r\n```\r\n\r\n### 4. Environment Variables\r\n\r\n```bash\r\nAUTH_SECRET=your-secret-here  # Generate with: npx auth secret\r\nAUTH_GITHUB_ID=your_github_client_id\r\nAUTH_GITHUB_SECRET=your_github_client_secret\r\n\r\n\r\n### Prerequisites\r\n\r\n```bash\r\nnpm create cloudflare@latest my-auth-worker\r\ncd my-auth-worker\r\n```\r\n\r\n### Installation\r\n\r\n```bash\r\nnpm install @auth/core@latest\r\nnpm install @auth/d1-adapter@latest\r\nnpm install hono\r\n```\r\n\r\n### 1. Configure Wrangler with D1\r\n\r\n```jsonc\r\n// wrangler.jsonc\r\n{\r\n  \"name\": \"my-auth-worker\",\r\n  \"main\": \"src/index.ts\",\r\n  \"compatibility_date\": \"2025-10-26\",\r\n  \"d1_databases\": [\r\n    {\r\n      \"binding\": \"DB\",\r\n      \"database_name\": \"auth_db\",\r\n      \"database_id\": \"your-database-id\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n### 2. Create D1 Database\r\n\r\n```bash\r\nnpx wrangler d1 create auth_db\r\n\r\n\r\nnpx wrangler d1 execute auth_db --file=./schema.sql\r\n```\r\n\r\n**schema.sql:**\r\n\r\n```sql\r\n-- See templates/cloudflare-workers/schema.sql for complete schema\r\nCREATE TABLE users (\r\n  id TEXT PRIMARY KEY,\r\n  name TEXT,\r\n  email TEXT UNIQUE NOT NULL,\r\n  emailVerified INTEGER,\r\n  image TEXT\r\n);\r\n\r\nCREATE TABLE accounts (\r\n  id TEXT PRIMARY KEY,\r\n  userId TEXT NOT NULL,\r\n  type TEXT NOT NULL,\r\n  provider TEXT NOT NULL,\r\n  providerAccountId TEXT NOT NULL,\r\n  refresh_token TEXT,\r\n  access_token TEXT,\r\n  expires_at INTEGER,\r\n  token_type TEXT,\r\n  scope TEXT,\r\n  id_token TEXT,\r\n  session_state TEXT,\r\n  FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE,\r\n  UNIQUE(provider, providerAccountId)\r\n);\r\n\r\nCREATE TABLE sessions (\r\n  id TEXT PRIMARY KEY,\r\n  userId TEXT NOT NULL,\r\n  expires INTEGER NOT NULL,\r\n  sessionToken TEXT UNIQUE NOT NULL,\r\n  FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE\r\n);\r\n\r\nCREATE TABLE verification_tokens (\r\n  identifier TEXT NOT NULL,\r\n  token TEXT UNIQUE NOT NULL,\r\n  expires INTEGER NOT NULL,\r\n  PRIMARY KEY (identifier, token)\r\n);\r\n```\r\n\r\n### 3. Create Worker with Auth\r\n\r\n```typescript\r\n// src/index.ts\r\nimport { Hono } from 'hono'\r\nimport { Auth } from '@auth/core'\r\nimport { D1Adapter } from '@auth/d1-adapter'\r\nimport GitHub from '@auth/core/providers/github'\r\n\r\ntype Bindings = {\r\n  DB: D1Database\r\n  AUTH_SECRET: string\r\n  AUTH_GITHUB_ID: string\r\n  AUTH_GITHUB_SECRET: string\r\n}\r\n\r\nconst app = new Hono<{ Bindings: Bindings }>()\r\n\r\napp.all('/api/auth/*', async (c) => {\r\n  const response = await Auth(c.req.raw, {\r\n    adapter: D1Adapter(c.env.DB),\r\n    providers: [\r\n      GitHub({\r\n        clientId: c.env.AUTH_GITHUB_ID,\r\n        clientSecret: c.env.AUTH_GITHUB_SECRET,\r\n      }),\r\n    ],\r\n    secret: c.env.AUTH_SECRET,\r\n    trustHost: true,\r\n  })\r\n  return response\r\n})\r\n\r\napp.get('/', async (c) => {\r\n  // Example: Get session\r\n  const session = await Auth(c.req.raw, {\r\n    adapter: D1Adapter(c.env.DB),\r\n    providers: [],\r\n    secret: c.env.AUTH_SECRET,\r\n  })\r\n\r\n  return c.json({ session })\r\n})\r\n\r\nexport default app\r\n```\r\n\r\n### 4. Environment Variables\r\n\r\n```bash\r\n\r\n### 1. Missing AUTH_SECRET\r\n\r\n**Error:**\r\n```\r\nJWEDecryptionFailed: Invalid secret\r\n```\r\n\r\n**Cause:** Missing or incorrect `AUTH_SECRET` environment variable\r\n\r\n**Fix:**\r\n```bash\r\nnpx auth secret\r\n\r\nAUTH_SECRET=your-generated-secret",
  "name": "auth-js",
  "id": "auth-js",
  "sections": {
    "Table of Contents": "1. [Quick Start - Next.js](#quick-start-nextjs)\r\n2. [Quick Start - Cloudflare Workers](#quick-start-cloudflare-workers)\r\n3. [Core Concepts](#core-concepts)\r\n4. [Session Strategies](#session-strategies)\r\n5. [Provider Setup](#provider-setup)\r\n6. [Database Adapters](#database-adapters)\r\n7. [Middleware Patterns](#middleware-patterns)\r\n8. [Advanced Features](#advanced-features)\r\n9. [Critical Rules](#critical-rules)\r\n10. [Common Errors & Fixes](#common-errors--fixes)\r\n11. [Templates Reference](#templates-reference)\r\n\r\n---",
    "Quick Start: Cloudflare Workers": "npx wrangler secret put AUTH_SECRET\r\nnpx wrangler secret put AUTH_GITHUB_ID\r\nnpx wrangler secret put AUTH_GITHUB_SECRET\r\n```\r\n\r\n### 5. Deploy\r\n\r\n```bash\r\nnpx wrangler deploy\r\n```\r\n\r\n---",
    "Database Adapters": "### Cloudflare D1 Adapter\r\n\r\n**Installation:**\r\n\r\n```bash\r\nnpm install @auth/d1-adapter@latest\r\n```\r\n\r\n**Wrangler Configuration:**\r\n\r\n```jsonc\r\n// wrangler.jsonc\r\n{\r\n  \"d1_databases\": [\r\n    {\r\n      \"binding\": \"DB\",\r\n      \"database_name\": \"auth_db\",\r\n      \"database_id\": \"your-database-id\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**Usage:**\r\n\r\n```typescript\r\nimport { D1Adapter } from \"@auth/d1-adapter\"\r\n\r\n// Cloudflare Workers\r\nconst app = new Hono<{ Bindings: { DB: D1Database } }>()\r\n\r\napp.all('/api/auth/*', async (c) => {\r\n  return await Auth(c.req.raw, {\r\n    adapter: D1Adapter(c.env.DB),\r\n    providers: [GitHub],\r\n  })\r\n})\r\n\r\n// Next.js (with D1 via wrangler)\r\nexport const { handlers, auth } = NextAuth({\r\n  adapter: D1Adapter(env.DB),\r\n  session: { strategy: \"jwt\" }, // Recommended for edge\r\n  providers: [GitHub],\r\n})\r\n```\r\n\r\n**Database Schema:**\r\n\r\nSee `templates/cloudflare-workers/schema.sql` for complete schema.\r\n\r\n**Edge Compatibility:** ✅ D1 is fully edge-compatible!\r\n\r\n### Prisma Adapter (PostgreSQL/MySQL)\r\n\r\n**Installation:**\r\n\r\n```bash\r\nnpm install @auth/prisma-adapter@latest\r\nnpm install @prisma/client@latest\r\nnpm install -D prisma@latest\r\n```\r\n\r\n**Prisma Schema:**\r\n\r\n```prisma\r\n// prisma/schema.prisma\r\ngenerator client {\r\n  provider = \"prisma-client-js\"\r\n}\r\n\r\ndatasource db {\r\n  provider = \"postgresql\"\r\n  url      = env(\"DATABASE_URL\")\r\n}\r\n\r\nmodel User {\r\n  id            String    @id @default(cuid())\r\n  name          String?\r\n  email         String    @unique\r\n  emailVerified DateTime?\r\n  image         String?\r\n  accounts      Account[]\r\n  sessions      Session[]\r\n}\r\n\r\nmodel Account {\r\n  id                String  @id @default(cuid())\r\n  userId            String\r\n  type              String\r\n  provider          String\r\n  providerAccountId String\r\n  refresh_token     String? @db.Text\r\n  access_token      String? @db.Text\r\n  expires_at        Int?\r\n  token_type        String?\r\n  scope             String?\r\n  id_token          String? @db.Text\r\n  session_state     String?\r\n\r\n  user User @relation(fields: [userId], references: [id], onDelete: Cascade)\r\n\r\n  @@unique([provider, providerAccountId])\r\n}\r\n\r\nmodel Session {\r\n  id           String   @id @default(cuid())\r\n  sessionToken String   @unique\r\n  userId       String\r\n  expires      DateTime\r\n  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)\r\n}\r\n\r\nmodel VerificationToken {\r\n  identifier String\r\n  token      String   @unique\r\n  expires    DateTime\r\n\r\n  @@unique([identifier, token])\r\n}\r\n```\r\n\r\n**Usage:**\r\n\r\n```typescript\r\nimport { PrismaAdapter } from \"@auth/prisma-adapter\"\r\nimport { PrismaClient } from \"@prisma/client\"\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  adapter: PrismaAdapter(prisma),\r\n  session: { strategy: \"jwt\" }, // For edge compatibility\r\n  providers: [GitHub],\r\n})\r\n```\r\n\r\n**Edge Compatibility:** ❌ Prisma is NOT edge-compatible by default\r\n\r\n**Workaround:** Use Prisma Accelerate or Hyperdrive for edge compatibility, OR force JWT sessions and don't use the adapter in middleware.\r\n\r\nSee `templates/database-adapters/prisma-postgresql.ts` for complete example.\r\n\r\n---",
    "Middleware Patterns": "### Session Keep-Alive\r\n\r\n```typescript\r\n// middleware.ts\r\nexport { auth as middleware } from \"@/auth\"\r\n\r\nexport const config = {\r\n  matcher: [\"/((?!api|_next/static|_next/image|favicon.ico).*)\"],\r\n}\r\n```\r\n\r\nThis automatically updates session expiry on every request.\r\n\r\n### Route Protection\r\n\r\n```typescript\r\n// middleware.ts\r\nimport { auth } from \"@/auth\"\r\nimport { NextResponse } from \"next/server\"\r\n\r\nexport default auth((req) => {\r\n  const { pathname } = req.nextUrl\r\n\r\n  // Protect /dashboard routes\r\n  if (pathname.startsWith(\"/dashboard\")) {\r\n    if (!req.auth) {\r\n      const loginUrl = new URL(\"/login\", req.url)\r\n      loginUrl.searchParams.set(\"callbackUrl\", pathname)\r\n      return NextResponse.redirect(loginUrl)\r\n    }\r\n  }\r\n\r\n  return NextResponse.next()\r\n})\r\n\r\nexport const config = {\r\n  matcher: [\"/((?!api|_next/static|_next/image|favicon.ico).*)\"],\r\n}\r\n```\r\n\r\n### Role-Based Access Control (RBAC)\r\n\r\n```typescript\r\n// auth.ts\r\nexport const { handlers, auth } = NextAuth({\r\n  providers: [GitHub],\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      // Add role to JWT on sign in\r\n      if (user) {\r\n        token.role = user.role\r\n      }\r\n      return token\r\n    },\r\n    async session({ session, token }) {\r\n      // Expose role to session\r\n      if (session.user) {\r\n        session.user.role = token.role\r\n      }\r\n      return session\r\n    },\r\n  },\r\n})\r\n```\r\n\r\n```typescript\r\n// middleware.ts\r\nimport { auth } from \"@/auth\"\r\nimport { NextResponse } from \"next/server\"\r\n\r\nexport default auth((req) => {\r\n  const { pathname } = req.nextUrl\r\n\r\n  // Protect /admin routes (require admin role)\r\n  if (pathname.startsWith(\"/admin\")) {\r\n    if (!req.auth || req.auth.user.role !== \"admin\") {\r\n      return NextResponse.redirect(new URL(\"/unauthorized\", req.url))\r\n    }\r\n  }\r\n\r\n  return NextResponse.next()\r\n})\r\n```\r\n\r\nSee `references/middleware-patterns.md` and `templates/advanced/role-based-access.ts` for complete examples.\r\n\r\n---",
    "Advanced Features": "### JWT Callbacks (Custom Claims)\r\n\r\n```typescript\r\nexport const { handlers, auth } = NextAuth({\r\n  providers: [GitHub],\r\n  callbacks: {\r\n    async jwt({ token, user, account }) {\r\n      // On sign in\r\n      if (user) {\r\n        token.id = user.id\r\n        token.role = user.role\r\n      }\r\n\r\n      // On subsequent requests\r\n      return token\r\n    },\r\n    async session({ session, token }) {\r\n      // Expose custom claims to session\r\n      session.user.id = token.id\r\n      session.user.role = token.role\r\n      return session\r\n    },\r\n  },\r\n})\r\n```\r\n\r\n### Token Refresh (OAuth)\r\n\r\n**Google OAuth with token refresh:**\r\n\r\n```typescript\r\nimport Google from \"next-auth/providers/google\"\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  providers: [\r\n    Google({\r\n      authorization: {\r\n        params: {\r\n          prompt: \"consent\",\r\n          access_type: \"offline\",\r\n          response_type: \"code\",\r\n        },\r\n      },\r\n    }),\r\n  ],\r\n  callbacks: {\r\n    async jwt({ token, account }) {\r\n      // First-time login, save tokens\r\n      if (account) {\r\n        return {\r\n          ...token,\r\n          access_token: account.access_token,\r\n          expires_at: account.expires_at,\r\n          refresh_token: account.refresh_token,\r\n        }\r\n      }\r\n\r\n      // Subsequent logins, check if token expired\r\n      if (Date.now() < token.expires_at * 1000) {\r\n        return token\r\n      }\r\n\r\n      // Token expired, refresh it\r\n      try {\r\n        const response = await fetch(\"https://oauth2.googleapis.com/token\", {\r\n          method: \"POST\",\r\n          body: new URLSearchParams({\r\n            client_id: process.env.AUTH_GOOGLE_ID!,\r\n            client_secret: process.env.AUTH_GOOGLE_SECRET!,\r\n            grant_type: \"refresh_token\",\r\n            refresh_token: token.refresh_token!,\r\n          }),\r\n        })\r\n\r\n        const newTokens = await response.json()\r\n\r\n        return {\r\n          ...token,\r\n          access_token: newTokens.access_token,\r\n          expires_at: Math.floor(Date.now() / 1000 + newTokens.expires_in),\r\n          refresh_token: newTokens.refresh_token ?? token.refresh_token,\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Token refresh error:\", error)\r\n        token.error = \"RefreshTokenError\"\r\n        return token\r\n      }\r\n    },\r\n    async session({ session, token }) {\r\n      session.error = token.error\r\n      return session\r\n    },\r\n  },\r\n})\r\n```\r\n\r\nSee `templates/advanced/jwt-refresh-tokens.ts` for complete example.\r\n\r\n---",
    "Templates Reference": "All templates are available in the `templates/` directory:\r\n\r\n### Next.js Templates (5)\r\n- **auth.ts** - Simple Next.js config (JWT sessions)\r\n- **auth.config.ts + auth.ts** - Split config (edge-compatible)\r\n- **multi-provider.ts** - OAuth + Credentials + Magic Links\r\n- **middleware.ts** - Session keep-alive + route protection\r\n- **package.json + .env.example** - Dependencies + environment\r\n\r\n### Cloudflare Workers Templates (3)\r\n- **worker-hono-auth.ts** - Complete Hono + Auth.js + D1\r\n- **wrangler.jsonc** - D1 binding configuration\r\n- **schema.sql** - D1 tables for Auth.js\r\n\r\n### Provider Templates (3)\r\n- **oauth-github-google.ts** - OAuth setup\r\n- **credentials.ts** - Email/password with Zod validation\r\n- **magic-link-resend.ts** - Passwordless email auth\r\n\r\n### Advanced Templates (2)\r\n- **jwt-refresh-tokens.ts** - Google token rotation example\r\n- **role-based-access.ts** - RBAC with custom claims\r\n\r\nCopy these files to your project and customize as needed.\r\n\r\n---",
    "Reference Documentation": "For deeper understanding, see:\r\n\r\n- **common-errors.md** - All 12 documented errors and fixes\r\n- **edge-compatibility.md** - Edge runtime compatibility matrix\r\n- **v5-migration-guide.md** - v4 → v5 breaking changes\r\n- **session-strategies.md** - JWT vs Database comparison\r\n- **middleware-patterns.md** - Route protection, RBAC\r\n- **jwt-customization.md** - Custom claims, token refresh\r\n- **provider-setup-guides.md** - OAuth app setup instructions\r\n\r\n---\r\n\r\n**Questions? Issues?**\r\n\r\n1. Check `references/common-errors.md` first\r\n2. Verify AUTH_SECRET is set\r\n3. Ensure you're not throwing in authorize()\r\n4. Check edge compatibility for your adapter\r\n5. Review official docs: https://authjs.dev",
    "Common Errors & Fixes": "```\r\n\r\n### 2. CallbackRouteError\r\n\r\n**Error:**\r\n```\r\nCallbackRouteError: Illegal arguments: string, undefined\r\n```\r\n\r\n**Cause:** Throwing errors in `authorize()` callback\r\n\r\n**Fix:**\r\n```typescript\r\n// WRONG\r\nauthorize: async (credentials) => {\r\n  if (!user) throw new Error(\"Invalid credentials\")\r\n}\r\n\r\n// CORRECT\r\nauthorize: async (credentials) => {\r\n  if (!user) return null\r\n  return user\r\n}\r\n```\r\n\r\n### 3. Route Not Found\r\n\r\n**Error:**\r\n```\r\nError: next-auth route not found\r\n```\r\n\r\n**Cause:** Incorrect file path for API route handler\r\n\r\n**Fix:**\r\n```typescript\r\n// Ensure file is at EXACT path:\r\n// app/api/auth/[...nextauth]/route.ts\r\n\r\nimport { handlers } from \"@/auth\"\r\nexport const { GET, POST } = handlers\r\n```\r\n\r\n### 4. Edge Compatibility Error\r\n\r\n**Error:**\r\n```\r\nModule not compatible with edge runtime\r\n```\r\n\r\n**Cause:** Using non-edge adapter with database session strategy\r\n\r\n**Fix:**\r\n```typescript\r\n// Option 1: Force JWT sessions\r\nexport const { handlers, auth } = NextAuth({\r\n  adapter: PrismaAdapter(prisma),\r\n  session: { strategy: \"jwt\" }, // ✅\r\n})\r\n\r\n// Option 2: Use edge-compatible adapter (D1)\r\nexport const { handlers, auth } = NextAuth({\r\n  adapter: D1Adapter(env.DB), // ✅ Edge-compatible\r\n  session: { strategy: \"database\" },\r\n})\r\n```\r\n\r\n### 5. Session Not Updating\r\n\r\n**Error:** Session expires but doesn't refresh\r\n\r\n**Cause:** Missing middleware\r\n\r\n**Fix:**\r\n```typescript\r\n// middleware.ts\r\nexport { auth as middleware } from \"@/auth\"\r\n\r\nexport const config = {\r\n  matcher: [\"/((?!api|_next/static|_next/image|favicon.ico).*)\"],\r\n}\r\n```\r\n\r\n### 6-12. More Errors\r\n\r\nSee `references/common-errors.md` for complete list of all 12 documented errors with fixes.\r\n\r\n---",
    "Provider Setup": "### OAuth Providers (GitHub, Google, etc.)\r\n\r\n**GitHub:**\r\n\r\n```typescript\r\nimport GitHub from \"next-auth/providers/github\"\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  providers: [\r\n    GitHub({\r\n      clientId: process.env.AUTH_GITHUB_ID,\r\n      clientSecret: process.env.AUTH_GITHUB_SECRET,\r\n    }),\r\n  ],\r\n})\r\n```\r\n\r\n**Google (with token refresh):**\r\n\r\n```typescript\r\nimport Google from \"next-auth/providers/google\"\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  providers: [\r\n    Google({\r\n      clientId: process.env.AUTH_GOOGLE_ID,\r\n      clientSecret: process.env.AUTH_GOOGLE_SECRET,\r\n      authorization: {\r\n        params: {\r\n          prompt: \"consent\",\r\n          access_type: \"offline\",\r\n          response_type: \"code\",\r\n        },\r\n      },\r\n    }),\r\n  ],\r\n})\r\n```\r\n\r\nSee `templates/providers/oauth-github-google.ts` for complete example.\r\n\r\n### Credentials Provider (Email/Password)\r\n\r\n**⚠️ CRITICAL:** The Credentials provider ONLY supports JWT sessions!\r\n\r\n```typescript\r\nimport Credentials from \"next-auth/providers/credentials\"\r\nimport { z } from \"zod\"\r\nimport bcrypt from \"bcryptjs\"\r\n\r\nconst signInSchema = z.object({\r\n  email: z.string().email(),\r\n  password: z.string().min(8),\r\n})\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  providers: [\r\n    Credentials({\r\n      credentials: {\r\n        email: { label: \"Email\", type: \"email\" },\r\n        password: { label: \"Password\", type: \"password\" },\r\n      },\r\n      authorize: async (credentials) => {\r\n        try {\r\n          const { email, password } = await signInSchema.parseAsync(credentials)\r\n\r\n          // Fetch user from database\r\n          const user = await db.user.findUnique({ where: { email } })\r\n\r\n          if (!user || !user.password) {\r\n            // CRITICAL: Return null, DON'T throw\r\n            return null\r\n          }\r\n\r\n          const passwordMatch = await bcrypt.compare(password, user.password)\r\n\r\n          if (!passwordMatch) {\r\n            return null\r\n          }\r\n\r\n          // Return user object\r\n          return {\r\n            id: user.id,\r\n            email: user.email,\r\n            name: user.name,\r\n          }\r\n        } catch (error) {\r\n          // CRITICAL: Return null on error, DON'T throw\r\n          console.error(\"Auth error:\", error)\r\n          return null\r\n        }\r\n      },\r\n    }),\r\n  ],\r\n})\r\n```\r\n\r\n**⚠️ CRITICAL RULES:**\r\n\r\n1. **NEVER throw errors** in `authorize()` - always return `null`\r\n2. **Why?** Throwing errors causes `CallbackRouteError` instead of `CredentialsSignin`\r\n3. **Always validate with Zod** before checking credentials\r\n4. **Hash passwords** with bcrypt, never store plain text\r\n\r\nSee `templates/providers/credentials.ts` for complete example.\r\n\r\n### Magic Link Provider (Passwordless)\r\n\r\n**⚠️ CRITICAL:** Magic links REQUIRE a database adapter!\r\n\r\n```typescript\r\nimport Resend from \"next-auth/providers/resend\"\r\nimport { PrismaAdapter } from \"@auth/prisma-adapter\"\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  adapter: PrismaAdapter(prisma), // REQUIRED\r\n  providers: [\r\n    Resend({\r\n      apiKey: process.env.AUTH_RESEND_KEY,\r\n      from: \"noreply@example.com\",\r\n    }),\r\n  ],\r\n})\r\n```\r\n\r\nSee `templates/providers/magic-link-resend.ts` for complete example.\r\n\r\n---",
    "⚠️ BEFORE YOU START (READ THIS!)": "**CRITICAL FOR AI AGENTS**: If you're Claude Code helping a user set up Auth.js:\r\n\r\n1. **Explicitly state you're using this skill** at the start of the conversation\r\n2. **Reference patterns from the skill** rather than general knowledge\r\n3. **Prevent known issues** listed in `references/common-errors.md`\r\n4. **Don't guess** - if unsure, check the skill documentation\r\n\r\n**USER ACTION REQUIRED**: Tell Claude to check this skill first!\r\n\r\nSay: **\"I'm setting up Auth.js - check the auth-js skill first\"**\r\n\r\n### Why This Matters (Real-World Results)\r\n\r\n**Without skill activation:**\r\n- ❌ Setup time: ~15 minutes\r\n- ❌ Errors encountered: 3-5 (AUTH_SECRET, CallbackRouteError, edge issues)\r\n- ❌ Manual fixes needed: 3-4 commits\r\n- ❌ Token usage: ~15k\r\n- ❌ User confidence: Multiple debugging sessions\r\n\r\n**With skill activation:**\r\n- ✅ Setup time: ~3 minutes\r\n- ✅ Errors encountered: 0\r\n- ✅ Manual fixes needed: 0\r\n- ✅ Token usage: ~6k (60% reduction)\r\n- ✅ User confidence: Instant success\r\n\r\n### Known Issues This Skill Prevents\r\n\r\n1. **Missing AUTH_SECRET** → JWEDecryptionFailed error\r\n2. **CallbackRouteError** → Throwing in authorize() instead of returning null\r\n3. **Route not found** → Incorrect file path for [...nextauth].js\r\n4. **Edge incompatibility** → Using database session without edge-compatible adapter\r\n5. **PKCE errors** → OAuth provider misconfiguration\r\n6. **Session not updating** → Missing middleware\r\n7. **v5 migration issues** → Namespace changes, JWT salt changes\r\n8. **D1 binding errors** → Wrangler configuration mismatch\r\n9. **Credentials with database** → Incompatible session strategy\r\n10. **Production deployment failures** → Missing environment variables\r\n11. **Token refresh errors** → Incorrect callback implementation\r\n12. **JSON expected but HTML received** → Rewrites configuration in Next.js 15\r\n\r\nAll of these are handled automatically when the skill is active.\r\n\r\n---",
    "Package Versions": "**Current (as of 2025-10-26):**\r\n\r\n```json\r\n{\r\n  \"next-auth\": \"4.24.11\",\r\n  \"@auth/core\": \"0.41.1\",\r\n  \"@auth/d1-adapter\": \"1.11.1\",\r\n  \"@auth/prisma-adapter\": \"2.7.5\",\r\n  \"next\": \"15.3.1\",\r\n  \"hono\": \"4.7.9\"\r\n}\r\n```\r\n\r\n**Always use latest versions:**\r\n```bash\r\nnpm install next-auth@latest @auth/core@latest\r\n```\r\n\r\n---",
    "Core Concepts": "### Session Strategies\r\n\r\nAuth.js v5 supports two session strategies:\r\n\r\n1. **JWT (JSON Web Token)** - Default when no adapter configured\r\n   - ✅ Works in edge runtime\r\n   - ✅ No database queries for sessions\r\n   - ✅ Fast and scalable\r\n   - ❌ Cannot invalidate sessions server-side\r\n   - ❌ Token size limits\r\n\r\n2. **Database** - Default when adapter configured\r\n   - ✅ Full session control (invalidate, extend)\r\n   - ✅ Audit trail in database\r\n   - ✅ No token size limits\r\n   - ❌ Requires database query per request\r\n   - ❌ Not compatible with all edge runtimes\r\n\r\n**Decision Matrix:**\r\n\r\n| Use Case | Recommended Strategy | Reason |\r\n|----------|---------------------|--------|\r\n| Next.js App Router | JWT | Edge runtime compatibility |\r\n| Cloudflare Workers | JWT or Database (with D1) | D1 is edge-compatible |\r\n| Traditional Node.js | Database | Full session control |\r\n| High security | Database | Can invalidate sessions |\r\n| Read-only sessions | JWT | No database overhead |\r\n\r\nSee `references/session-strategies.md` for detailed comparison.\r\n\r\n---",
    "Session Strategies": "### JWT Sessions (Default)\r\n\r\n**When to use:**\r\n- Edge runtime deployment (Cloudflare Workers, Vercel Edge)\r\n- No database adapter configured\r\n- Read-only session data\r\n- High-traffic applications (no DB queries)\r\n\r\n**Configuration:**\r\n\r\n```typescript\r\nexport const { handlers, auth } = NextAuth({\r\n  session: {\r\n    strategy: \"jwt\",\r\n    maxAge: 30 * 24 * 60 * 60, // 30 days\r\n  },\r\n  providers: [GitHub],\r\n})\r\n```\r\n\r\n**⚠️ CRITICAL:** Even if you have an adapter configured, you MUST explicitly set `strategy: \"jwt\"` for edge runtime compatibility!\r\n\r\n### Database Sessions\r\n\r\n**When to use:**\r\n- Node.js runtime (not edge)\r\n- Need to invalidate sessions server-side\r\n- Compliance requirements (audit trail)\r\n- Session data larger than JWT limits\r\n\r\n**Configuration:**\r\n\r\n```typescript\r\nimport { PrismaAdapter } from \"@auth/prisma-adapter\"\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  adapter: PrismaAdapter(prisma),\r\n  session: {\r\n    strategy: \"database\",\r\n    maxAge: 30 * 24 * 60 * 60,\r\n    updateAge: 24 * 60 * 60, // Update session every 24 hours\r\n  },\r\n  providers: [GitHub],\r\n})\r\n```\r\n\r\n**⚠️ Edge Runtime Limitation:**\r\n\r\nIf your adapter is NOT edge-compatible, you CANNOT use database sessions in edge runtime (middleware). Split your config:\r\n\r\n```typescript\r\n// auth.config.ts (edge-compatible)\r\nexport default {\r\n  providers: [GitHub],\r\n} satisfies NextAuthConfig\r\n\r\n// auth.ts (full config with database)\r\nimport authConfig from \"./auth.config\"\r\n\r\nexport const { handlers, auth } = NextAuth({\r\n  adapter: PrismaAdapter(prisma), // Not edge-compatible\r\n  session: { strategy: \"jwt\" }, // FORCE JWT for middleware\r\n  ...authConfig,\r\n})\r\n```\r\n\r\n---",
    "Critical Rules": "### ✅ Always Do:\r\n\r\n1. **Set AUTH_SECRET in production**\r\n   ```bash\r\n   # Generate secret\r\n   npx auth secret\r\n\r\n   # Add to .env.local\r\n   AUTH_SECRET=your-generated-secret\r\n   ```\r\n\r\n2. **Return `null` (not throw) in Credentials authorize()**\r\n   ```typescript\r\n   authorize: async (credentials) => {\r\n     if (!validUser) {\r\n       return null // ✅ Correct\r\n       // throw new Error(\"Invalid\") // ❌ WRONG - causes CallbackRouteError\r\n     }\r\n   }\r\n   ```\r\n\r\n3. **Use adapter for Magic Links**\r\n   ```typescript\r\n   export const { handlers, auth } = NextAuth({\r\n     adapter: PrismaAdapter(prisma), // REQUIRED for magic links\r\n     providers: [Resend],\r\n   })\r\n   ```\r\n\r\n4. **Split config for edge compatibility**\r\n   ```typescript\r\n   // auth.config.ts (edge-compatible)\r\n   export default { providers: [GitHub] }\r\n\r\n   // auth.ts (full config with database)\r\n   export const { handlers, auth } = NextAuth({\r\n     adapter: PrismaAdapter(prisma),\r\n     session: { strategy: \"jwt\" }, // Force JWT for edge\r\n     ...authConfig,\r\n   })\r\n   ```\r\n\r\n5. **Force JWT sessions when using non-edge adapter**\r\n   ```typescript\r\n   export const { handlers, auth } = NextAuth({\r\n     adapter: PrismaAdapter(prisma), // Not edge-compatible\r\n     session: { strategy: \"jwt\" }, // CRITICAL\r\n   })\r\n   ```\r\n\r\n### ❌ Never Do:\r\n\r\n1. **Deploy without AUTH_SECRET**\r\n   ```typescript\r\n   // WRONG - will fail in production\r\n   // Missing AUTH_SECRET environment variable\r\n   ```\r\n\r\n2. **Throw errors in authorize()**\r\n   ```typescript\r\n   authorize: async (credentials) => {\r\n     throw new Error(\"Invalid credentials\") // ❌ Causes CallbackRouteError\r\n   }\r\n   ```\r\n\r\n3. **Use deprecated @next-auth/* adapters**\r\n   ```bash\r\n   npm install @next-auth/prisma-adapter  # ❌ Deprecated\r\n   npm install @auth/prisma-adapter       # ✅ Correct (v5)\r\n   ```\r\n\r\n4. **Use database session without edge-compatible adapter in middleware**\r\n   ```typescript\r\n   // WRONG - Prisma not edge-compatible\r\n   export const { handlers, auth } = NextAuth({\r\n     adapter: PrismaAdapter(prisma),\r\n     session: { strategy: \"database\" }, // ❌ Fails in middleware\r\n   })\r\n   ```\r\n\r\n5. **Mix v4 and v5 packages**\r\n   ```bash\r\n   npm install next-auth@4.x @auth/core@0.x  # ❌ Version mismatch\r\n   ```\r\n\r\n---",
    "Quick Start: Next.js": "```\r\n\r\n### 5. Use in Components\r\n\r\n**Server Component (App Router):**\r\n\r\n```tsx\r\nimport { auth } from \"@/auth\"\r\n\r\nexport default async function Dashboard() {\r\n  const session = await auth()\r\n\r\n  if (!session?.user) {\r\n    return <p>Not authenticated</p>\r\n  }\r\n\r\n  return <p>Welcome {session.user.name}</p>\r\n}\r\n```\r\n\r\n**Client Component:**\r\n\r\n```tsx\r\n\"use client\"\r\nimport { useSession } from \"next-auth/react\"\r\n\r\nexport default function ClientDashboard() {\r\n  const { data: session, status } = useSession()\r\n\r\n  if (status === \"loading\") return <p>Loading...</p>\r\n  if (status === \"unauthenticated\") return <p>Not authenticated</p>\r\n\r\n  return <p>Welcome {session?.user?.name}</p>\r\n}\r\n```\r\n\r\n### 6. Sign In / Sign Out\r\n\r\n```tsx\r\nimport { signIn, signOut } from \"@/auth\"\r\n\r\nexport function SignIn() {\r\n  return (\r\n    <form\r\n      action={async () => {\r\n        \"use server\"\r\n        await signIn(\"github\")\r\n      }}\r\n    >\r\n      <button type=\"submit\">Sign in with GitHub</button>\r\n    </form>\r\n  )\r\n}\r\n\r\nexport function SignOut() {\r\n  return (\r\n    <form\r\n      action={async () => {\r\n        \"use server\"\r\n        await signOut()\r\n      }}\r\n    >\r\n      <button type=\"submit\">Sign Out</button>\r\n    </form>\r\n  )\r\n}\r\n```\r\n\r\n---",
    "Official Documentation": "- **Auth.js Docs**: https://authjs.dev\r\n- **Getting Started**: https://authjs.dev/getting-started/installation\r\n- **Providers**: https://authjs.dev/getting-started/providers/oauth\r\n- **Adapters**: https://authjs.dev/getting-started/adapters\r\n- **D1 Adapter**: https://authjs.dev/getting-started/adapters/d1\r\n- **v5 Migration**: https://authjs.dev/getting-started/migrating-to-v5\r\n- **Edge Compatibility**: https://authjs.dev/guides/edge-compatibility\r\n\r\n---"
  }
}
{
  "sections": {
    "Using auth-route-tester Agent": "For comprehensive route testing after making changes:\r\n\r\n1. **Identify affected routes**\r\n2. **Gather route information**:\r\n   - Full route path (with prefix)\r\n   - Expected POST data\r\n   - Tables to verify\r\n3. **Invoke auth-route-tester agent**\r\n\r\nThe agent will:\r\n- Test the route with proper authentication\r\n- Verify database changes\r\n- Check response format\r\n- Report any issues",
    "Testing Methods": "MOCK_AUTH=true\r\nMOCK_USER_ID=test-user\r\nMOCK_USER_ROLES=admin,operations\r\n```\r\n\r\n#### Usage\r\n\r\n```bash\r\ncurl -H \"X-Mock-Auth: true\" \\\r\n     -H \"X-Mock-User: test-user\" \\\r\n     -H \"X-Mock-Roles: admin,operations\" \\\r\n     http://localhost:3002/api/protected\r\n```\r\n\r\n#### Mock Auth Requirements\r\n\r\nMock auth ONLY works when:\r\n- `NODE_ENV` is `development` or `test`\r\n- The `mockAuth` middleware is added to the route\r\n- Will NEVER work in production (security feature)",
    "Purpose": "This skill provides patterns for testing authenticated routes in the your project using cookie-based JWT authentication.",
    "Related Skills": "- Use **database-verification** to verify database changes\r\n- Use **error-tracking** to check for captured errors\r\n- Use **workflow-builder** for workflow route testing\r\n- Use **notification-sender** to verify notifications sent",
    "Testing Checklist": "Before testing a route:\r\n\r\n- [ ] Identify the service (form, email, users, etc.)\r\n- [ ] Find the correct port\r\n- [ ] Check route prefixes in `app.ts`\r\n- [ ] Construct the full URL\r\n- [ ] Prepare request body (if POST/PUT)\r\n- [ ] Determine authentication method\r\n- [ ] Run the test\r\n- [ ] Verify response status and data\r\n- [ ] Check database changes if applicable",
    "Verifying Database Changes": "mysql> SELECT * FROM WorkflowInstance WHERE id = 123;\r\nmysql> SELECT * FROM WorkflowStepInstance WHERE instanceId = 123;\r\nmysql> SELECT * FROM WorkflowNotification WHERE recipientUserId = 'user-123';\r\n```",
    "Configuration Files": "### config.ini (each service)\r\n\r\n```ini\r\n[keycloak]\r\nurl = http://localhost:8081\r\nrealm = yourRealm\r\nclientId = app-client\r\n\r\n[jwt]\r\njwtSecret = your-jwt-secret-here\r\n```\r\n\r\n### .env (each service)\r\n\r\n```bash\r\nNODE_ENV=development\r\nMOCK_AUTH=true           # Optional: Enable mock auth\r\nMOCK_USER_ID=test-user   # Optional: Default mock user\r\nMOCK_USER_ROLES=admin    # Optional: Default mock roles\r\n```",
    "When to Use This Skill": "- Testing new API endpoints\r\n- Validating route functionality after changes\r\n- Debugging authentication issues\r\n- Testing POST/PUT/DELETE operations\r\n- Verifying request/response data",
    "your project Authentication Overview": "The your project uses:\r\n- **Keycloak** for SSO (realm: yourRealm)\r\n- **Cookie-based JWT** tokens (not Bearer headers)\r\n- **Cookie name**: `refresh_token`\r\n- **JWT signing**: Using secret from `config.ini`",
    "Key Files": "- `/root/git/your project_pre/scripts/test-auth-route.js` - Main testing script\r\n- `/blog-api/src/app.ts` - Form service routes\r\n- `/notifications/src/app.ts` - Email service routes\r\n- `/auth/src/app.ts` - Users service routes\r\n- `/config.ini` - Service configuration\r\n- `/.env` - Environment variables",
    "Service Ports": "| Service | Port | Base URL |\r\n|---------|------|----------|\r\n| Users   | 3000 | http://localhost:3000 |\r\n| Projects| 3001 | http://localhost:3001 |\r\n| Form    | 3002 | http://localhost:3002 |\r\n| Email   | 3003 | http://localhost:3003 |\r\n| Uploads | 5000 | http://localhost:5000 |",
    "Common Testing Patterns": "curl -X POST http://localhost:5000/upload \\\r\n  -H \"Content-Type: multipart/form-data\" \\\r\n  -b \"refresh_token=<TOKEN>\" \\\r\n  -F \"file=@/path/to/file.pdf\" \\\r\n  -F \"metadata={\\\"description\\\":\\\"Test file\\\"}\"\r\n```",
    "Hardcoded Test Credentials": "The `test-auth-route.js` script uses these credentials:\r\n\r\n- **Username**: `testuser`\r\n- **Password**: `testpassword`\r\n- **Keycloak URL**: From `config.ini` (usually `http://localhost:8081`)\r\n- **Realm**: `yourRealm`\r\n- **Client ID**: From `config.ini`",
    "Example Test Scenarios": "```",
    "Debugging Failed Tests": "curl -H \"X-Mock-Auth: true\" \\\r\n     -H \"X-Mock-User: test-admin\" \\\r\n     -H \"X-Mock-Roles: admin\" \\\r\n     http://localhost:3002/api/protected\r\n```\r\n\r\n### 404 Not Found\r\n\r\n**Possible causes**:\r\n1. Incorrect URL\r\n2. Missing route prefix\r\n3. Route not registered\r\n\r\n**Solutions**:\r\n1. Check `app.ts` for route prefixes\r\n2. Verify route registration\r\n3. Check service is running (`pm2 list`)\r\n\r\n### 500 Internal Server Error\r\n\r\n**Possible causes**:\r\n1. Database connection issue\r\n2. Missing required fields\r\n3. Validation error\r\n4. Application error\r\n\r\n**Solutions**:\r\n1. Check service logs (`pm2 logs <service>`)\r\n2. Check Sentry for error details\r\n3. Verify request body matches expected schema\r\n4. Check database connectivity",
    "Route Prefixes": "Check `/src/app.ts` in each service for route prefixes:\r\n\r\n```typescript\r\n// Example from blog-api/src/app.ts\r\napp.use('/blog-api/api', formRoutes);          // Prefix: /blog-api/api\r\napp.use('/api/workflow', workflowRoutes);  // Prefix: /api/workflow\r\n```\r\n\r\n**Full Route** = Base URL + Prefix + Route Path\r\n\r\nExample:\r\n- Base: `http://localhost:3002`\r\n- Prefix: `/form`\r\n- Route: `/777/submit`\r\n- **Full URL**: `http://localhost:3000/blog-api/777/submit`"
  },
  "content": "### Method 1: test-auth-route.js (RECOMMENDED)\r\n\r\nThe `test-auth-route.js` script handles all authentication complexity automatically.\r\n\r\n**Location**: `/root/git/your project_pre/scripts/test-auth-route.js`\r\n\r\n#### Basic GET Request\r\n\r\n```bash\r\nnode scripts/test-auth-route.js http://localhost:3000/blog-api/api/endpoint\r\n```\r\n\r\n#### POST Request with JSON Data\r\n\r\n```bash\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3000/blog-api/777/submit \\\r\n    POST \\\r\n    '{\"responses\":{\"4577\":\"13295\"},\"submissionID\":5,\"stepInstanceId\":\"11\"}'\r\n```\r\n\r\n#### What the Script Does\r\n\r\n1. Gets a refresh token from Keycloak\r\n   - Username: `testuser`\r\n   - Password: `testpassword`\r\n2. Signs the token with JWT secret from `config.ini`\r\n3. Creates cookie header: `refresh_token=<signed-token>`\r\n4. Makes the authenticated request\r\n5. Shows the exact curl command to reproduce manually\r\n\r\n#### Script Output\r\n\r\nThe script outputs:\r\n- The request details\r\n- The response status and body\r\n- A curl command for manual reproduction\r\n\r\n**Note**: The script is verbose - look for the actual response in the output.\r\n\r\n### Method 2: Manual curl with Token\r\n\r\nUse the curl command from the test-auth-route.js output:\r\n\r\n```bash\r\n\r\ncurl -X POST http://localhost:3000/blog-api/777/submit \\\r\n  -H \"Content-Type: application/json\" \\\r\n  -b \"refresh_token=<COPY_TOKEN_FROM_SCRIPT_OUTPUT>\" \\\r\n  -d '{\"your\": \"data\"}'\r\n```\r\n\r\n### Method 3: Mock Authentication (Development Only - EASIEST)\r\n\r\nFor development, bypass Keycloak entirely using mock auth.\r\n\r\n#### Setup\r\n\r\n```bash\r\n\r\n### Test Form Submission\r\n\r\n```bash\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3000/blog-api/777/submit \\\r\n    POST \\\r\n    '{\"responses\":{\"4577\":\"13295\"},\"submissionID\":5,\"stepInstanceId\":\"11\"}'\r\n```\r\n\r\n### Test Workflow Start\r\n\r\n```bash\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3002/api/workflow/start \\\r\n    POST \\\r\n    '{\"workflowCode\":\"DHS_CLOSEOUT\",\"entityType\":\"Submission\",\"entityID\":123}'\r\n```\r\n\r\n### Test Workflow Step Completion\r\n\r\n```bash\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3002/api/workflow/step/complete \\\r\n    POST \\\r\n    '{\"stepInstanceID\":789,\"answers\":{\"decision\":\"approved\",\"comments\":\"Looks good\"}}'\r\n```\r\n\r\n### Test GET with Query Parameters\r\n\r\n```bash\r\nnode scripts/test-auth-route.js \\\r\n    \"http://localhost:3002/api/workflows?status=active&limit=10\"\r\n```\r\n\r\n### Test File Upload\r\n\r\n```bash\r\n\r\nAfter testing routes that modify data:\r\n\r\n```bash\r\ndocker exec -it local-mysql mysql -u root -p blog_dev\r\n\r\nexport MYSQL_PWD=$(read -s -p \"Enter MySQL root password: \" && echo \"$REPLY\")\r\ndocker exec -i -e MYSQL_PWD=$MYSQL_PWD local-mysql mysql -u root blog_dev\r\nunset MYSQL_PWD\r\n\r\n\r\n### 401 Unauthorized\r\n\r\n**Possible causes**:\r\n1. Token expired (regenerate with test-auth-route.js)\r\n2. Incorrect cookie format\r\n3. JWT secret mismatch\r\n4. Keycloak not running\r\n\r\n**Solutions**:\r\n```bash\r\ndocker ps | grep keycloak\r\n\r\nnode scripts/test-auth-route.js http://localhost:3002/api/health\r\n\r\n```\r\n\r\n### 403 Forbidden\r\n\r\n**Possible causes**:\r\n1. User lacks required role\r\n2. Resource permissions incorrect\r\n3. Route requires specific permissions\r\n\r\n**Solutions**:\r\n```bash\r\n\r\n### After Creating a New Route\r\n\r\n```bash\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3002/api/my-new-route \\\r\n    POST \\\r\n    '{\"field1\":\"value1\",\"field2\":\"value2\"}'\r\n\r\ndocker exec -i local-mysql mysql -u root -ppassword1 blog_dev \\\r\n    -e \"SELECT * FROM MyTable ORDER BY createdAt DESC LIMIT 1;\"\r\n\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3002/api/my-new-route \\\r\n    POST \\\r\n    '{\"field1\":\"invalid\"}'\r\n\r\ncurl http://localhost:3002/api/my-new-route\r\n```\r\n\r\n### After Modifying a Route\r\n\r\n```bash\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3002/api/existing-route \\\r\n    POST \\\r\n    '{\"existing\":\"data\"}'\r\n\r\nnode scripts/test-auth-route.js \\\r\n    http://localhost:3002/api/existing-route \\\r\n    POST \\\r\n    '{\"new\":\"field\",\"existing\":\"data\"}'",
  "id": "route-tester_diet103",
  "name": "route-tester",
  "description": "Test authenticated routes in the your project using cookie-based authentication. Use this skill when testing API endpoints, validating route functionality, or debugging authentication issues. Includes patterns for using test-auth-route.js and mock authentication."
}
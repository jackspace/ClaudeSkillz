{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/feature-support.md",
      "references/troubleshooting.md"
    ]
  },
  "content": "Deploy Next.js applications to Cloudflare Workers using the OpenNext Cloudflare adapter for production-ready serverless Next.js hosting.\r\n\r\n\r\n### Dual Testing Strategy\r\n\r\n**Always test in BOTH environments**:\r\n\r\n1. **Next.js Dev Server** (`npm run dev`)\r\n   - Fast hot reloading\r\n   - Best developer experience\r\n   - Runs in Node.js (not production runtime)\r\n   - Use for rapid iteration\r\n\r\n2. **Workerd Runtime** (`npm run preview`)\r\n   - Runs in production-like environment\r\n   - Catches runtime-specific issues\r\n   - Slower rebuild times\r\n   - **Required before deployment**\r\n\r\n### When to Use Each\r\n\r\n```bash\r\nnpm run dev\r\n\r\nnpm run preview\r\n\r\nnpm run preview\r\n\r\n\r\n### 1. Worker Size Limit Exceeded (3 MiB - Free Plan)\r\n\r\n**Error**: `\"Your Worker exceeded the size limit of 3 MiB\"`\r\n\r\n**Cause**: Workers Free plan limits Worker size to 3 MiB (gzip-compressed)\r\n\r\n**Solutions**:\r\n- Upgrade to Workers Paid plan (10 MiB limit)\r\n- Analyze bundle size and remove unused dependencies\r\n- Use dynamic imports to code-split large dependencies\r\n\r\n**Bundle analysis**:\r\n```bash\r\nnpx opennextjs-cloudflare build\r\ncd .open-next/server-functions/default\r\n\r\n### Deploy from Local Machine\r\n\r\n```bash\r\nnpm run deploy\r\n\r\n\r\n### Local Testing (Development)\r\n\r\n```bash\r\nnpm run dev\r\n```\r\n\r\n### Local Testing (Production-like)\r\n\r\n```bash\r\nnpm run preview\r\n```\r\n\r\n### Integration Testing\r\n\r\nAlways test in `preview` mode before deploying:\r\n\r\n```bash\r\nnpm run preview\r\n\r\n\r\n### Essential Commands\r\n\r\n```bash\r\nnpm create cloudflare@latest -- my-next-app --framework=next\r\n\r\nnpm run dev      # Fast iteration (Next.js dev server)\r\nnpm run preview  # Test in workerd (production-like)\r\n\r\nnpm run deploy   # Build and deploy to Cloudflare",
  "name": "cloudflare-nextjs",
  "id": "cloudflare-nextjs",
  "sections": {
    "Migration from Other Platforms": "### From Vercel\r\n\r\n1. Copy existing Next.js project\r\n2. Run existing project migration steps (above)\r\n3. Update environment variables in Cloudflare dashboard\r\n4. Replace Vercel-specific features:\r\n   - Vercel Postgres → Cloudflare D1\r\n   - Vercel Blob → Cloudflare R2\r\n   - Vercel KV → Cloudflare KV\r\n   - Vercel Edge Config → Cloudflare KV\r\n5. Test thoroughly with `npm run preview`\r\n6. Deploy with `npm run deploy`\r\n\r\n### From AWS / Other Platforms\r\n\r\nSame process as Vercel migration - the adapter handles Next.js standard features automatically.",
    "Configuration Requirements": "### Wrangler Configuration\r\n\r\n**Minimum requirements** in `wrangler.jsonc`:\r\n\r\n```jsonc\r\n{\r\n  \"name\": \"your-app-name\",\r\n  \"compatibility_date\": \"2025-05-05\",  // Minimum for FinalizationRegistry\r\n  \"compatibility_flags\": [\"nodejs_compat\"]  // Required for Node.js runtime\r\n}\r\n```\r\n\r\n### Environment Variables for Package Exports\r\n\r\nIf using npm packages with multiple export conditions, create `.env`:\r\n\r\n```env\r\nWRANGLER_BUILD_CONDITIONS=\"\"\r\nWRANGLER_BUILD_PLATFORM=\"node\"\r\n```\r\n\r\nThis ensures Wrangler prioritizes the `node` export when available.\r\n\r\n### Cloudflare Bindings Integration\r\n\r\nAdd bindings in `wrangler.jsonc`:\r\n\r\n```jsonc\r\n{\r\n  \"name\": \"your-app-name\",\r\n  \"compatibility_date\": \"2025-05-05\",\r\n  \"compatibility_flags\": [\"nodejs_compat\"],\r\n\r\n  // D1 Database\r\n  \"d1_databases\": [\r\n    {\r\n      \"binding\": \"DB\",\r\n      \"database_name\": \"production-db\",\r\n      \"database_id\": \"your-database-id\"\r\n    }\r\n  ],\r\n\r\n  // R2 Storage\r\n  \"r2_buckets\": [\r\n    {\r\n      \"binding\": \"BUCKET\",\r\n      \"bucket_name\": \"your-bucket\"\r\n    }\r\n  ],\r\n\r\n  // KV Storage\r\n  \"kv_namespaces\": [\r\n    {\r\n      \"binding\": \"KV\",\r\n      \"id\": \"your-kv-id\"\r\n    }\r\n  ],\r\n\r\n  // Workers AI\r\n  \"ai\": {\r\n    \"binding\": \"AI\"\r\n  }\r\n}\r\n```\r\n\r\nAccess bindings in Next.js via `process.env`:\r\n\r\n```typescript\r\n// app/api/route.ts\r\nimport type { NextRequest } from 'next/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  // Access Cloudflare bindings\r\n  const env = process.env as any;\r\n\r\n  // D1 Database query\r\n  const result = await env.DB.prepare('SELECT * FROM users').all();\r\n\r\n  // R2 Storage access\r\n  const file = await env.BUCKET.get('file.txt');\r\n\r\n  // KV Storage access\r\n  const value = await env.KV.get('key');\r\n\r\n  // Workers AI inference\r\n  const response = await env.AI.run('@cf/meta/llama-3-8b-instruct', {\r\n    prompt: 'Hello AI'\r\n  });\r\n\r\n  return Response.json({ result });\r\n}\r\n```",
    "Setup Patterns": "### New Project Setup\r\n\r\nUse Cloudflare's `create-cloudflare` (C3) CLI to scaffold a new Next.js project pre-configured for Workers:\r\n\r\n```bash\r\nnpm create cloudflare@latest -- my-next-app --framework=next\r\n```\r\n\r\n**What this does**:\r\n1. Runs Next.js official setup tool (`create-next-app`)\r\n2. Installs `@opennextjs/cloudflare` adapter\r\n3. Creates `wrangler.jsonc` with correct configuration\r\n4. Creates `open-next.config.ts` for caching configuration\r\n5. Adds deployment scripts to `package.json`\r\n6. Optionally deploys immediately to Cloudflare\r\n\r\n**Development workflow**:\r\n```bash\r\nnpm run dev      # Next.js dev server (fast reloads)\r\nnpm run preview  # Test in workerd runtime (production-like)\r\nnpm run deploy   # Build and deploy to Cloudflare\r\n```\r\n\r\n### Existing Project Migration\r\n\r\nTo add the OpenNext adapter to an existing Next.js application:\r\n\r\n#### 1. Install the adapter\r\n\r\n```bash\r\nnpm install --save-dev @opennextjs/cloudflare\r\n```\r\n\r\n#### 2. Create wrangler.jsonc\r\n\r\n```jsonc\r\n{\r\n  \"name\": \"my-next-app\",\r\n  \"compatibility_date\": \"2025-05-05\",\r\n  \"compatibility_flags\": [\"nodejs_compat\"]\r\n}\r\n```\r\n\r\n**Critical configuration**:\r\n- `compatibility_date`: **Minimum `2025-05-05`** (for FinalizationRegistry support)\r\n- `compatibility_flags`: **Must include `nodejs_compat`** (for Node.js runtime)\r\n\r\n#### 3. Create open-next.config.ts\r\n\r\n```typescript\r\nimport { defineCloudflareConfig } from \"@opennextjs/cloudflare\";\r\n\r\nexport default defineCloudflareConfig({\r\n  // Caching configuration (optional)\r\n  // See: https://opennext.js.org/cloudflare/caching\r\n});\r\n```\r\n\r\n#### 4. Update package.json scripts\r\n\r\n```json\r\n{\r\n  \"scripts\": {\r\n    \"dev\": \"next dev\",\r\n    \"build\": \"next build\",\r\n    \"preview\": \"opennextjs-cloudflare build && opennextjs-cloudflare preview\",\r\n    \"deploy\": \"opennextjs-cloudflare build && opennextjs-cloudflare deploy\",\r\n    \"cf-typegen\": \"wrangler types --env-interface CloudflareEnv cloudflare-env.d.ts\"\r\n  }\r\n}\r\n```\r\n\r\n**Script purposes**:\r\n- `dev`: Next.js development server (fast iteration)\r\n- `preview`: Build + run in workerd runtime (test before deploy)\r\n- `deploy`: Build + deploy to Cloudflare\r\n- `cf-typegen`: Generate TypeScript types for Cloudflare bindings\r\n\r\n#### 5. Ensure Node.js runtime (not Edge)\r\n\r\nRemove Edge runtime exports from your app:\r\n\r\n```typescript\r\n// ❌ REMOVE THIS (Edge runtime not supported)\r\nexport const runtime = \"edge\";\r\n\r\n// ✅ Use Node.js runtime (default)\r\n// No export needed - Node.js is default\r\n```",
    "Key Concepts": "### OpenNext Adapter Architecture\r\n\r\nThe **OpenNext Cloudflare adapter** (`@opennextjs/cloudflare`) transforms Next.js build output into Cloudflare Worker-compatible format. This is fundamentally different from standard Next.js deployments:\r\n\r\n- **Node.js Runtime Required**: Uses Node.js runtime in Workers (NOT Edge runtime)\r\n- **Dual Development Workflow**: Test in both Next.js dev server AND workerd runtime\r\n- **Custom Build Pipeline**: `next build` → OpenNext transformation → Worker deployment\r\n- **Cloudflare-Specific Configuration**: Requires wrangler.jsonc and open-next.config.ts\r\n\r\n### Critical Differences from Standard Next.js\r\n\r\n| Aspect | Standard Next.js | Cloudflare Workers |\r\n|--------|------------------|-------------------|\r\n| Runtime | Node.js or Edge | Node.js (via nodejs_compat) |\r\n| Dev Server | `next dev` | `next dev` + `opennextjs-cloudflare preview` |\r\n| Deployment | Platform-specific | `opennextjs-cloudflare deploy` |\r\n| Worker Size | No limit | 3 MiB (free) / 10 MiB (paid) |\r\n| Database Connections | Global clients OK | Must be request-scoped |\r\n| Image Optimization | Built-in | Via Cloudflare Images |\r\n| Caching | Next.js cache | OpenNext config + Workers cache |",
    "TypeScript Support": "Generate types for Cloudflare bindings:\r\n\r\n```bash\r\nnpm run cf-typegen\r\n```\r\n\r\nCreates `cloudflare-env.d.ts` with types for your bindings:\r\n\r\n```typescript\r\n// cloudflare-env.d.ts (auto-generated)\r\ninterface CloudflareEnv {\r\n  DB: D1Database;\r\n  BUCKET: R2Bucket;\r\n  KV: KVNamespace;\r\n  AI: Ai;\r\n}\r\n```\r\n\r\nUse in route handlers:\r\n\r\n```typescript\r\nimport type { NextRequest } from 'next/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const env = process.env as CloudflareEnv;\r\n  // Now env.DB, env.BUCKET, etc. are typed\r\n}\r\n```",
    "Feature Support Matrix": "| Feature | Status | Notes |\r\n|---------|--------|-------|\r\n| **App Router** | ✅ Fully Supported | Latest App Router features work |\r\n| **Pages Router** | ✅ Fully Supported | Legacy Pages Router supported |\r\n| **Route Handlers** | ✅ Fully Supported | API routes work as expected |\r\n| **React Server Components** | ✅ Fully Supported | RSC fully functional |\r\n| **Server Actions** | ✅ Fully Supported | Server Actions work |\r\n| **SSG** | ✅ Fully Supported | Static Site Generation |\r\n| **SSR** | ✅ Fully Supported | Server-Side Rendering |\r\n| **ISR** | ✅ Fully Supported | Incremental Static Regeneration |\r\n| **Middleware** | ✅ Supported | Except Node.js middleware (15.2+) |\r\n| **Image Optimization** | ✅ Supported | Via Cloudflare Images |\r\n| **Partial Prerendering (PPR)** | ✅ Supported | Experimental in Next.js |\r\n| **Composable Caching** | ✅ Supported | `'use cache'` directive |\r\n| **Response Streaming** | ✅ Supported | Streaming responses work |\r\n| **`next/after` API** | ✅ Supported | Post-response async work |\r\n| **Node.js Middleware (15.2+)** | ❌ Not Supported | Future support planned |\r\n| **Edge Runtime** | ❌ Not Supported | Use Node.js runtime |\r\n\r\n**Source**: https://developers.cloudflare.com/workers/framework-guides/web-apps/nextjs/#next-js-supported-features",
    "Testing": "```",
    "Image Optimization": "Next.js image optimization works via Cloudflare Images. Configure in `open-next.config.ts`:\r\n\r\n```typescript\r\nimport { defineCloudflareConfig } from \"@opennextjs/cloudflare\";\r\n\r\nexport default defineCloudflareConfig({\r\n  imageOptimization: {\r\n    loader: 'cloudflare'\r\n  }\r\n});\r\n```\r\n\r\nUsage in components:\r\n\r\n```tsx\r\nimport Image from 'next/image';\r\n\r\nexport default function Avatar() {\r\n  return (\r\n    <Image\r\n      src=\"/avatar.jpg\"\r\n      alt=\"User avatar\"\r\n      width={200}\r\n      height={200}\r\n      // Automatically optimized via Cloudflare Images\r\n    />\r\n  );\r\n}\r\n```\r\n\r\n**Billing**: Cloudflare Images usage is billed separately\r\n\r\n**Docs**: https://developers.cloudflare.com/images/",
    "Deployment": "npx opennextjs-cloudflare build\r\nnpx opennextjs-cloudflare deploy\r\n```\r\n\r\n### Deploy from CI/CD\r\n\r\nConfigure deployment command in your CI/CD system:\r\n\r\n```bash\r\nnpm run deploy\r\n```\r\n\r\n**Examples**:\r\n- GitHub Actions: `.github/workflows/deploy.yml`\r\n- GitLab CI: `.gitlab-ci.yml`\r\n- Cloudflare Workers Builds: Auto-detects `npm run deploy`\r\n\r\n**Environment variables**: Set secrets in Cloudflare dashboard or CI/CD system\r\n\r\n### Custom Domains\r\n\r\nAdd custom domain in Cloudflare dashboard:\r\n\r\n1. Navigate to Workers & Pages\r\n2. Select your Worker\r\n3. Settings → Domains & Routes\r\n4. Add custom domain\r\n\r\n**DNS**: Domain must be on Cloudflare (zone required)",
    "Development Workflow": "npm run deploy\r\n```",
    "Known Limitations": "### Not Yet Supported\r\n\r\n1. **Node.js Middleware (Next.js 15.2+)**\r\n   - Introduced in Next.js 15.2\r\n   - Support planned for future releases\r\n   - Use standard middleware for now\r\n\r\n2. **Edge Runtime**\r\n   - Only Node.js runtime supported\r\n   - Remove `export const runtime = \"edge\"` from your app\r\n\r\n3. **Full Windows Support**\r\n   - Development on Windows not fully guaranteed\r\n   - Use WSL, VM, or Linux-based CI/CD\r\n\r\n### Worker Size Constraints\r\n\r\n- **Free plan**: 3 MiB limit (gzip-compressed)\r\n- **Paid plan**: 10 MiB limit (gzip-compressed)\r\n- Monitor bundle size during development\r\n- Use dynamic imports for code splitting\r\n\r\n### Database Connections\r\n\r\n- External database clients (PostgreSQL, MySQL) must be request-scoped\r\n- Cannot reuse connections across requests (Workers limitation)\r\n- Prefer Cloudflare D1 for database needs (designed for Workers)",
    "Resources": "### Official Documentation\r\n- **OpenNext Cloudflare**: https://opennext.js.org/cloudflare\r\n- **Cloudflare Next.js Guide**: https://developers.cloudflare.com/workers/framework-guides/web-apps/nextjs/\r\n- **Next.js Docs**: https://nextjs.org/docs\r\n\r\n### Troubleshooting\r\n- **Troubleshooting Guide**: https://opennext.js.org/cloudflare/troubleshooting\r\n- **Known Issues**: https://opennext.js.org/cloudflare/known-issues\r\n- **GitHub Issues**: https://github.com/opennextjs/opennextjs-cloudflare/issues\r\n\r\n### Related Skills\r\n- `cloudflare-worker-base` - Base Worker setup with Hono + Vite + React\r\n- `cloudflare-d1` - D1 database integration\r\n- `cloudflare-r2` - R2 object storage\r\n- `cloudflare-kv` - KV key-value storage\r\n- `cloudflare-workers-ai` - Workers AI integration\r\n- `cloudflare-vectorize` - Vector database for RAG",
    "Error Prevention (10+ Documented Errors)": "```\r\n\r\n**Source**: https://opennext.js.org/cloudflare/troubleshooting#worker-size-limits\r\n\r\n---\r\n\r\n### 2. Worker Size Limit Exceeded (10 MiB - Paid Plan)\r\n\r\n**Error**: `\"Your Worker exceeded the size limit of 10 MiB\"`\r\n\r\n**Cause**: Unnecessary code bundled into Worker\r\n\r\n**Debug workflow**:\r\n1. Run `npx opennextjs-cloudflare build`\r\n2. Navigate to `.open-next/server-functions/default`\r\n3. Analyze `handler.mjs.meta.json` using ESBuild Bundle Analyzer\r\n4. Identify and remove/externalize large dependencies\r\n\r\n**Source**: https://opennext.js.org/cloudflare/troubleshooting#worker-size-limits\r\n\r\n---\r\n\r\n### 3. FinalizationRegistry Not Defined\r\n\r\n**Error**: `\"ReferenceError: FinalizationRegistry is not defined\"`\r\n\r\n**Cause**: `compatibility_date` in wrangler.jsonc is too old\r\n\r\n**Solution**: Update `compatibility_date` to `2025-05-05` or later:\r\n\r\n```jsonc\r\n{\r\n  \"compatibility_date\": \"2025-05-05\"  // Minimum for FinalizationRegistry\r\n}\r\n```\r\n\r\n**Source**: https://opennext.js.org/cloudflare/troubleshooting#finalizationregistry-is-not-defined\r\n\r\n---\r\n\r\n### 4. Cannot Perform I/O on Behalf of Different Request\r\n\r\n**Error**: `\"Cannot perform I/O on behalf of a different request\"`\r\n\r\n**Cause**: Database client created globally and reused across requests\r\n\r\n**Problem code**:\r\n```typescript\r\n// ❌ WRONG: Global DB client\r\nimport { Pool } from 'pg';\r\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\r\n\r\nexport async function GET() {\r\n  // This will fail - pool created in different request context\r\n  const result = await pool.query('SELECT * FROM users');\r\n  return Response.json(result);\r\n}\r\n```\r\n\r\n**Solution**: Create database clients inside request handlers:\r\n\r\n```typescript\r\n// ✅ CORRECT: Request-scoped DB client\r\nimport { Pool } from 'pg';\r\n\r\nexport async function GET() {\r\n  // Create client within request context\r\n  const pool = new Pool({ connectionString: process.env.DATABASE_URL });\r\n  const result = await pool.query('SELECT * FROM users');\r\n  await pool.end();\r\n  return Response.json(result);\r\n}\r\n```\r\n\r\n**Alternative**: Use Cloudflare D1 (designed for Workers) instead of external databases:\r\n\r\n```typescript\r\n// ✅ BEST: Use D1 (no connection pooling needed)\r\nexport async function GET(request: NextRequest) {\r\n  const env = process.env as any;\r\n  const result = await env.DB.prepare('SELECT * FROM users').all();\r\n  return Response.json(result);\r\n}\r\n```\r\n\r\n**Source**: https://opennext.js.org/cloudflare/troubleshooting#cannot-perform-io-on-behalf-of-a-different-request\r\n\r\n---\r\n\r\n### 5. NPM Package Import Failures\r\n\r\n**Error**: `\"Could not resolve '<package>'\"`\r\n\r\n**Cause**: Missing `nodejs_compat` flag or package export conditions\r\n\r\n**Solution 1**: Enable `nodejs_compat` flag:\r\n\r\n```jsonc\r\n{\r\n  \"compatibility_flags\": [\"nodejs_compat\"]\r\n}\r\n```\r\n\r\n**Solution 2**: For packages with multiple exports, create `.env`:\r\n\r\n```env\r\nWRANGLER_BUILD_CONDITIONS=\"\"\r\nWRANGLER_BUILD_PLATFORM=\"node\"\r\n```\r\n\r\n**Source**: https://opennext.js.org/cloudflare/troubleshooting#npm-packages-fail-to-import\r\n\r\n---\r\n\r\n### 6. Failed to Load Chunk (Turbopack)\r\n\r\n**Error**: `\"Failed to load chunk server/chunks/ssr/\"`\r\n\r\n**Cause**: Next.js built with Turbopack (`next build --turbo`)\r\n\r\n**Solution**: Use standard build (Turbopack not supported by adapter):\r\n\r\n```json\r\n{\r\n  \"scripts\": {\r\n    \"build\": \"next build\"  // ✅ Correct\r\n    // \"build\": \"next build --turbo\"  // ❌ Don't use Turbopack\r\n  }\r\n}\r\n```\r\n\r\n**Source**: https://opennext.js.org/cloudflare/troubleshooting#failed-to-load-chunk\r\n\r\n---\r\n\r\n### 7. SSRF Vulnerability (CVE-2025-6087)\r\n\r\n**Vulnerability**: Server-Side Request Forgery via `/_next/image` endpoint\r\n\r\n**Affected versions**: `@opennextjs/cloudflare` < 1.3.0\r\n\r\n**Solution**: Upgrade to version 1.3.0 or later:\r\n\r\n```bash\r\nnpm install --save-dev @opennextjs/cloudflare@^1.3.0\r\n```\r\n\r\n**Impact**: Allows unauthenticated users to proxy arbitrary remote content\r\n\r\n**Source**: https://github.com/advisories/GHSA-rvpw-p7vw-wj3m\r\n\r\n---\r\n\r\n### 8. Durable Objects Binding Warnings\r\n\r\n**Warning**: `\"You have defined bindings to the following internal Durable Objects... will not work in local development, but they should work in production\"`\r\n\r\n**Cause**: OpenNext uses Durable Objects for caching (`DOQueueHandler`, `DOShardedTagCache`)\r\n\r\n**Solution**: **Safe to ignore** - warning is expected behavior\r\n\r\n**Alternative** (to suppress warning): Define Durable Objects in separate Worker with own config\r\n\r\n**Source**: https://opennext.js.org/cloudflare/known-issues#caching-durable-objects\r\n\r\n---\r\n\r\n### 9. Prisma + D1 Middleware Conflicts\r\n\r\n**Error**: Build errors when using `@prisma/client` + `@prisma/adapter-d1` in Next.js middleware\r\n\r\n**Cause**: Database initialization in middleware context\r\n\r\n**Workaround**: Initialize Prisma client in route handlers, not middleware\r\n\r\n**Source**: https://github.com/opennextjs/opennextjs-cloudflare/issues/471\r\n\r\n---\r\n\r\n### 10. cross-fetch Library Errors\r\n\r\n**Error**: Errors when using libraries that depend on `cross-fetch`\r\n\r\n**Cause**: OpenNext patches deployment package causing `cross-fetch` to try using Node.js libraries when native fetch is available\r\n\r\n**Solution**: Use native `fetch` API directly instead of `cross-fetch`:\r\n\r\n```typescript\r\n// ✅ Use native fetch\r\nconst response = await fetch('https://api.example.com/data');\r\n\r\n// ❌ Avoid cross-fetch\r\n// import fetch from 'cross-fetch';\r\n```\r\n\r\n**Source**: https://opennext.js.org/cloudflare/troubleshooting\r\n\r\n---\r\n\r\n### 11. Windows Development Issues\r\n\r\n**Issue**: Full Windows support not guaranteed\r\n\r\n**Cause**: Underlying Next.js tooling issues on Windows\r\n\r\n**Solutions**:\r\n- Use WSL (Windows Subsystem for Linux)\r\n- Use virtual machine with Linux\r\n- Use Linux-based CI/CD for deployments\r\n\r\n**Source**: https://opennext.js.org/cloudflare#windows-support",
    "Integration with Cloudflare Services": "### D1 Database (SQL)\r\n\r\n```typescript\r\n// app/api/users/route.ts\r\nimport type { NextRequest } from 'next/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const env = process.env as any;\r\n\r\n  const result = await env.DB.prepare(\r\n    'SELECT * FROM users WHERE active = ?'\r\n  ).bind(true).all();\r\n\r\n  return Response.json(result.results);\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const env = process.env as any;\r\n  const { name, email } = await request.json();\r\n\r\n  const result = await env.DB.prepare(\r\n    'INSERT INTO users (name, email) VALUES (?, ?)'\r\n  ).bind(name, email).run();\r\n\r\n  return Response.json({ id: result.meta.last_row_id });\r\n}\r\n```\r\n\r\n**Wrangler config**:\r\n```jsonc\r\n{\r\n  \"d1_databases\": [\r\n    {\r\n      \"binding\": \"DB\",\r\n      \"database_name\": \"production-db\",\r\n      \"database_id\": \"your-database-id\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**See also**: `cloudflare-d1` skill for complete D1 patterns\r\n\r\n---\r\n\r\n### R2 Storage (Object Storage)\r\n\r\n```typescript\r\n// app/api/upload/route.ts\r\nimport type { NextRequest } from 'next/server';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const env = process.env as any;\r\n  const formData = await request.formData();\r\n  const file = formData.get('file') as File;\r\n\r\n  // Upload to R2\r\n  await env.BUCKET.put(file.name, file.stream(), {\r\n    httpMetadata: {\r\n      contentType: file.type\r\n    }\r\n  });\r\n\r\n  return Response.json({ success: true, filename: file.name });\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const env = process.env as any;\r\n  const { searchParams } = new URL(request.url);\r\n  const filename = searchParams.get('file');\r\n\r\n  const object = await env.BUCKET.get(filename);\r\n  if (!object) {\r\n    return new Response('Not found', { status: 404 });\r\n  }\r\n\r\n  return new Response(object.body, {\r\n    headers: {\r\n      'Content-Type': object.httpMetadata?.contentType || 'application/octet-stream'\r\n    }\r\n  });\r\n}\r\n```\r\n\r\n**See also**: `cloudflare-r2` skill for complete R2 patterns\r\n\r\n---\r\n\r\n### Workers AI (Model Inference)\r\n\r\n```typescript\r\n// app/api/ai/route.ts\r\nimport type { NextRequest } from 'next/server';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const env = process.env as any;\r\n  const { prompt } = await request.json();\r\n\r\n  const response = await env.AI.run('@cf/meta/llama-3-8b-instruct', {\r\n    prompt\r\n  });\r\n\r\n  return Response.json(response);\r\n}\r\n```\r\n\r\n**Wrangler config**:\r\n```jsonc\r\n{\r\n  \"ai\": {\r\n    \"binding\": \"AI\"\r\n  }\r\n}\r\n```\r\n\r\n**See also**: `cloudflare-workers-ai` skill for complete AI patterns\r\n\r\n---\r\n\r\n### KV Storage (Key-Value)\r\n\r\n```typescript\r\n// app/api/cache/route.ts\r\nimport type { NextRequest } from 'next/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const env = process.env as any;\r\n  const { searchParams } = new URL(request.url);\r\n  const key = searchParams.get('key');\r\n\r\n  const value = await env.KV.get(key);\r\n  return Response.json({ key, value });\r\n}\r\n\r\nexport async function PUT(request: NextRequest) {\r\n  const env = process.env as any;\r\n  const { key, value, ttl } = await request.json();\r\n\r\n  await env.KV.put(key, value, { expirationTtl: ttl });\r\n  return Response.json({ success: true });\r\n}\r\n```\r\n\r\n**See also**: `cloudflare-kv` skill for complete KV patterns",
    "Use This Skill When": "- Deploying Next.js applications (App Router or Pages Router) to Cloudflare Workers\r\n- Need server-side rendering (SSR), static site generation (SSG), or incremental static regeneration (ISR) on Cloudflare\r\n- Migrating existing Next.js apps from Vercel, AWS, or other platforms to Cloudflare\r\n- Building full-stack Next.js applications with Cloudflare services (D1, R2, KV, Workers AI)\r\n- Need React Server Components, Server Actions, or Next.js middleware on Workers\r\n- Want global edge deployment with Cloudflare's network",
    "Quick Reference": "npm run cf-typegen  # Generate binding types\r\n```\r\n\r\n### Critical Configuration\r\n\r\n```jsonc\r\n// wrangler.jsonc\r\n{\r\n  \"compatibility_date\": \"2025-05-05\",  // Minimum!\r\n  \"compatibility_flags\": [\"nodejs_compat\"]  // Required!\r\n}\r\n```\r\n\r\n### Common Pitfalls\r\n\r\n1. ❌ Using Edge runtime → ✅ Use Node.js runtime\r\n2. ❌ Global DB clients → ✅ Request-scoped clients\r\n3. ❌ Old compatibility_date → ✅ Use 2025-05-05+\r\n4. ❌ Missing nodejs_compat → ✅ Add to compatibility_flags\r\n5. ❌ Only testing in `dev` → ✅ Always test `preview` before deploy\r\n6. ❌ Using Turbopack → ✅ Use standard Next.js build\r\n\r\n---\r\n\r\n**Production Tested**: Official Cloudflare support and active community\r\n**Token Savings**: ~59% vs manual setup\r\n**Errors Prevented**: 10+ documented issues\r\n**Last Verified**: 2025-10-21",
    "Caching Configuration": "Configure caching behavior in `open-next.config.ts`:\r\n\r\n```typescript\r\nimport { defineCloudflareConfig } from \"@opennextjs/cloudflare\";\r\n\r\nexport default defineCloudflareConfig({\r\n  // Custom cache configuration\r\n  cache: {\r\n    // Override default cache behavior\r\n    // See: https://opennext.js.org/cloudflare/caching\r\n  }\r\n});\r\n```\r\n\r\n**Default behavior**: OpenNext provides sensible caching defaults\r\n\r\n**Advanced usage**: See official OpenNext caching documentation"
  }
}
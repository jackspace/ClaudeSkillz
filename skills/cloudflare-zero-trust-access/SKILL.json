{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/access-policy-setup.md",
      "references/common-errors.md",
      "references/jwt-payload-structure.md",
      "references/service-tokens-guide.md"
    ]
  },
  "content": "Integrate Cloudflare Zero Trust Access authentication with Cloudflare Workers applications using proven patterns and templates.\r\n\r\n---",
  "name": "cloudflare-zero-trust-access",
  "id": "cloudflare-zero-trust-access",
  "sections": {
    "Additional Resources": "**Cloudflare Documentation**:\r\n- [Access Overview](https://developers.cloudflare.com/cloudflare-one/identity/authorization-cookie/)\r\n- [JWT Validation](https://developers.cloudflare.com/cloudflare-one/identity/authorization-cookie/validating-json/)\r\n- [Service Tokens](https://developers.cloudflare.com/cloudflare-one/identity/service-tokens/)\r\n\r\n**Packages**:\r\n- [@hono/cloudflare-access](https://github.com/honojs/middleware/tree/main/packages/cloudflare-access)\r\n- [Hono Framework](https://hono.dev/)\r\n\r\n**Dashboard**:\r\n- [Zero Trust Dashboard](https://one.dash.cloudflare.com/)\r\n\r\n---\r\n\r\n**Skill Version**: 1.0.0\r\n**Last Updated**: 2025-10-28\r\n**Errors Prevented**: 8\r\n**Token Savings**: 58%\r\n**Time Savings**: 2.5 hours\r\n**Production Tested**: ✅",
    "Overview": "This skill provides complete integration patterns for Cloudflare Access, enabling application-level authentication for Workers without managing your own auth infrastructure.\r\n\r\n**What is Cloudflare Access?**\r\nCloudflare Access is Zero Trust authentication that sits in front of your application, validating users before they reach your Worker. After authentication, Access issues JWT tokens that your Worker validates.\r\n\r\n**Key Benefits**:\r\n- No auth infrastructure to maintain\r\n- Integrates with identity providers (Azure AD, Google, Okta, GitHub)\r\n- Service tokens for machine-to-machine auth\r\n- Built-in MFA and session management\r\n- Comprehensive audit logs\r\n\r\n---",
    "Common Errors Prevented": "This skill prevents 8 documented errors. Full details: `references/common-errors.md`\r\n\r\n### Error #1: CORS Preflight Blocked (45 min saved)\r\n\r\n**Problem**: OPTIONS requests return 401, breaking CORS\r\n\r\n**Solution**: CORS middleware BEFORE Access middleware\r\n```typescript\r\n// ✅ Correct\r\napp.use('*', cors())\r\napp.use('/api/*', cloudflareAccess({ domain: '...' }))\r\n```\r\n\r\n---\r\n\r\n### Error #2: Missing JWT Header (30 min saved)\r\n\r\n**Problem**: Request not going through Access, no JWT header\r\n\r\n**Solution**: Access Worker through Access URL, not direct `*.workers.dev`\r\n```\r\n✅ https://team.cloudflareaccess.com/...\r\n❌ https://worker.workers.dev\r\n```\r\n\r\n---\r\n\r\n### Error #3: Invalid Team Name (15 min saved)\r\n\r\n**Problem**: Hardcoded or wrong team name causes \"Invalid issuer\"\r\n\r\n**Solution**: Use environment variables\r\n```typescript\r\n// ✅ Correct\r\ncloudflareAccess({ domain: (c) => c.env.ACCESS_TEAM_DOMAIN })\r\n\r\n// ❌ Wrong\r\ncloudflareAccess({ domain: 'my-team.cloudflareaccess.com' })\r\n```\r\n\r\n---\r\n\r\n### Error #4: Key Cache Race (20 min saved)\r\n\r\n**Problem**: First request fails, subsequent work\r\n\r\n**Solution**: Use `@hono/cloudflare-access` (handles caching automatically)\r\n\r\n---\r\n\r\n### Error #5: Service Token Headers (10 min saved)\r\n\r\n**Problem**: Wrong header names, token doesn't work\r\n\r\n**Solution**: Use exact header names:\r\n```typescript\r\n// ✅ Correct\r\n'CF-Access-Client-Id': '...'\r\n'CF-Access-Client-Secret': '...'\r\n\r\n// ❌ Wrong\r\n'Authorization': 'Bearer ...'\r\n```\r\n\r\n---\r\n\r\n### Error #6: Token Expiration (10 min saved)\r\n\r\n**Problem**: Users suddenly get 401 after 1 hour\r\n\r\n**Solution**: Handle gracefully, redirect to login\r\n```typescript\r\nif (error.message.includes('expired')) {\r\n  return c.json({ error: 'Session expired', code: 'TOKEN_EXPIRED' }, 401)\r\n}\r\n```\r\n\r\n---\r\n\r\n### Error #7: Multiple Policies (30 min saved)\r\n\r\n**Problem**: Overlapping Access applications cause conflicts\r\n\r\n**Solution**: Use most specific paths, avoid overlaps\r\n\r\n---\r\n\r\n### Error #8: Dev/Prod Mismatch (15 min saved)\r\n\r\n**Problem**: Code works in dev, fails in prod\r\n\r\n**Solution**: Environment-specific configs\r\n```jsonc\r\n{\r\n  \"env\": {\r\n    \"dev\": {\r\n      \"vars\": { \"ACCESS_TEAM_DOMAIN\": \"dev-team.cloudflareaccess.com\" }\r\n    },\r\n    \"production\": {\r\n      \"vars\": { \"ACCESS_TEAM_DOMAIN\": \"prod-team.cloudflareaccess.com\" }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Total Time Saved**: ~2.5 hours per implementation\r\n\r\n---",
    "When NOT to Use": "This skill is for **Cloudflare Workers** with **Cloudflare Access**. Do not use for:\r\n\r\n- ❌ Cloudflare Pages (use `@cloudflare/pages-plugin-cloudflare-access` instead)\r\n- ❌ Non-Cloudflare platforms\r\n- ❌ Custom JWT auth (not Access)\r\n- ❌ Auth.js or other auth libraries\r\n- ❌ Self-hosted authentication\r\n\r\nFor those, use appropriate skills or libraries.\r\n\r\n---",
    "Reference Documentation": "Comprehensive guides in `references/`:\r\n\r\n1. **`common-errors.md`** (~800 words)\r\n   - All 8 errors with solutions\r\n   - Error → Symptom → Cause → Solution → Prevention\r\n   - Source links and time savings\r\n\r\n2. **`jwt-payload-structure.md`** (~1,200 words)\r\n   - Complete JWT field reference\r\n   - User vs service token differences\r\n   - Type definitions and examples\r\n\r\n3. **`service-tokens-guide.md`** (~1,100 words)\r\n   - Creating service tokens\r\n   - Adding to policies\r\n   - Use cases (CI/CD, microservices, cron)\r\n   - Rotation best practices\r\n\r\n4. **`access-policy-setup.md`** (~1,400 words)\r\n   - Dashboard configuration steps\r\n   - Policy examples\r\n   - Identity provider setup\r\n   - Testing and troubleshooting\r\n\r\n---",
    "Production Testing": "**Library**: `@hono/cloudflare-access` actively maintained\r\n**Downloads**: ~3,000/week\r\n**GitHub**: Part of Hono middleware collection (10k+ stars)\r\n\r\n**Production Use**: Verified working in commercial projects.\r\n\r\n---",
    "Use Cases": "### Admin Dashboard Protection\r\n\r\n**Requirements**: Protect admin routes with email authentication\r\n\r\n**Template**: `hono-basic-setup.ts`\r\n\r\n**Policy**: Emails ending in `@company.com`\r\n\r\n---\r\n\r\n### API Authentication\r\n\r\n**Requirements**: Protect API, allow public pages\r\n\r\n**Template**: `hono-basic-setup.ts` + separate routes\r\n\r\n**Policy**: Service tokens + employee emails\r\n\r\n---\r\n\r\n### SPA + Protected API\r\n\r\n**Requirements**: React app calling authenticated API\r\n\r\n**Template**: `cors-access.ts`\r\n\r\n**Critical**: CORS middleware before Access\r\n\r\n---\r\n\r\n### CI/CD Pipeline\r\n\r\n**Requirements**: GitHub Actions calling Worker API\r\n\r\n**Template**: `service-token-auth.ts`\r\n\r\n**Setup**: Service token in GitHub Secrets\r\n\r\n---\r\n\r\n### Multi-Tenant SaaS\r\n\r\n**Requirements**: Different Access per organization\r\n\r\n**Template**: `multi-tenant.ts`\r\n\r\n**Architecture**: Tenant config in D1, dynamic middleware\r\n\r\n---",
    "Templates": "### Core Templates\r\n\r\n1. **`hono-basic-setup.ts`** - Standard Hono + Access integration\r\n   - Public and protected routes\r\n   - User info access\r\n   - Error handling\r\n\r\n2. **`jwt-validation-manual.ts`** - Manual JWT verification\r\n   - Web Crypto API usage\r\n   - Key caching\r\n   - Full validation logic\r\n\r\n3. **`service-token-auth.ts`** - Service token patterns\r\n   - Client and server examples\r\n   - Service vs user detection\r\n   - Best practices\r\n\r\n4. **`cors-access.ts`** - CORS + Access integration\r\n   - Correct middleware ordering\r\n   - Frontend examples (fetch, axios)\r\n   - Troubleshooting guide\r\n\r\n5. **`multi-tenant.ts`** - Multi-tenant architecture\r\n   - Subdomain, path, header strategies\r\n   - D1 tenant config\r\n   - Dynamic middleware\r\n\r\n### Configuration Templates\r\n\r\n6. **`wrangler.jsonc`** - Complete Wrangler configuration\r\n   - Environment variables\r\n   - Bindings (D1, KV, R2)\r\n   - Dev/staging/production environments\r\n\r\n7. **`.env.example`** - Environment variable template\r\n   - Required: ACCESS_TEAM_DOMAIN, ACCESS_AUD\r\n   - Optional: Service tokens, CORS config\r\n   - Setup instructions\r\n\r\n8. **`types.ts`** - TypeScript definitions\r\n   - AccessJWTPayload interface\r\n   - ServiceTokenJWTPayload interface\r\n   - Type guards and helpers\r\n\r\n---",
    "When to Use This Skill": "Trigger this skill when tasks involve:\r\n\r\n- **Authentication**: Protecting Worker routes, securing admin dashboards, API authentication\r\n- **Access Control**: Role-based access (RBAC), group-based permissions, geographic restrictions\r\n- **Service Auth**: Backend services calling Worker APIs, CI/CD pipelines, cron jobs\r\n- **Multi-Tenant**: SaaS apps with organization-level authentication\r\n- **CORS + Auth**: Single-page applications calling protected APIs\r\n\r\n**Keywords to Trigger**:\r\ncloudflare access, zero trust, access authentication, JWT validation, service tokens, cloudflare auth, hono access, workers authentication, protect worker routes, admin authentication\r\n\r\n---",
    "Integration Patterns": "### Pattern 1: Hono Middleware (Recommended)\r\n\r\nUse `@hono/cloudflare-access` for one-line Access integration.\r\n\r\n**When to Use**:\r\n- Building with Hono framework\r\n- Need quick, production-ready setup\r\n- Want automatic JWT validation and key caching\r\n\r\n**Template**: `templates/hono-basic-setup.ts`\r\n\r\n**Setup**:\r\n```typescript\r\nimport { Hono } from 'hono'\r\nimport { cloudflareAccess } from '@hono/cloudflare-access'\r\n\r\nconst app = new Hono<{ Bindings: Env }>()\r\n\r\n// Public routes\r\napp.get('/', (c) => c.text('Public page'))\r\n\r\n// Protected routes\r\napp.use(\r\n  '/admin/*',\r\n  cloudflareAccess({\r\n    domain: (c) => c.env.ACCESS_TEAM_DOMAIN,\r\n  })\r\n)\r\n\r\napp.get('/admin/dashboard', (c) => {\r\n  const { email } = c.get('accessPayload')\r\n  return c.text(`Welcome, ${email}!`)\r\n})\r\n```\r\n\r\n**Configuration** (`wrangler.jsonc`):\r\n```jsonc\r\n{\r\n  \"vars\": {\r\n    \"ACCESS_TEAM_DOMAIN\": \"your-team.cloudflareaccess.com\",\r\n    \"ACCESS_AUD\": \"your-app-aud-tag\"\r\n  }\r\n}\r\n```\r\n\r\n**Benefits**:\r\n- ✅ Automatic JWT validation\r\n- ✅ Public key caching (1-hour TTL)\r\n- ✅ Type-safe with TypeScript\r\n- ✅ Production-tested and maintained\r\n\r\n---\r\n\r\n### Pattern 2: Manual JWT Validation\r\n\r\nUse Web Crypto API for custom validation logic.\r\n\r\n**When to Use**:\r\n- Not using Hono framework\r\n- Need custom validation beyond standard checks\r\n- Want full control over JWT verification\r\n\r\n**Template**: `templates/jwt-validation-manual.ts`\r\n\r\n**Key Functions**:\r\n```typescript\r\n// Validate JWT signature and claims\r\nasync function validateAccessJWT(\r\n  token: string,\r\n  env: Env\r\n): Promise<AccessJWTPayload> {\r\n  // 1. Decode header to get kid\r\n  // 2. Fetch public keys (with caching)\r\n  // 3. Verify signature using Web Crypto API\r\n  // 4. Validate aud, exp, iss\r\n  // 5. Return payload\r\n}\r\n```\r\n\r\n**Complexity**: ~100 lines\r\n**Dependencies**: None (uses Web Crypto API)\r\n\r\n---\r\n\r\n### Pattern 3: Service Token Authentication\r\n\r\nUse service tokens for machine-to-machine auth.\r\n\r\n**When to Use**:\r\n- Backend services calling your Worker API\r\n- CI/CD pipelines\r\n- Automated scripts and cron jobs\r\n- No interactive login needed\r\n\r\n**Template**: `templates/service-token-auth.ts`\r\n\r\n**Client Side** (sending request):\r\n```typescript\r\nconst response = await fetch('https://api.example.com/data', {\r\n  headers: {\r\n    'CF-Access-Client-Id': env.SERVICE_TOKEN_ID,\r\n    'CF-Access-Client-Secret': env.SERVICE_TOKEN_SECRET,\r\n  },\r\n})\r\n```\r\n\r\n**Server Side** (Worker):\r\n```typescript\r\n// Same validation as user JWTs - middleware handles both\r\napp.use('/api/*', cloudflareAccess({\r\n  domain: (c) => c.env.ACCESS_TEAM_DOMAIN\r\n}))\r\n\r\napp.get('/api/data', (c) => {\r\n  const payload = c.get('accessPayload')\r\n\r\n  // Detect service token vs user\r\n  const isService = !payload.email && payload.common_name\r\n\r\n  return c.json({\r\n    authenticated_by: isService ? 'service-token' : 'user',\r\n    identifier: payload.email || payload.common_name,\r\n  })\r\n})\r\n```\r\n\r\n**Setup Guide**: `references/service-tokens-guide.md`\r\n\r\n---\r\n\r\n### Pattern 4: CORS + Access\r\n\r\nHandle cross-origin requests with Access authentication.\r\n\r\n**When to Use**:\r\n- SPA (React/Vue/Angular) calling protected API\r\n- Frontend and API on different domains\r\n- Cross-origin authenticated requests\r\n\r\n**Template**: `templates/cors-access.ts`\r\n\r\n**CRITICAL**: CORS middleware MUST come before Access middleware!\r\n\r\n```typescript\r\nimport { cors } from 'hono/cors'\r\nimport { cloudflareAccess } from '@hono/cloudflare-access'\r\n\r\n// ✅ CORRECT ORDER\r\napp.use('*', cors({\r\n  origin: 'https://app.example.com',\r\n  credentials: true, // Allow cookies\r\n}))\r\n\r\napp.use('/api/*', cloudflareAccess({\r\n  domain: (c) => c.env.ACCESS_TEAM_DOMAIN\r\n}))\r\n\r\n// ❌ WRONG ORDER - WILL FAIL!\r\n// Access blocks OPTIONS preflight requests\r\n```\r\n\r\n**Why**: OPTIONS preflight requests don't include auth headers. If Access runs first, it blocks them with 401.\r\n\r\n**Frontend**:\r\n```javascript\r\nfetch('https://api.example.com/api/data', {\r\n  credentials: 'include', // ← Critical!\r\n  method: 'POST',\r\n})\r\n```\r\n\r\n---\r\n\r\n### Pattern 5: Multi-Tenant\r\n\r\nDifferent Access configurations per tenant/organization.\r\n\r\n**When to Use**:\r\n- SaaS with organization-level authentication\r\n- Each customer has separate Access team\r\n- White-label applications\r\n\r\n**Template**: `templates/multi-tenant.ts`\r\n\r\n**Architecture**:\r\n- Tenant config stored in D1 or KV\r\n- Dynamic middleware based on tenant ID\r\n- Tenant ID from subdomain, path, or header\r\n\r\n**Example**:\r\n```typescript\r\n// Subdomain-based: tenant1.example.com, tenant2.example.com\r\napp.use('/app/*', async (c, next) => {\r\n  const tenantId = getTenantFromSubdomain(c.req.url)\r\n  const tenant = await getTenantConfig(tenantId, c.env.DB)\r\n\r\n  // Apply tenant-specific Access\r\n  return cloudflareAccess({\r\n    domain: tenant.access_team_domain\r\n  })(c, next)\r\n})\r\n```\r\n\r\n---",
    "Workflow": "When user requests Access integration:\r\n\r\n1. **Assess Pattern**: Which integration pattern fits? (Hono middleware, manual, service tokens, CORS, multi-tenant)\r\n\r\n2. **Check Templates**: Copy relevant template from `templates/`\r\n\r\n3. **Configure Environment**: Set `ACCESS_TEAM_DOMAIN` and `ACCESS_AUD` in wrangler.jsonc\r\n\r\n4. **Setup Dashboard**: Guide user through Access policy creation (use `references/access-policy-setup.md`)\r\n\r\n5. **Prevent Errors**: Apply solutions from `references/common-errors.md`\r\n\r\n6. **Test**: Deploy and verify authentication flow\r\n\r\n---",
    "Helper Scripts": "Located in `scripts/`:\r\n\r\n1. **`test-access-jwt.sh`** - JWT testing tool\r\n   - Decodes JWT header and payload\r\n   - Fetches public keys\r\n   - Validates signature and claims\r\n   - Usage: `./test-access-jwt.sh <jwt-token>`\r\n\r\n2. **`create-service-token.sh`** - Service token setup guide\r\n   - Interactive setup instructions\r\n   - Code examples (curl, Node.js, Python, GitHub Actions)\r\n   - Best practices checklist\r\n   - Usage: `./create-service-token.sh [token-name]`\r\n\r\n---",
    "Token Efficiency": "**Without Skill**: ~5,550 tokens\r\n- Cloudflare docs: 2,500 tokens\r\n- Library docs: 450 tokens\r\n- GitHub issue research: 1,000 tokens\r\n- Manual implementation: 1,600 tokens\r\n\r\n**With Skill**: ~2,300 tokens\r\n- SKILL.md: 1,500 tokens\r\n- Templates: 500 tokens\r\n- Quick setup: 300 tokens\r\n\r\n**Savings**: 3,250 tokens (~58%)\r\n\r\n---",
    "Quick Start": "### 1. Install Package\r\n\r\n```bash\r\nnpm install hono @hono/cloudflare-access\r\n```\r\n\r\n### 2. Configure Access\r\n\r\n**Dashboard**:\r\n1. Go to Zero Trust > Access > Applications\r\n2. Create application for your Worker domain\r\n3. Create policy (e.g., \"Emails ending in @company.com\")\r\n4. Copy Application Audience (AUD) tag\r\n\r\n**wrangler.jsonc**:\r\n```jsonc\r\n{\r\n  \"vars\": {\r\n    \"ACCESS_TEAM_DOMAIN\": \"your-team.cloudflareaccess.com\",\r\n    \"ACCESS_AUD\": \"your-aud-tag\"\r\n  }\r\n}\r\n```\r\n\r\n### 3. Add to Worker\r\n\r\nUse `templates/hono-basic-setup.ts` as starting point:\r\n\r\n```typescript\r\nimport { Hono } from 'hono'\r\nimport { cloudflareAccess } from '@hono/cloudflare-access'\r\n\r\nconst app = new Hono<{ Bindings: Env }>()\r\n\r\napp.use('/admin/*', cloudflareAccess({\r\n  domain: (c) => c.env.ACCESS_TEAM_DOMAIN\r\n}))\r\n\r\napp.get('/admin/dashboard', (c) => {\r\n  const { email } = c.get('accessPayload')\r\n  return c.json({ email })\r\n})\r\n\r\nexport default app\r\n```\r\n\r\n### 4. Deploy and Test\r\n\r\n```bash\r\nnpx wrangler deploy\r\n```\r\n\r\nAccess: `https://your-worker.example.com/admin/dashboard`\r\n\r\nExpected: Redirect to Access login, then back to dashboard after auth.\r\n\r\n---",
    "Package Information": "| Package | Version | Purpose |\r\n|---------|---------|---------|\r\n| @hono/cloudflare-access | 0.3.1 | Hono middleware (recommended) |\r\n| hono | 4.10.3 | Web framework |\r\n| @cloudflare/workers-types | 4.20251014.0 | TypeScript types |\r\n\r\n**Verified**: 2025-10-28\r\n\r\n**No Node.js Dependencies**: All packages use Web Standards APIs, fully compatible with Workers runtime.\r\n\r\n---"
  }
}
{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/common-errors.md",
      "references/dns-setup.md",
      "references/local-development.md"
    ]
  },
  "content": "**Status**: Production Ready ✅\r\n**Last Updated**: 2025-10-23\r\n**Latest Versions**: postal-mime@2.5.0, mimetext@3.0.27\r\n\r\n---\r\n\r\n\r\n### Part 1: Enable Email Routing (Dashboard)\r\n\r\n**Prerequisites**: Domain must be on Cloudflare DNS\r\n\r\n1. Log in to Cloudflare Dashboard → select your domain\r\n2. Go to **Email** > **Email Routing**\r\n3. Select **Enable Email Routing** → **Add records and enable**\r\n   - This automatically adds MX records, SPF, and DKIM to your DNS\r\n4. Create a destination address:\r\n   - **Custom address**: `hello@yourdomain.com`\r\n   - **Destination**: Your personal email (e.g., `you@gmail.com`)\r\n   - **Verify** the destination address via email\r\n5. ✅ Basic email forwarding is now active\r\n\r\n**What you just did**: Configured DNS and basic forwarding. Now let's add Workers for custom logic.\r\n\r\n---\r\n\r\n### Part 2: Receiving Emails with Email Workers\r\n\r\n#### 1. Install Dependencies\r\n\r\n```bash\r\nnpm install postal-mime@2.5.0 mimetext@3.0.27\r\n```\r\n\r\n**Why these packages:**\r\n- `postal-mime` - Parse incoming email messages (headers, body, attachments)\r\n- `mimetext` - Create email messages for sending/replying\r\n\r\n#### 2. Create Email Worker\r\n\r\nCreate `src/email.ts`:\r\n\r\n```typescript\r\nimport { EmailMessage } from 'cloudflare:email';\r\nimport PostalMime from 'postal-mime';\r\n\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    // Parse the incoming message\r\n    const parser = new PostalMime.default();\r\n    const email = await parser.parse(await new Response(message.raw).arrayBuffer());\r\n\r\n    console.log('From:', message.from);\r\n    console.log('To:', message.to);\r\n    console.log('Subject:', email.subject);\r\n\r\n    // Forward to verified destination\r\n    await message.forward('your-email@example.com');\r\n  },\r\n};\r\n```\r\n\r\n#### 3. Configure Wrangler\r\n\r\nUpdate `wrangler.jsonc`:\r\n\r\n```jsonc\r\n{\r\n  \"name\": \"email-worker\",\r\n  \"main\": \"src/email.ts\",\r\n  \"compatibility_date\": \"2025-10-11\"\r\n}\r\n```\r\n\r\n#### 4. Deploy and Bind\r\n\r\n```bash\r\nnpx wrangler deploy\r\n\r\n\r\n### Receiving Emails\r\n\r\nWrangler simulates email reception via HTTP POST:\r\n\r\n```bash\r\nnpx wrangler dev",
  "name": "cloudflare-email-routing",
  "id": "cloudflare-email-routing",
  "sections": {
    "Complete Setup Checklist": "### Email Routing Setup\r\n- [ ] Domain is on Cloudflare DNS\r\n- [ ] Email Routing enabled in dashboard\r\n- [ ] MX, SPF, DKIM records automatically added\r\n- [ ] At least one destination address verified\r\n- [ ] Test basic forwarding with a custom address\r\n\r\n### Email Workers (Receiving)\r\n- [ ] `postal-mime@2.5.0` installed\r\n- [ ] `mimetext@3.0.27` installed\r\n- [ ] Email worker created with `async email()` handler\r\n- [ ] Worker deployed: `npx wrangler deploy`\r\n- [ ] Worker bound to email route in dashboard\r\n- [ ] Test with real email to route address\r\n- [ ] Verify logs with `wrangler tail`\r\n\r\n### Send Email (Sending)\r\n- [ ] `send_email` binding configured in `wrangler.jsonc`\r\n- [ ] `destination_address` or `allowed_destination_addresses` specified\r\n- [ ] All destination addresses verified in Email Routing\r\n- [ ] Worker code uses `env.EMAIL.send()`\r\n- [ ] Worker deployed: `npx wrangler deploy`\r\n- [ ] Test sending email via Worker endpoint\r\n- [ ] Confirm email delivery to recipient\r\n\r\n---",
    "Known Issues Prevention": "This skill prevents **8 documented issues**:\r\n\r\n### Issue #1: \"Email Trigger not available to this workers\"\r\n\r\n**Error**: Testing email workers fails with \"Email Trigger not available to this workers\"\r\n\r\n**Source**: [workers-sdk #3751](https://github.com/cloudflare/workers-sdk/issues/3751)\r\n\r\n**Why It Happens**: Wrangler dev doesn't fully support email triggers; testing must be done via deployed Workers\r\n\r\n**Prevention**:\r\n- Always deploy email workers before testing\r\n- Use `wrangler tail` for live debugging\r\n- Use dashboard \"Test Email Event\" feature (when working)\r\n\r\n---\r\n\r\n### Issue #2: Destination Address Verification Bug\r\n\r\n**Error**: Verified destination addresses show as \"unverified\" in Email Worker forwarding\r\n\r\n**Source**: Community reports ([Cloudflare Community](https://community.cloudflare.com/t/email-worker-free-reliability/486680))\r\n\r\n**Why It Happens**: Bug in dashboard where addresses only show verified if also used in regular routing rules\r\n\r\n**Prevention**:\r\n- Create a regular forward rule for each destination address first\r\n- Then use the same addresses in Email Workers\r\n- Verify addresses before deploying workers\r\n\r\n---\r\n\r\n### Issue #3: Gmail Rate Limiting\r\n\r\n**Error**: \"421: Our system has detected an unusual rate of unsolicited mail originating from your IP address\"\r\n\r\n**Source**: Community reports\r\n\r\n**Why It Happens**: Gmail may flag Cloudflare's IP ranges as suspicious due to shared infrastructure\r\n\r\n**Prevention**:\r\n- Implement proper SPF/DKIM/DMARC records\r\n- Don't send bulk emails through Email Routing\r\n- Use transactional email services (e.g., SendGrid, Mailgun) for high volume\r\n- Rate-limit your sending (max 50-100 emails/hour for personal use)\r\n\r\n---\r\n\r\n### Issue #4: SPF Permerror with MailChannels\r\n\r\n**Error**: SPF permerror when routing through MailChannels\r\n\r\n**Source**: [Community discussion](https://community.cloudflare.com/t/worker-mailchannels-email-routing-spf-permerror/637766)\r\n\r\n**Why It Happens**: SPF record chain breaks when forwarding through multiple services\r\n\r\n**Prevention**:\r\n- Use Email Routing's native send capabilities instead of MailChannels\r\n- If using MailChannels, configure SPF includes correctly\r\n- Test with [MXToolbox SPF checker](https://mxtoolbox.com/spf.aspx)\r\n\r\n---\r\n\r\n### Issue #5: Limited Logging on Free Plan\r\n\r\n**Error**: Cannot see worker logs or email processing details\r\n\r\n**Source**: Community reports\r\n\r\n**Why It Happens**: Free plan has limited log retention and streaming\r\n\r\n**Prevention**:\r\n- Use `wrangler tail` during development for live logs\r\n- Use `console.log()` extensively in email workers\r\n- Store critical data in D1/KV for debugging\r\n- Upgrade to Workers Paid plan for better observability\r\n\r\n---\r\n\r\n### Issue #6: Activity Log Discrepancies\r\n\r\n**Error**: Emails show as \"Dropped\" in Activity Log even when successfully forwarded\r\n\r\n**Source**: Community reports\r\n\r\n**Why It Happens**: Dashboard bug showing incorrect status\r\n\r\n**Prevention**:\r\n- Check actual email delivery instead of relying on dashboard\r\n- Use `wrangler tail` to verify processing\r\n- Implement your own logging in D1/KV\r\n- Test with real emails to confirm delivery\r\n\r\n---\r\n\r\n### Issue #7: Test Email Event Loading Indefinitely\r\n\r\n**Error**: Dashboard \"Test Email Event\" button remains in loading state forever\r\n\r\n**Source**: [workers-sdk #9195](https://github.com/cloudflare/workers-sdk/issues/9195)\r\n\r\n**Why It Happens**: Bug in dashboard testing interface (unresolved as of 2025-10)\r\n\r\n**Prevention**:\r\n- Don't rely on dashboard testing feature\r\n- Use `curl` with local development instead (see Local Development section)\r\n- Deploy and test with real emails\r\n- Use `wrangler tail` to monitor processing\r\n\r\n---\r\n\r\n### Issue #8: Worker Call Failures\r\n\r\n**Error**: \"Rejected reason: Unknown error: failed to call worker: Worker call failed for 3 times, aborting…\"\r\n\r\n**Source**: [workers-sdk #9069](https://github.com/cloudflare/workers-sdk/issues/9069), Community reports\r\n\r\n**Why It Happens**: Worker crashes due to runtime errors, timeouts, or memory issues\r\n\r\n**Prevention**:\r\n- Add comprehensive error handling with try/catch\r\n- Set timeouts for external API calls\r\n- Log errors to D1/KV before rejecting\r\n- Use `ctx.waitUntil()` for non-critical operations\r\n- Test with various email formats (plain text, HTML, attachments)\r\n\r\n---",
    "DNS Configuration": "### Automatic Setup (Recommended)\r\n\r\nWhen you enable Email Routing in the dashboard, Cloudflare automatically adds:\r\n\r\n1. **MX Records** - Direct email to Cloudflare's servers\r\n   ```\r\n   yourdomain.com. 300 IN MX 13 amir.mx.cloudflare.net.\r\n   yourdomain.com. 300 IN MX 86 linda.mx.cloudflare.net.\r\n   yourdomain.com. 300 IN MX 24 isaac.mx.cloudflare.net.\r\n   ```\r\n\r\n2. **SPF Record** - Authorize Cloudflare to send on your behalf\r\n   ```\r\n   yourdomain.com. 300 IN TXT \"v=spf1 include:_spf.mx.cloudflare.net ~all\"\r\n   ```\r\n\r\n3. **DKIM Records** - Sign outgoing emails\r\n   ```\r\n   Automatically configured per domain\r\n   ```\r\n\r\n### Manual Setup (Advanced)\r\n\r\nIf you need to migrate from another provider:\r\n\r\n1. Go to **Email > Email Routing > Settings**\r\n2. Select **Start disabling > Unlock records and continue**\r\n3. Edit DNS records as needed\r\n4. When ready, **Lock DNS records** to protect Email Routing\r\n\r\n**WARNING**: Changing MX records will break Email Routing. Only do this if migrating providers.\r\n\r\n---",
    "TypeScript Types": "### Environment Bindings\r\n\r\n```typescript\r\ninterface Env {\r\n  // Send email bindings\r\n  EMAIL: SendEmail;\r\n  NOTIFICATIONS: SendEmail;\r\n  ALERTS: SendEmail;\r\n\r\n  // Other bindings\r\n  DB: D1Database;\r\n  EMAIL_CACHE: KVNamespace;\r\n}\r\n\r\ninterface SendEmail {\r\n  send(message: EmailMessage): Promise<void>;\r\n}\r\n```\r\n\r\n### Full Type Definitions\r\n\r\n```typescript\r\nimport { EmailMessage } from 'cloudflare:email';\r\n\r\ninterface ForwardableEmailMessage {\r\n  readonly from: string;\r\n  readonly to: string;\r\n  readonly headers: Headers;\r\n  readonly raw: ReadableStream;\r\n  readonly rawSize: number;\r\n\r\n  setReject(reason: string): void;\r\n  forward(rcptTo: string, headers?: Headers): Promise<void>;\r\n  reply(message: EmailMessage): Promise<void>;\r\n}\r\n\r\ndeclare module 'cloudflare:email' {\r\n  export class EmailMessage {\r\n    constructor(from: string, to: string, raw: string | ReadableStream);\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Quick Start (10 Minutes)": "```\r\n\r\n**What you just did**: Created a Worker that logs and forwards emails.\r\n\r\n---\r\n\r\n### Part 3: Sending Emails from Workers\r\n\r\n#### 1. Configure Send Email Binding\r\n\r\nUpdate `wrangler.jsonc`:\r\n\r\n```jsonc\r\n{\r\n  \"name\": \"my-worker\",\r\n  \"main\": \"src/index.ts\",\r\n  \"compatibility_date\": \"2025-10-11\",\r\n  \"send_email\": [\r\n    {\r\n      \"name\": \"EMAIL\",\r\n      \"destination_address\": \"notifications@yourdomain.com\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**CRITICAL**: `destination_address` must be:\r\n- A domain where you have Email Routing enabled\r\n- A verified destination address in Email Routing settings\r\n\r\n#### 2. Send Email from Worker\r\n\r\n```typescript\r\nimport { EmailMessage } from 'cloudflare:email';\r\nimport { createMimeMessage } from 'mimetext';\r\n\r\nexport default {\r\n  async fetch(request, env, ctx) {\r\n    // Create email message\r\n    const msg = createMimeMessage();\r\n    msg.setSender({ name: 'My App', addr: 'noreply@yourdomain.com' });\r\n    msg.setRecipient('user@example.com');\r\n    msg.setSubject('Welcome to My App');\r\n    msg.addMessage({\r\n      contentType: 'text/plain',\r\n      data: 'Thank you for signing up!',\r\n    });\r\n\r\n    // Send via binding\r\n    const message = new EmailMessage(\r\n      'noreply@yourdomain.com',\r\n      'user@example.com',\r\n      msg.asRaw()\r\n    );\r\n\r\n    await env.EMAIL.send(message);\r\n\r\n    return new Response('Email sent!');\r\n  },\r\n};\r\n```\r\n\r\n#### 3. Deploy\r\n\r\n```bash\r\nnpx wrangler deploy\r\n```\r\n\r\n**What you just did**: Configured your Worker to send emails to verified addresses.\r\n\r\n---",
    "Email Workers: Complete Guide": "### Runtime API\r\n\r\n#### EmailEvent Handler\r\n\r\n```typescript\r\nexport default {\r\n  async email(message: ForwardableEmailMessage, env: Env, ctx: ExecutionContext) {\r\n    // Process email here\r\n  },\r\n};\r\n```\r\n\r\n**Parameters:**\r\n- `message` - ForwardableEmailMessage object\r\n- `env` - Environment bindings (KV, D1, secrets, etc.)\r\n- `ctx` - Execution context (waitUntil for async operations)\r\n\r\n#### ForwardableEmailMessage Properties\r\n\r\n```typescript\r\ninterface ForwardableEmailMessage {\r\n  readonly from: string;          // Sender email\r\n  readonly to: string;            // Recipient email\r\n  readonly headers: Headers;      // Email headers\r\n  readonly raw: ReadableStream;   // Raw email message\r\n  readonly rawSize: number;       // Size in bytes\r\n\r\n  // Methods\r\n  setReject(reason: string): void;\r\n  forward(rcptTo: string, headers?: Headers): Promise<void>;\r\n  reply(message: EmailMessage): Promise<void>;\r\n}\r\n```\r\n\r\n---",
    "What is Cloudflare Email Routing?": "Cloudflare Email Routing provides two complementary capabilities:\r\n\r\n1. **Email Workers** - Receive and process incoming emails with custom logic (allowlists, blocklists, forwarding, parsing, replying)\r\n2. **Send Email** - Send emails from Workers to verified destination addresses (notifications, alerts, confirmations)\r\n\r\nBoth capabilities are **free** and work together to enable complete email functionality in Cloudflare Workers.\r\n\r\n---",
    "Package Versions (Verified 2025-10-23)": "```json\r\n{\r\n  \"dependencies\": {\r\n    \"postal-mime\": \"^2.5.0\",\r\n    \"mimetext\": \"^3.0.27\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@cloudflare/workers-types\": \"^4.20251014.0\",\r\n    \"wrangler\": \"^4.44.0\"\r\n  }\r\n}\r\n```\r\n\r\n---\r\n\r\n**Questions? Issues?**\r\n\r\n1. Check `references/common-errors.md` for detailed troubleshooting\r\n2. Review `references/dns-setup.md` for DNS configuration help\r\n3. See `references/local-development.md` for testing patterns\r\n4. Check official docs: https://developers.cloudflare.com/email-routing/\r\n5. Use `wrangler tail` for live debugging\r\n6. Verify all destination addresses are verified in dashboard",
    "Advanced Topics": "### Parsing Email Attachments\r\n\r\n```typescript\r\nimport PostalMime from 'postal-mime';\r\n\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    const parser = new PostalMime.default();\r\n    const email = await parser.parse(await new Response(message.raw).arrayBuffer());\r\n\r\n    // Access attachments\r\n    if (email.attachments && email.attachments.length > 0) {\r\n      for (const attachment of email.attachments) {\r\n        console.log('Attachment:', attachment.filename);\r\n        console.log('Type:', attachment.mimeType);\r\n        console.log('Size:', attachment.content.length);\r\n\r\n        // Store in R2\r\n        await env.BUCKET.put(\r\n          `emails/${Date.now()}-${attachment.filename}`,\r\n          attachment.content\r\n        );\r\n      }\r\n    }\r\n\r\n    await message.forward('inbox@yourdomain.com');\r\n  },\r\n};\r\n```\r\n\r\n---\r\n\r\n### Email-Based Task Creation\r\n\r\n```typescript\r\nimport PostalMime from 'postal-mime';\r\n\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    const parser = new PostalMime.default();\r\n    const email = await parser.parse(await new Response(message.raw).arrayBuffer());\r\n\r\n    // Extract task from email subject\r\n    const taskMatch = email.subject.match(/\\[TASK\\](.*)/i);\r\n\r\n    if (taskMatch) {\r\n      const taskDescription = taskMatch[1].trim();\r\n\r\n      // Create task in D1\r\n      await env.DB.prepare(\r\n        'INSERT INTO tasks (description, created_by, created_at) VALUES (?, ?, ?)'\r\n      ).bind(\r\n        taskDescription,\r\n        message.from,\r\n        new Date().toISOString()\r\n      ).run();\r\n\r\n      // Send confirmation\r\n      await message.reply(new EmailMessage(\r\n        'tasks@yourdomain.com',\r\n        message.from,\r\n        `Task created: ${taskDescription}`\r\n      ));\r\n    }\r\n  },\r\n};\r\n```\r\n\r\n---\r\n\r\n### Email-Triggered Workflows\r\n\r\n```typescript\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    // Trigger Cloudflare Workflow based on email\r\n    if (message.from.endsWith('@trusted-domain.com')) {\r\n      await env.WORKFLOW.create({\r\n        params: {\r\n          emailFrom: message.from,\r\n          emailTo: message.to,\r\n          receivedAt: new Date().toISOString(),\r\n        },\r\n      });\r\n    }\r\n\r\n    await message.forward('inbox@yourdomain.com');\r\n  },\r\n};\r\n```\r\n\r\n---",
    "Dependencies": "**Required**:\r\n- `postal-mime@2.5.0` - Parse incoming email messages\r\n- `mimetext@3.0.27` - Create email messages for sending\r\n\r\n**Built-in**:\r\n- `cloudflare:email` - EmailMessage class (no installation needed)\r\n\r\n**Optional**:\r\n- `@cloudflare/workers-types` - TypeScript type definitions\r\n\r\n---",
    "Common Patterns": "### Pattern 1: Allowlist\r\n\r\nOnly accept emails from approved senders:\r\n\r\n```typescript\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    const allowList = [\r\n      'friend@example.com',\r\n      'coworker@company.com',\r\n      'support@vendor.com',\r\n    ];\r\n\r\n    if (!allowList.includes(message.from)) {\r\n      message.setReject('Address not on allowlist');\r\n      return;\r\n    }\r\n\r\n    await message.forward('inbox@yourdomain.com');\r\n  },\r\n};\r\n```\r\n\r\n**When to use**: Contact forms, private email addresses, team inboxes\r\n\r\n---\r\n\r\n### Pattern 2: Blocklist\r\n\r\nReject emails from specific senders or domains:\r\n\r\n```typescript\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    const blockList = [\r\n      'spam@badactor.com',\r\n      '@suspicious-domain.com', // Block entire domain\r\n    ];\r\n\r\n    const isBlocked = blockList.some(pattern =>\r\n      message.from.includes(pattern)\r\n    );\r\n\r\n    if (isBlocked) {\r\n      message.setReject('Sender blocked');\r\n      return;\r\n    }\r\n\r\n    await message.forward('inbox@yourdomain.com');\r\n  },\r\n};\r\n```\r\n\r\n**When to use**: Spam filtering, blocking harassers, domain-level blocks\r\n\r\n---\r\n\r\n### Pattern 3: Parse and Store\r\n\r\nExtract email content and store in D1 or KV:\r\n\r\n```typescript\r\nimport PostalMime from 'postal-mime';\r\n\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    // Parse email\r\n    const parser = new PostalMime.default();\r\n    const rawEmail = new Response(message.raw);\r\n    const email = await parser.parse(await rawEmail.arrayBuffer());\r\n\r\n    // Store in D1\r\n    await env.DB.prepare(\r\n      'INSERT INTO emails (from_addr, subject, text, received_at) VALUES (?, ?, ?, ?)'\r\n    ).bind(\r\n      message.from,\r\n      email.subject,\r\n      email.text,\r\n      new Date().toISOString()\r\n    ).run();\r\n\r\n    // Forward to inbox\r\n    await message.forward('inbox@yourdomain.com');\r\n  },\r\n};\r\n```\r\n\r\n**When to use**: Email archiving, ticket systems, support inboxes, audit logs\r\n\r\n---\r\n\r\n### Pattern 4: Auto-Reply\r\n\r\nSend automatic replies with custom logic:\r\n\r\n```typescript\r\nimport PostalMime from 'postal-mime';\r\nimport { createMimeMessage } from 'mimetext';\r\nimport { EmailMessage } from 'cloudflare:email';\r\n\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    // Parse incoming email\r\n    const parser = new PostalMime.default();\r\n    const email = await parser.parse(await new Response(message.raw).arrayBuffer());\r\n\r\n    // Create reply\r\n    const msg = createMimeMessage();\r\n    msg.setSender({ name: 'Support Team', addr: 'support@yourdomain.com' });\r\n    msg.setRecipient(message.from);\r\n    msg.setHeader('In-Reply-To', message.headers.get('Message-ID'));\r\n    msg.setSubject(`Re: ${email.subject}`);\r\n    msg.addMessage({\r\n      contentType: 'text/plain',\r\n      data: `Thank you for your message about \"${email.subject}\". We'll respond within 24 hours.`,\r\n    });\r\n\r\n    // Send reply\r\n    const replyMessage = new EmailMessage(\r\n      'support@yourdomain.com',\r\n      message.from,\r\n      msg.asRaw()\r\n    );\r\n\r\n    await message.reply(replyMessage);\r\n\r\n    // Also forward to team inbox\r\n    await message.forward('team@yourdomain.com');\r\n  },\r\n};\r\n```\r\n\r\n**When to use**: Out-of-office replies, support ticket acknowledgments, automated responses\r\n\r\n---\r\n\r\n### Pattern 5: Conditional Routing\r\n\r\nRoute emails to different destinations based on content:\r\n\r\n```typescript\r\nimport PostalMime from 'postal-mime';\r\n\r\nexport default {\r\n  async email(message, env, ctx) {\r\n    const parser = new PostalMime.default();\r\n    const email = await parser.parse(await new Response(message.raw).arrayBuffer());\r\n\r\n    const subject = email.subject.toLowerCase();\r\n\r\n    // Route based on subject keywords\r\n    if (subject.includes('urgent') || subject.includes('critical')) {\r\n      await message.forward('oncall@yourdomain.com');\r\n    } else if (subject.includes('invoice') || subject.includes('payment')) {\r\n      await message.forward('billing@yourdomain.com');\r\n    } else if (subject.includes('support') || subject.includes('help')) {\r\n      await message.forward('support@yourdomain.com');\r\n    } else {\r\n      await message.forward('inbox@yourdomain.com');\r\n    }\r\n  },\r\n};\r\n```\r\n\r\n**When to use**: Department routing, priority filtering, category-based inboxes\r\n\r\n---",
    "Troubleshooting": "### Problem: \"Email Trigger not available to this workers\"\r\n\r\n**Solution**:\r\n- Deploy your worker: `npx wrangler deploy`\r\n- Test with real emails, not local simulation\r\n- Use `wrangler tail` to monitor processing\r\n\r\n---\r\n\r\n### Problem: \"Destination address not verified\"\r\n\r\n**Solution**:\r\n- Check Email Routing > Destination addresses in dashboard\r\n- Click \"Resend verification\" if needed\r\n- Create a regular forwarding rule first (workaround for bug)\r\n- Verify all addresses before deploying workers\r\n\r\n---\r\n\r\n### Problem: Gmail rejects emails with 421 error\r\n\r\n**Solution**:\r\n- Verify SPF/DKIM records are configured (automatic with Email Routing)\r\n- Reduce sending rate (max 50-100/hour for personal use)\r\n- Don't send unsolicited emails or bulk mail\r\n- Consider transactional email service for high volume\r\n\r\n---\r\n\r\n### Problem: Emails not forwarding from Email Worker\r\n\r\n**Solution**:\r\n- Check worker is bound to correct email route in dashboard\r\n- Verify destination address is verified\r\n- Use `wrangler tail` to see processing logs\r\n- Check for errors in worker code (try/catch around forward())\r\n- Confirm MX records are still pointing to Cloudflare\r\n\r\n---\r\n\r\n### Problem: Cannot see worker logs\r\n\r\n**Solution**:\r\n- Use `wrangler tail --format pretty` for live logs\r\n- Add extensive `console.log()` statements in worker\r\n- Store debug info in D1 or KV for later inspection\r\n- Upgrade to Workers Paid plan for better log retention\r\n\r\n---\r\n\r\n### Problem: Worker crashes with \"failed to call worker\"\r\n\r\n**Solution**:\r\n- Add try/catch error handling around all operations\r\n- Set timeouts for external API calls\r\n- Test with different email formats (plain text, HTML, attachments)\r\n- Check worker doesn't exceed CPU/memory limits\r\n- Use `ctx.waitUntil()` for non-blocking operations\r\n\r\n---",
    "Official Documentation": "- **Email Routing**: https://developers.cloudflare.com/email-routing/\r\n- **Email Workers**: https://developers.cloudflare.com/email-routing/email-workers/\r\n- **Send Email**: https://developers.cloudflare.com/email-routing/email-workers/send-email-workers/\r\n- **Runtime API**: https://developers.cloudflare.com/email-routing/email-workers/runtime-api/\r\n- **Local Development**: https://developers.cloudflare.com/email-routing/email-workers/local-development/\r\n- **postal-mime**: https://www.npmjs.com/package/postal-mime\r\n- **mimetext**: https://www.npmjs.com/package/mimetext\r\n\r\n---",
    "Local Development": "curl http://localhost:8787 -X POST \\\r\n  --data-binary @- << EOF\r\nFrom: sender@example.com\r\nTo: recipient@yourdomain.com\r\nSubject: Test Email\r\n\r\nThis is a test email body.\r\nEOF\r\n```\r\n\r\n**What happens**: Wrangler logs the email processing and shows where forwarded emails would go.\r\n\r\n### Sending Emails\r\n\r\nWrangler writes sent emails to local .eml files:\r\n\r\n```typescript\r\n// Your worker code\r\nawait env.EMAIL.send(message);\r\n```\r\n\r\n**Output in terminal**:\r\n```\r\n[wrangler:inf] send_email binding called with the following message:\r\n  /tmp/miniflare-abc123/files/email/message-123.eml\r\n```\r\n\r\n**View the email**:\r\n```bash\r\ncat /tmp/miniflare-abc123/files/email/message-123.eml\r\n```\r\n\r\n---",
    "Configuration Files Reference": "### Complete wrangler.jsonc (Both Receive + Send)\r\n\r\n```jsonc\r\n{\r\n  \"$schema\": \"node_modules/wrangler/config-schema.json\",\r\n  \"name\": \"email-worker\",\r\n  \"main\": \"src/email.ts\",\r\n  \"account_id\": \"YOUR_ACCOUNT_ID\",\r\n  \"compatibility_date\": \"2025-10-11\",\r\n  \"observability\": {\r\n    \"enabled\": true\r\n  },\r\n\r\n  // Send email binding\r\n  \"send_email\": [\r\n    {\r\n      \"name\": \"NOTIFICATIONS\",\r\n      \"destination_address\": \"notifications@yourdomain.com\"\r\n    },\r\n    {\r\n      \"name\": \"ALERTS\",\r\n      \"allowed_destination_addresses\": [\r\n        \"alerts@yourdomain.com\",\r\n        \"admin@yourdomain.com\"\r\n      ]\r\n    }\r\n  ],\r\n\r\n  // Optional: Add other bindings\r\n  \"d1_databases\": [\r\n    {\r\n      \"binding\": \"DB\",\r\n      \"database_name\": \"email-archive\",\r\n      \"database_id\": \"YOUR_DATABASE_ID\"\r\n    }\r\n  ],\r\n\r\n  \"kv_namespaces\": [\r\n    {\r\n      \"binding\": \"EMAIL_CACHE\",\r\n      \"id\": \"YOUR_KV_ID\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n---",
    "Send Email: Complete Guide": "### Configuration\r\n\r\n#### Single Destination (Simple)\r\n\r\n```jsonc\r\n{\r\n  \"send_email\": [\r\n    {\r\n      \"name\": \"EMAIL\",\r\n      \"destination_address\": \"notifications@yourdomain.com\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**Behavior**: All emails sent via `env.EMAIL` go to this address.\r\n\r\n#### Multiple Destinations (Flexible)\r\n\r\n```jsonc\r\n{\r\n  \"send_email\": [\r\n    {\r\n      \"name\": \"EMAIL\",\r\n      \"allowed_destination_addresses\": [\r\n        \"notifications@yourdomain.com\",\r\n        \"alerts@yourdomain.com\",\r\n        \"user@gmail.com\"\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**Behavior**: Can send to any address in the list.\r\n\r\n#### Multiple Bindings (Organized)\r\n\r\n```jsonc\r\n{\r\n  \"send_email\": [\r\n    {\r\n      \"name\": \"NOTIFICATIONS\",\r\n      \"destination_address\": \"notifications@yourdomain.com\"\r\n    },\r\n    {\r\n      \"name\": \"ALERTS\",\r\n      \"destination_address\": \"alerts@yourdomain.com\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**Behavior**: Use different bindings for different purposes.\r\n\r\n---\r\n\r\n### Sending Emails\r\n\r\n#### Basic Text Email\r\n\r\n```typescript\r\nimport { EmailMessage } from 'cloudflare:email';\r\nimport { createMimeMessage } from 'mimetext';\r\n\r\nconst msg = createMimeMessage();\r\nmsg.setSender({ name: 'My App', addr: 'noreply@yourdomain.com' });\r\nmsg.setRecipient('user@example.com');\r\nmsg.setSubject('Welcome!');\r\nmsg.addMessage({\r\n  contentType: 'text/plain',\r\n  data: 'Welcome to our service!',\r\n});\r\n\r\nconst email = new EmailMessage(\r\n  'noreply@yourdomain.com',\r\n  'user@example.com',\r\n  msg.asRaw()\r\n);\r\n\r\nawait env.EMAIL.send(email);\r\n```\r\n\r\n#### HTML Email\r\n\r\n```typescript\r\nimport { EmailMessage } from 'cloudflare:email';\r\nimport { createMimeMessage } from 'mimetext';\r\n\r\nconst msg = createMimeMessage();\r\nmsg.setSender({ name: 'My App', addr: 'noreply@yourdomain.com' });\r\nmsg.setRecipient('user@example.com');\r\nmsg.setSubject('Welcome!');\r\n\r\n// Add both plain text and HTML versions\r\nmsg.addMessage({\r\n  contentType: 'text/plain',\r\n  data: 'Welcome to our service!',\r\n});\r\n\r\nmsg.addMessage({\r\n  contentType: 'text/html',\r\n  data: '<h1>Welcome!</h1><p>Thanks for joining us.</p>',\r\n});\r\n\r\nconst email = new EmailMessage(\r\n  'noreply@yourdomain.com',\r\n  'user@example.com',\r\n  msg.asRaw()\r\n);\r\n\r\nawait env.EMAIL.send(email);\r\n```\r\n\r\n#### Email with Custom Headers\r\n\r\n```typescript\r\nimport { EmailMessage } from 'cloudflare:email';\r\nimport { createMimeMessage } from 'mimetext';\r\n\r\nconst msg = createMimeMessage();\r\nmsg.setSender({ name: 'My App', addr: 'noreply@yourdomain.com' });\r\nmsg.setRecipient('user@example.com');\r\nmsg.setSubject('Password Reset');\r\n\r\n// Add custom headers\r\nmsg.setHeader('X-Priority', '1');\r\nmsg.setHeader('X-Application-ID', 'my-app-123');\r\n\r\nmsg.addMessage({\r\n  contentType: 'text/plain',\r\n  data: 'Click here to reset your password...',\r\n});\r\n\r\nconst email = new EmailMessage(\r\n  'noreply@yourdomain.com',\r\n  'user@example.com',\r\n  msg.asRaw()\r\n);\r\n\r\nawait env.EMAIL.send(email);\r\n```\r\n\r\n---"
  }
}
{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/error-codes.md",
      "references/example-reference.md",
      "references/react-integration.md",
      "references/testing-guide.md",
      "references/widget-configs.md"
    ]
  },
  "content": "**Status**: Production Ready\r\n**Last Updated**: 2025-10-22\r\n**Dependencies**: None (optional: @marsidev/react-turnstile for React)\r\n**Latest Versions**: @marsidev/react-turnstile@1.3.1, turnstile-types@1.2.3\r\n\r\n---\r\n\r\n\r\n### 1. Create Turnstile Widget\r\n\r\nGet your sitekey and secret key from Cloudflare Dashboard.\r\n\r\n```bash",
  "name": "cloudflare-turnstile",
  "id": "cloudflare-turnstile",
  "sections": {
    "Troubleshooting": "### Problem: Error 110200 - \"Unknown domain\"\r\n**Solution**: Add your domain (including localhost for dev) to widget's allowed domains in Cloudflare Dashboard. For local dev, use dummy test sitekey `1x00000000000000000000AA` instead.\r\n\r\n### Problem: Error 300030 - Widget crashes for legitimate users\r\n**Solution**: Implement error callback with retry logic. This is a known Cloudflare-side issue (2025). Fallback to alternative verification if retries fail.\r\n\r\n### Problem: Tokens always return `success: false`\r\n**Solution**:\r\n1. Check token hasn't expired (5 min TTL)\r\n2. Verify secret key is correct\r\n3. Ensure token hasn't been validated before (single-use)\r\n4. Check hostname matches widget configuration\r\n\r\n### Problem: CSP blocking iframe (Error 200500)\r\n**Solution**: Add CSP directives:\r\n```html\r\n<meta http-equiv=\"Content-Security-Policy\" content=\"\r\n  frame-src https://challenges.cloudflare.com;\r\n  script-src https://challenges.cloudflare.com;\r\n\">\r\n```\r\n\r\n### Problem: Safari 18 \"Hide IP\" causing Error 300010\r\n**Solution**: Document in error message that users should disable Safari's \"Hide IP address\" setting (Safari → Settings → Privacy → Hide IP address → Off)\r\n\r\n### Problem: Next.js + Jest tests failing with @marsidev/react-turnstile\r\n**Solution**: Mock the Turnstile component in Jest setup:\r\n```typescript\r\n// jest.setup.ts\r\njest.mock('@marsidev/react-turnstile', () => ({\r\n  Turnstile: () => <div data-testid=\"turnstile-mock\" />,\r\n}))\r\n```\r\n\r\n---",
    "Known Issues Prevention": "This skill prevents **12** documented issues:\r\n\r\n### Issue #1: Missing Server-Side Validation\r\n**Error**: Zero token validation in Turnstile Analytics dashboard\r\n**Source**: https://developers.cloudflare.com/turnstile/get-started/\r\n**Why It Happens**: Developers only implement client-side widget, skip Siteverify call\r\n**Prevention**: All templates include mandatory server-side validation with Siteverify API\r\n\r\n### Issue #2: Token Expiration (5 Minutes)\r\n**Error**: `success: false` for valid tokens submitted after delay\r\n**Source**: https://developers.cloudflare.com/turnstile/get-started/server-side-validation\r\n**Why It Happens**: Tokens expire 300 seconds after generation\r\n**Prevention**: Templates document TTL and implement token refresh on expiration\r\n\r\n### Issue #3: Secret Key Exposed in Frontend\r\n**Error**: Security bypass - attackers can validate their own tokens\r\n**Source**: https://developers.cloudflare.com/turnstile/get-started/server-side-validation\r\n**Why It Happens**: Secret key hardcoded in JavaScript or visible in source\r\n**Prevention**: All templates show backend-only validation with environment variables\r\n\r\n### Issue #4: GET Request to Siteverify\r\n**Error**: API returns 405 Method Not Allowed\r\n**Source**: https://developers.cloudflare.com/turnstile/migration/recaptcha\r\n**Why It Happens**: reCAPTCHA supports GET, Turnstile requires POST\r\n**Prevention**: Templates use POST with FormData or JSON body\r\n\r\n### Issue #5: Content Security Policy Blocking\r\n**Error**: Error 200500 - \"Loading error: The iframe could not be loaded\"\r\n**Source**: https://developers.cloudflare.com/turnstile/troubleshooting/client-side-errors/error-codes\r\n**Why It Happens**: CSP blocks challenges.cloudflare.com iframe\r\n**Prevention**: Skill includes CSP configuration reference and check-csp.sh script\r\n\r\n### Issue #6: Widget Crash (Error 300030)\r\n**Error**: Generic client execution error for legitimate users\r\n**Source**: https://community.cloudflare.com/t/turnstile-is-frequently-generating-300x-errors/700903\r\n**Why It Happens**: Unknown - appears to be Cloudflare-side issue (2025)\r\n**Prevention**: Templates implement error callbacks, retry logic, and fallback handling\r\n\r\n### Issue #7: Configuration Error (Error 600010)\r\n**Error**: Widget fails with \"configuration error\"\r\n**Source**: https://community.cloudflare.com/t/repeated-cloudflare-turnstile-error-600010/644578\r\n**Why It Happens**: Missing or deleted hostname in widget configuration\r\n**Prevention**: Templates document hostname allowlist requirement and verification steps\r\n\r\n### Issue #8: Safari 18 / macOS 15 \"Hide IP\" Issue\r\n**Error**: Error 300010 when Safari's \"Hide IP address\" is enabled\r\n**Source**: https://community.cloudflare.com/t/turnstile-is-frequently-generating-300x-errors/700903\r\n**Why It Happens**: Privacy settings interfere with challenge signals\r\n**Prevention**: Error handling reference documents Safari workaround (disable Hide IP)\r\n\r\n### Issue #9: Brave Browser Confetti Animation Failure\r\n**Error**: Verification fails during success animation\r\n**Source**: https://github.com/brave/brave-browser/issues/45608 (April 2025)\r\n**Why It Happens**: Brave shields block animation scripts\r\n**Prevention**: Templates handle success before animation completes\r\n\r\n### Issue #10: Next.js + Jest Incompatibility\r\n**Error**: @marsidev/react-turnstile breaks Jest tests\r\n**Source**: https://github.com/marsidev/react-turnstile/issues/112 (Oct 2025)\r\n**Why It Happens**: Module resolution issues with Jest\r\n**Prevention**: Testing guide includes Jest mocking patterns and dummy sitekey usage\r\n\r\n### Issue #11: localhost Not in Allowlist\r\n**Error**: Error 110200 - \"Unknown domain: Domain not allowed\"\r\n**Source**: https://developers.cloudflare.com/turnstile/troubleshooting/client-side-errors/error-codes\r\n**Why It Happens**: Production widget used in development without localhost in allowlist\r\n**Prevention**: Templates use dummy test keys for dev, document localhost allowlist requirement\r\n\r\n### Issue #12: Token Reuse Attempt\r\n**Error**: `success: false` with \"token already spent\" error\r\n**Source**: https://developers.cloudflare.com/turnstile/troubleshooting/testing\r\n**Why It Happens**: Each token can only be validated once\r\n**Prevention**: Templates document single-use constraint and token refresh patterns\r\n\r\n---",
    "Complete Setup Checklist": "Use this checklist to verify your setup:\r\n\r\n- [ ] Created Turnstile widget in Cloudflare Dashboard\r\n- [ ] Added allowed domains (including localhost for dev)\r\n- [ ] Frontend widget loads from `https://challenges.cloudflare.com/turnstile/v0/api.js`\r\n- [ ] Widget renders with correct sitekey\r\n- [ ] Error callback implemented and tested\r\n- [ ] Server-side Siteverify validation implemented\r\n- [ ] Secret key stored in environment variable (not hardcoded)\r\n- [ ] Token validation includes remoteip check\r\n- [ ] CSP allows challenges.cloudflare.com (if using CSP)\r\n- [ ] Testing uses dummy sitekeys (`1x00000000000000000000AA`)\r\n- [ ] Token expiration handling implemented (5 min TTL)\r\n- [ ] Widget accessibility tested (keyboard navigation, screen readers)\r\n- [ ] Error states display user-friendly messages\r\n- [ ] Production deployment uses separate widget from dev/staging\r\n\r\n---\r\n\r\n**Questions? Issues?**\r\n\r\n1. Check `references/error-codes.md` for specific error troubleshooting\r\n2. Verify all steps in the 3-Step Setup Process\r\n3. Check official docs: https://developers.cloudflare.com/turnstile/\r\n4. Ensure server-side validation is implemented (most common issue)\r\n5. Use Cloudflare Docs MCP tool: `mcp__cloudflare-docs__search_cloudflare_documentation`\r\n\r\n---\r\n\r\n**Token Efficiency**: ~65-70% savings (10-12k tokens → 3-4k tokens)\r\n\r\n**Errors Prevented**: 12 documented issues with complete solutions",
    "Package Versions (Verified 2025-10-22)": "```json\r\n{\r\n  \"devDependencies\": {\r\n    \"@marsidev/react-turnstile\": \"^1.3.1\",\r\n    \"turnstile-types\": \"^1.2.3\"\r\n  }\r\n}\r\n```\r\n\r\n**Notes:**\r\n- @marsidev/react-turnstile is Cloudflare's recommended React package\r\n- Last updated September 2025 (actively maintained)\r\n- Compatible with React 18+, Next.js 13+, Next.js 14+, Next.js 15+\r\n\r\n---",
    "Configuration Files Reference": "### wrangler.jsonc (Cloudflare Workers)\r\n\r\n```jsonc\r\n{\r\n  \"name\": \"my-app\",\r\n  \"main\": \"src/index.ts\",\r\n  \"compatibility_date\": \"2025-10-22\",\r\n\r\n  // Public sitekey (safe to commit)\r\n  \"vars\": {\r\n    \"TURNSTILE_SITE_KEY\": \"1x00000000000000000000AA\" // Use real key in production\r\n  },\r\n\r\n  // Secret key (DO NOT commit - use wrangler secret)\r\n  // Run: wrangler secret put TURNSTILE_SECRET_KEY\r\n  \"secrets\": [\"TURNSTILE_SECRET_KEY\"]\r\n}\r\n```\r\n\r\n**Why these settings:**\r\n- `vars` for public sitekey (visible in client code)\r\n- `secrets` for private secret key (encrypted, backend-only)\r\n- Use dummy keys for development (see testing-guide.md)\r\n- Rotate production secret keys quarterly\r\n\r\n### Required CSP Directives\r\n\r\n```html\r\n<meta http-equiv=\"Content-Security-Policy\" content=\"\r\n  script-src 'self' https://challenges.cloudflare.com;\r\n  frame-src 'self' https://challenges.cloudflare.com;\r\n  connect-src 'self' https://challenges.cloudflare.com;\r\n\">\r\n```\r\n\r\n---",
    "Critical Rules": "### Always Do\r\n\r\n✅ **Call Siteverify API** - Server-side validation is mandatory\r\n✅ **Use HTTPS** - Never validate over HTTP\r\n✅ **Protect secret keys** - Never expose in frontend code\r\n✅ **Handle token expiration** - Tokens expire after 5 minutes\r\n✅ **Implement error callbacks** - Handle failures gracefully\r\n✅ **Use dummy keys for testing** - Test sitekey: `1x00000000000000000000AA`\r\n✅ **Set reasonable timeouts** - Don't wait indefinitely for validation\r\n✅ **Validate action/hostname** - Check additional fields when specified\r\n✅ **Rotate keys periodically** - Use dashboard or API to rotate secrets\r\n✅ **Monitor analytics** - Track solve rates and failures\r\n\r\n### Never Do\r\n\r\n❌ **Skip server validation** - Client-side only = security vulnerability\r\n❌ **Proxy api.js script** - Must load from Cloudflare CDN\r\n❌ **Reuse tokens** - Each token is single-use only\r\n❌ **Use GET requests** - Siteverify only accepts POST\r\n❌ **Expose secret key** - Keep secrets in backend environment only\r\n❌ **Trust client-side validation** - Tokens can be forged\r\n❌ **Cache api.js** - Future updates will break your integration\r\n❌ **Use production keys in tests** - Use dummy keys instead\r\n❌ **Ignore error callbacks** - Always handle failures\r\n\r\n---",
    "Advanced Topics": "### Pre-Clearance for SPAs\r\n\r\nTurnstile can issue a pre-clearance cookie that persists across page navigations in single-page applications.\r\n\r\n```typescript\r\nturnstile.render('#container', {\r\n  sitekey: SITE_KEY,\r\n  callback: async (token) => {\r\n    // Request pre-clearance cookie\r\n    await fetch('/api/pre-clearance', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ token }),\r\n    })\r\n  },\r\n})\r\n```\r\n\r\n### Custom Actions and cData\r\n\r\nTrack different challenge types or pass custom data:\r\n\r\n```typescript\r\nturnstile.render('#container', {\r\n  sitekey: SITE_KEY,\r\n  action: 'login', // Track action in analytics\r\n  cdata: JSON.stringify({ userId: '123' }), // Custom data (max 255 chars)\r\n  callback: (token) => {\r\n    // Token includes action and cdata for server validation\r\n  },\r\n})\r\n```\r\n\r\n**Server-side verification:**\r\n```typescript\r\nconst result = await validateTurnstile(token, secretKey)\r\n\r\nif (result.action !== 'login') {\r\n  return new Response('Invalid action', { status: 400 })\r\n}\r\n\r\nconst customData = JSON.parse(result.cdata || '{}')\r\n```\r\n\r\n### Retry and Error Handling Strategies\r\n\r\n```typescript\r\nclass TurnstileWithRetry {\r\n  private retryCount = 0\r\n  private maxRetries = 3\r\n\r\n  render(containerId: string) {\r\n    turnstile.render(containerId, {\r\n      sitekey: SITE_KEY,\r\n      retry: 'auto', // or 'never' for manual control\r\n      'retry-interval': 8000, // ms between retries\r\n      'error-callback': (error) => {\r\n        this.handleError(error)\r\n      },\r\n    })\r\n  }\r\n\r\n  private handleError(error: string) {\r\n    // Error codes that should not retry\r\n    const noRetry = ['110100', '110200', '110500']\r\n\r\n    if (noRetry.some(code => error.includes(code))) {\r\n      this.showFallback()\r\n      return\r\n    }\r\n\r\n    // Retry on transient errors\r\n    if (this.retryCount < this.maxRetries) {\r\n      this.retryCount++\r\n      setTimeout(() => {\r\n        turnstile.reset(this.widgetId)\r\n      }, 2000 * this.retryCount) // Exponential backoff\r\n    } else {\r\n      this.showFallback()\r\n    }\r\n  }\r\n\r\n  private showFallback() {\r\n    // Show alternative verification method\r\n    console.error('Turnstile failed - showing fallback')\r\n  }\r\n}\r\n```\r\n\r\n### Multi-Widget Pages\r\n\r\n```typescript\r\nconst widgets = {\r\n  login: null as string | null,\r\n  signup: null as string | null,\r\n}\r\n\r\n// Render multiple widgets\r\nwidgets.login = turnstile.render('#login-widget', {\r\n  sitekey: SITE_KEY,\r\n  action: 'login',\r\n})\r\n\r\nwidgets.signup = turnstile.render('#signup-widget', {\r\n  sitekey: SITE_KEY,\r\n  action: 'signup',\r\n})\r\n\r\n// Reset specific widget\r\nturnstile.reset(widgets.login)\r\n\r\n// Get token from specific widget\r\nconst loginToken = turnstile.getResponse(widgets.login)\r\n```\r\n\r\n---",
    "Dependencies": "**Required:**\r\n- None (Turnstile loads from CDN)\r\n\r\n**Optional (React):**\r\n- `@marsidev/react-turnstile@1.3.1` - Official Cloudflare-recommended React integration\r\n- `turnstile-types@1.2.3` - TypeScript type definitions\r\n\r\n**Optional (Other Frameworks):**\r\n- `vue-turnstile` - Vue 3 integration\r\n- `cfturnstile-vue3` - Alternative Vue 3 wrapper\r\n- `ngx-turnstile` - Angular integration\r\n- `svelte-turnstile` - Svelte integration\r\n- `@nuxtjs/turnstile` - Nuxt full-stack integration\r\n\r\n---",
    "Common Patterns": "### Pattern 1: Hono + Cloudflare Workers\r\n\r\n```typescript\r\nimport { Hono } from 'hono'\r\n\r\ntype Bindings = {\r\n  TURNSTILE_SECRET_KEY: string\r\n  TURNSTILE_SITE_KEY: string\r\n}\r\n\r\nconst app = new Hono<{ Bindings: Bindings }>()\r\n\r\napp.post('/api/login', async (c) => {\r\n  const body = await c.req.formData()\r\n  const token = body.get('cf-turnstile-response')\r\n\r\n  if (!token) {\r\n    return c.text('Missing Turnstile token', 400)\r\n  }\r\n\r\n  // Validate token\r\n  const verifyFormData = new FormData()\r\n  verifyFormData.append('secret', c.env.TURNSTILE_SECRET_KEY)\r\n  verifyFormData.append('response', token.toString())\r\n  verifyFormData.append('remoteip', c.req.header('CF-Connecting-IP') || '')\r\n\r\n  const verifyResult = await fetch(\r\n    'https://challenges.cloudflare.com/turnstile/v0/siteverify',\r\n    {\r\n      method: 'POST',\r\n      body: verifyFormData,\r\n    }\r\n  )\r\n\r\n  const outcome = await verifyResult.json<{ success: boolean }>()\r\n\r\n  if (!outcome.success) {\r\n    return c.text('Invalid Turnstile token', 401)\r\n  }\r\n\r\n  // Process login\r\n  return c.json({ message: 'Login successful' })\r\n})\r\n\r\nexport default app\r\n```\r\n\r\n**When to use**: API routes in Cloudflare Workers with Hono framework\r\n\r\n### Pattern 2: React + Next.js App Router\r\n\r\n```tsx\r\n'use client'\r\n\r\nimport { Turnstile } from '@marsidev/react-turnstile'\r\nimport { useState } from 'react'\r\n\r\nexport function ContactForm() {\r\n  const [token, setToken] = useState<string>()\r\n  const [error, setError] = useState<string>()\r\n\r\n  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {\r\n    e.preventDefault()\r\n\r\n    if (!token) {\r\n      setError('Please complete the challenge')\r\n      return\r\n    }\r\n\r\n    const formData = new FormData(e.currentTarget)\r\n    formData.append('cf-turnstile-response', token)\r\n\r\n    const response = await fetch('/api/contact', {\r\n      method: 'POST',\r\n      body: formData,\r\n    })\r\n\r\n    if (!response.ok) {\r\n      setError('Submission failed')\r\n      return\r\n    }\r\n\r\n    // Success\r\n  }\r\n\r\n  return (\r\n    <form onSubmit={handleSubmit}>\r\n      <input name=\"email\" type=\"email\" required />\r\n      <textarea name=\"message\" required />\r\n\r\n      <Turnstile\r\n        siteKey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY!}\r\n        onSuccess={setToken}\r\n        onError={() => setError('Challenge failed')}\r\n        onExpire={() => setToken(undefined)}\r\n      />\r\n\r\n      {error && <div className=\"error\">{error}</div>}\r\n\r\n      <button type=\"submit\" disabled={!token}>\r\n        Submit\r\n      </button>\r\n    </form>\r\n  )\r\n}\r\n```\r\n\r\n**When to use**: Client-side forms in Next.js with React hooks\r\n\r\n### Pattern 3: E2E Testing with Dummy Keys\r\n\r\n```typescript\r\n// test/helpers/turnstile.ts\r\nexport const TEST_TURNSTILE = {\r\n  sitekey: {\r\n    alwaysPass: '1x00000000000000000000AA',\r\n    alwaysBlock: '2x00000000000000000000AB',\r\n    invisible: '1x00000000000000000000BB',\r\n    interactive: '3x00000000000000000000FF',\r\n  },\r\n  secretKey: {\r\n    alwaysPass: '1x0000000000000000000000000000000AA',\r\n    alwaysFail: '2x0000000000000000000000000000000AA',\r\n    tokenSpent: '3x0000000000000000000000000000000AA',\r\n  },\r\n  dummyToken: 'XXXX.DUMMY.TOKEN.XXXX',\r\n}\r\n\r\n// Playwright test example\r\ntest('form submission with Turnstile', async ({ page }) => {\r\n  // Set test environment\r\n  await page.goto('/contact?test=true')\r\n\r\n  // Widget uses test sitekey in test mode\r\n  await page.fill('input[name=\"email\"]', 'test@example.com')\r\n\r\n  // Turnstile auto-solves with dummy token\r\n  await page.click('button[type=\"submit\"]')\r\n\r\n  await expect(page.locator('.success')).toBeVisible()\r\n})\r\n```\r\n\r\n**When to use**: Automated testing (Playwright, Cypress, Jest)\r\n\r\n### Pattern 4: Widget Lifecycle Management\r\n\r\n```typescript\r\nclass TurnstileManager {\r\n  private widgetId: string | null = null\r\n  private sitekey: string\r\n\r\n  constructor(sitekey: string) {\r\n    this.sitekey = sitekey\r\n  }\r\n\r\n  render(containerId: string, callbacks: {\r\n    onSuccess: (token: string) => void\r\n    onError: (error: string) => void\r\n  }) {\r\n    if (this.widgetId !== null) {\r\n      this.reset() // Reset if already rendered\r\n    }\r\n\r\n    this.widgetId = turnstile.render(containerId, {\r\n      sitekey: this.sitekey,\r\n      callback: callbacks.onSuccess,\r\n      'error-callback': callbacks.onError,\r\n      'expired-callback': () => this.reset(),\r\n    })\r\n\r\n    return this.widgetId\r\n  }\r\n\r\n  reset() {\r\n    if (this.widgetId !== null) {\r\n      turnstile.reset(this.widgetId)\r\n    }\r\n  }\r\n\r\n  remove() {\r\n    if (this.widgetId !== null) {\r\n      turnstile.remove(this.widgetId)\r\n      this.widgetId = null\r\n    }\r\n  }\r\n\r\n  getToken(): string | undefined {\r\n    if (this.widgetId === null) return undefined\r\n    return turnstile.getResponse(this.widgetId)\r\n  }\r\n}\r\n\r\n// Usage\r\nconst manager = new TurnstileManager(SITE_KEY)\r\nmanager.render('#container', {\r\n  onSuccess: (token) => console.log('Token:', token),\r\n  onError: (error) => console.error('Error:', error),\r\n})\r\n```\r\n\r\n**When to use**: SPAs requiring programmatic widget control\r\n\r\n---",
    "The 3-Step Setup Process": "### Step 1: Create Widget Configuration\r\n\r\n1. Log into Cloudflare Dashboard\r\n2. Navigate to Turnstile section\r\n3. Click \"Add Site\"\r\n4. Configure:\r\n   - **Widget Mode**: Managed (recommended), Non-Interactive, or Invisible\r\n   - **Domains**: Add allowed hostnames (e.g., example.com, localhost for dev)\r\n   - **Name**: Descriptive name (e.g., \"Production Login Form\")\r\n\r\n**Key Points:**\r\n- Use separate widgets for dev/staging/production\r\n- Restrict domains to only those you control\r\n- Managed mode provides best balance of security and UX\r\n- localhost must be explicitly added for local testing\r\n\r\n### Step 2: Client-Side Integration\r\n\r\nChoose between implicit or explicit rendering:\r\n\r\n**Implicit Rendering** (Recommended for static forms):\r\n```html\r\n<!-- 1. Load script -->\r\n<script src=\"https://challenges.cloudflare.com/turnstile/v0/api.js\" async defer></script>\r\n\r\n<!-- 2. Add widget -->\r\n<div class=\"cf-turnstile\"\r\n     data-sitekey=\"YOUR_SITE_KEY\"\r\n     data-callback=\"onSuccess\"\r\n     data-error-callback=\"onError\"></div>\r\n\r\n<script>\r\nfunction onSuccess(token) {\r\n  console.log('Turnstile success:', token)\r\n}\r\n\r\nfunction onError(error) {\r\n  console.error('Turnstile error:', error)\r\n}\r\n</script>\r\n```\r\n\r\n**Explicit Rendering** (For SPAs/dynamic UIs):\r\n```typescript\r\n// 1. Load script with explicit mode\r\n<script src=\"https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit\" defer></script>\r\n\r\n// 2. Render programmatically\r\nconst widgetId = turnstile.render('#container', {\r\n  sitekey: 'YOUR_SITE_KEY',\r\n  callback: (token) => {\r\n    console.log('Token:', token)\r\n  },\r\n  'error-callback': (error) => {\r\n    console.error('Error:', error)\r\n  },\r\n  theme: 'auto',\r\n  execution: 'render', // or 'execute' for manual trigger\r\n})\r\n\r\n// Control lifecycle\r\nturnstile.reset(widgetId)        // Reset widget\r\nturnstile.remove(widgetId)       // Remove widget\r\nturnstile.execute(widgetId)      // Manually trigger challenge\r\nconst token = turnstile.getResponse(widgetId) // Get current token\r\n```\r\n\r\n**React Integration** (using @marsidev/react-turnstile):\r\n```tsx\r\nimport { Turnstile } from '@marsidev/react-turnstile'\r\n\r\nexport function MyForm() {\r\n  const [token, setToken] = useState<string>()\r\n\r\n  return (\r\n    <form>\r\n      <Turnstile\r\n        siteKey={TURNSTILE_SITE_KEY}\r\n        onSuccess={setToken}\r\n        onError={(error) => console.error(error)}\r\n      />\r\n      <button disabled={!token}>Submit</button>\r\n    </form>\r\n  )\r\n}\r\n```\r\n\r\n### Step 3: Server-Side Validation\r\n\r\n**MANDATORY**: Always call Siteverify API to validate tokens.\r\n\r\n```typescript\r\ninterface TurnstileResponse {\r\n  success: boolean\r\n  challenge_ts?: string\r\n  hostname?: string\r\n  error-codes?: string[]\r\n  action?: string\r\n  cdata?: string\r\n}\r\n\r\nasync function validateTurnstile(\r\n  token: string,\r\n  secretKey: string,\r\n  options?: {\r\n    remoteip?: string\r\n    idempotency_key?: string\r\n    expectedAction?: string\r\n    expectedHostname?: string\r\n  }\r\n): Promise<TurnstileResponse> {\r\n  const formData = new FormData()\r\n  formData.append('secret', secretKey)\r\n  formData.append('response', token)\r\n\r\n  if (options?.remoteip) {\r\n    formData.append('remoteip', options.remoteip)\r\n  }\r\n\r\n  if (options?.idempotency_key) {\r\n    formData.append('idempotency_key', options.idempotency_key)\r\n  }\r\n\r\n  const response = await fetch(\r\n    'https://challenges.cloudflare.com/turnstile/v0/siteverify',\r\n    {\r\n      method: 'POST',\r\n      body: formData,\r\n    }\r\n  )\r\n\r\n  const result = await response.json<TurnstileResponse>()\r\n\r\n  // Additional validation\r\n  if (result.success) {\r\n    if (options?.expectedAction && result.action !== options.expectedAction) {\r\n      return { success: false, 'error-codes': ['action-mismatch'] }\r\n    }\r\n\r\n    if (options?.expectedHostname && result.hostname !== options.expectedHostname) {\r\n      return { success: false, 'error-codes': ['hostname-mismatch'] }\r\n    }\r\n  }\r\n\r\n  return result\r\n}\r\n\r\n// Usage in Cloudflare Worker\r\nconst result = await validateTurnstile(\r\n  token,\r\n  env.TURNSTILE_SECRET_KEY,\r\n  {\r\n    remoteip: request.headers.get('CF-Connecting-IP'),\r\n    expectedHostname: 'example.com',\r\n  }\r\n)\r\n\r\nif (!result.success) {\r\n  return new Response('Turnstile validation failed', { status: 401 })\r\n}\r\n```\r\n\r\n---",
    "Production Example": "This skill is based on production implementations:\r\n\r\n- **Cloudflare Workers**: Official HTMLRewriter example\r\n- **React Apps**: @marsidev/react-turnstile (Cloudflare-verified)\r\n- **Community**: WordPress, Craft CMS, SilverStripe, Statamic integrations\r\n- **Validation**: ✅ All 12 known issues documented and prevented\r\n\r\n---",
    "Official Documentation": "- **Cloudflare Turnstile**: https://developers.cloudflare.com/turnstile/\r\n- **Get Started**: https://developers.cloudflare.com/turnstile/get-started/\r\n- **Client-Side Rendering**: https://developers.cloudflare.com/turnstile/get-started/client-side-rendering/\r\n- **Server-Side Validation**: https://developers.cloudflare.com/turnstile/get-started/server-side-validation/\r\n- **Error Codes**: https://developers.cloudflare.com/turnstile/troubleshooting/client-side-errors/error-codes/\r\n- **Testing**: https://developers.cloudflare.com/turnstile/troubleshooting/testing/\r\n- **Community Resources**: https://developers.cloudflare.com/turnstile/community-resources/\r\n- **Migration from reCAPTCHA**: https://developers.cloudflare.com/turnstile/migration/recaptcha/\r\n- **Cloudflare MCP**: Use `mcp__cloudflare-docs__search_cloudflare_documentation` tool\r\n\r\n---",
    "Quick Start (10 Minutes)": "```\r\n\r\n**Why this matters:**\r\n- Each widget has unique sitekey/secret pair\r\n- Sitekey goes in frontend (public)\r\n- Secret key ONLY in backend (private)\r\n- Use different widgets for dev/staging/production\r\n\r\n### 2. Add Widget to Frontend\r\n\r\nEmbed the Turnstile widget in your HTML form.\r\n\r\n```html\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <script src=\"https://challenges.cloudflare.com/turnstile/v0/api.js\" async defer></script>\r\n</head>\r\n<body>\r\n  <form id=\"myForm\" action=\"/submit\" method=\"POST\">\r\n    <input type=\"email\" name=\"email\" required>\r\n    <!-- Turnstile widget renders here -->\r\n    <div class=\"cf-turnstile\" data-sitekey=\"YOUR_SITE_KEY\"></div>\r\n    <button type=\"submit\">Submit</button>\r\n  </form>\r\n</body>\r\n</html>\r\n```\r\n\r\n**CRITICAL:**\r\n- Never proxy or cache `api.js` - must load from Cloudflare CDN\r\n- Widget auto-creates hidden input `cf-turnstile-response` with token\r\n- Token expires in 5 minutes\r\n- Each token is single-use only\r\n\r\n### 3. Validate Token on Server\r\n\r\nALWAYS validate the token server-side. Client-side verification alone is not secure.\r\n\r\n```typescript\r\n// Cloudflare Workers example\r\nexport default {\r\n  async fetch(request: Request, env: Env): Promise<Response> {\r\n    const formData = await request.formData()\r\n    const token = formData.get('cf-turnstile-response')\r\n    const ip = request.headers.get('CF-Connecting-IP')\r\n\r\n    // Validate token with Siteverify API\r\n    const verifyFormData = new FormData()\r\n    verifyFormData.append('secret', env.TURNSTILE_SECRET_KEY)\r\n    verifyFormData.append('response', token)\r\n    verifyFormData.append('remoteip', ip)\r\n\r\n    const result = await fetch(\r\n      'https://challenges.cloudflare.com/turnstile/v0/siteverify',\r\n      {\r\n        method: 'POST',\r\n        body: verifyFormData,\r\n      }\r\n    )\r\n\r\n    const outcome = await result.json()\r\n\r\n    if (!outcome.success) {\r\n      return new Response('Invalid Turnstile token', { status: 401 })\r\n    }\r\n\r\n    // Token valid - proceed with form processing\r\n    return new Response('Success!')\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Using Bundled Resources": "### Scripts (scripts/)\r\n\r\n- **check-csp.sh** - Verifies Content Security Policy allows Turnstile scripts and iframes\r\n\r\n**Example Usage:**\r\n```bash\r\n./scripts/check-csp.sh https://example.com\r\n```\r\n\r\n### References (references/)\r\n\r\n- `references/widget-configs.md` - Complete reference of all widget configuration options\r\n- `references/error-codes.md` - Comprehensive error code reference with troubleshooting\r\n- `references/testing-guide.md` - Testing strategies, dummy keys, E2E patterns\r\n- `references/react-integration.md` - React-specific patterns and @marsidev/react-turnstile usage\r\n\r\n**When Claude should load these**:\r\n- `widget-configs.md`: When configuring widget appearance, themes, or execution modes\r\n- `error-codes.md`: When debugging error codes 100*, 200*, 300*, 400*, 600*\r\n- `testing-guide.md`: When setting up E2E tests or local development\r\n- `react-integration.md`: When integrating with React, Next.js, or encountering React-specific issues\r\n\r\n### Templates (templates/)\r\n\r\n- `wrangler-turnstile-config.jsonc` - Cloudflare Workers environment configuration\r\n- `turnstile-widget-implicit.html` - Implicit rendering HTML example\r\n- `turnstile-widget-explicit.ts` - Explicit rendering JavaScript API\r\n- `turnstile-server-validation.ts` - Siteverify API validation function\r\n- `turnstile-react-component.tsx` - React component using @marsidev/react-turnstile\r\n- `turnstile-hono-route.ts` - Hono route handler with validation\r\n- `turnstile-test-config.ts` - Testing configuration with dummy keys\r\n\r\n---"
  }
}
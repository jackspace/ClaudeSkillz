{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/architecture.md",
      "references/common-issues.md",
      "references/deployment.md"
    ]
  },
  "content": "**Production-tested**: cloudflare-worker-base-test (https://cloudflare-worker-base-test.webfonts.workers.dev)\r\n**Last Updated**: 2025-10-20\r\n**Status**: Production Ready ✅\r\n\r\n---\r\n\r\n\r\n### Step 1: Create Hono App with API Routes\r\n\r\nCreate `src/index.ts`:\r\n\r\n```typescript\r\n/**\r\n * Cloudflare Worker with Hono\r\n *\r\n * CRITICAL: Export pattern to prevent build errors\r\n * ✅ CORRECT: export default app\r\n * ❌ WRONG:   export default { fetch: app.fetch }\r\n */\r\n\r\nimport { Hono } from 'hono'\r\n\r\n// Type-safe environment bindings\r\ntype Bindings = {\r\n  ASSETS: Fetcher\r\n}\r\n\r\nconst app = new Hono<{ Bindings: Bindings }>()\r\n\r\n/**\r\n * API Routes\r\n * Handled BEFORE static assets due to run_worker_first config\r\n */\r\napp.get('/api/hello', (c) => {\r\n  return c.json({\r\n    message: 'Hello from Cloudflare Workers!',\r\n    timestamp: new Date().toISOString(),\r\n  })\r\n})\r\n\r\napp.get('/api/health', (c) => {\r\n  return c.json({\r\n    status: 'ok',\r\n    version: '1.0.0',\r\n    environment: c.env ? 'production' : 'development',\r\n  })\r\n})\r\n\r\n/**\r\n * Fallback to Static Assets\r\n * Any route not matched above is served from public/ directory\r\n */\r\napp.all('*', (c) => {\r\n  return c.env.ASSETS.fetch(c.req.raw)\r\n})\r\n\r\n/**\r\n * Export the Hono app directly (ES Module format)\r\n * This is the correct pattern for Cloudflare Workers with Hono + Vite\r\n */\r\nexport default app\r\n```\r\n\r\n**Why This Export Pattern:**\r\n- Source: [honojs/hono #3955](https://github.com/honojs/hono/issues/3955)\r\n- Using `{ fetch: app.fetch }` causes: \"Cannot read properties of undefined (reading 'map')\"\r\n- Exception: If you need scheduled/tail handlers, use Module Worker format:\r\n  ```typescript\r\n  export default {\r\n    fetch: app.fetch,\r\n    scheduled: async (event, env, ctx) => { /* ... */ }\r\n  }\r\n  ```\r\n\r\n### Step 2: Create Static Frontend\r\n\r\nCreate `public/index.html`:\r\n\r\n```html\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>My Worker App</title>\r\n  <link rel=\"stylesheet\" href=\"/styles.css\">\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <h1>Cloudflare Worker + Static Assets</h1>\r\n    <button onclick=\"testAPI()\">Test API</button>\r\n    <pre id=\"output\"></pre>\r\n  </div>\r\n  <script src=\"/script.js\"></script>\r\n</body>\r\n</html>\r\n```\r\n\r\nCreate `public/script.js`:\r\n\r\n```javascript\r\nasync function testAPI() {\r\n  const response = await fetch('/api/hello')\r\n  const data = await response.json()\r\n  document.getElementById('output').textContent = JSON.stringify(data, null, 2)\r\n}\r\n```\r\n\r\nCreate `public/styles.css`:\r\n\r\n```css\r\nbody {\r\n  font-family: system-ui, -apple-system, sans-serif;\r\n  max-width: 800px;\r\n  margin: 40px auto;\r\n  padding: 20px;\r\n}\r\n\r\nbutton {\r\n  background: #0070f3;\r\n  color: white;\r\n  border: none;\r\n  padding: 12px 24px;\r\n  border-radius: 6px;\r\n  cursor: pointer;\r\n}\r\n\r\npre {\r\n  background: #f5f5f5;\r\n  padding: 16px;\r\n  border-radius: 6px;\r\n  overflow-x: auto;\r\n}\r\n```\r\n\r\n### Step 3: Update Package Scripts\r\n\r\nUpdate `package.json`:\r\n\r\n```json\r\n{\r\n  \"scripts\": {\r\n    \"dev\": \"wrangler dev\",\r\n    \"deploy\": \"wrangler deploy\",\r\n    \"cf-typegen\": \"wrangler types\"\r\n  }\r\n}\r\n```\r\n\r\n### Step 4: Test & Deploy\r\n\r\n```bash\r\nnpm run cf-typegen\r\n\r\nnpm run dev\r\n\r\n\r\n### Local Development\r\n\r\n```bash\r\nnpm run dev\r\n```\r\n\r\n- Server runs on http://localhost:8787\r\n- HMR enabled (file changes reload automatically)\r\n- Uses Miniflare for local simulation\r\n- All bindings work locally (KV, D1, R2)\r\n\r\n### Testing API Routes\r\n\r\n```bash\r\ncurl http://localhost:8787/api/hello\r\n\r\ncurl -X POST http://localhost:8787/api/echo \\\r\n  -H \"Content-Type: application/json\" \\\r\n  -d '{\"test\": \"data\"}'\r\n```\r\n\r\n### Type Generation\r\n\r\n```bash\r\nnpm run cf-typegen\r\n```\r\n\r\nGenerates `worker-configuration.d.ts` with:\r\n- Binding types (KV, D1, R2, etc.)\r\n- Environment variable types\r\n- Auto-completes in your editor\r\n\r\n### Deployment\r\n\r\n```bash\r\nnpm run deploy\r\n\r\nwrangler deploy --env staging\r\n\r\nwrangler tail",
  "name": "cloudflare-worker-base",
  "id": "cloudflare-worker-base",
  "sections": {
    "Quick Start (5 Minutes)": "### 1. Scaffold Project\r\n\r\n```bash\r\nnpm create cloudflare@latest my-worker -- \\\r\n  --type hello-world \\\r\n  --ts \\\r\n  --git \\\r\n  --deploy false \\\r\n  --framework none\r\n```\r\n\r\n**Why these flags:**\r\n- `--type hello-world`: Clean starting point\r\n- `--ts`: TypeScript support\r\n- `--git`: Initialize git repo\r\n- `--deploy false`: Don't deploy yet (configure first)\r\n- `--framework none`: We'll add Vite ourselves\r\n\r\n### 2. Install Dependencies\r\n\r\n```bash\r\ncd my-worker\r\nnpm install hono@4.10.1\r\nnpm install -D @cloudflare/vite-plugin@1.13.13 vite@latest\r\n```\r\n\r\n**Version Notes:**\r\n- `hono@4.10.1`: Latest stable (verified 2025-10-20)\r\n- `@cloudflare/vite-plugin@1.13.13`: Latest stable, fixes HMR race condition\r\n- `vite`: Latest version compatible with Cloudflare plugin\r\n\r\n### 3. Configure Wrangler\r\n\r\nCreate or update `wrangler.jsonc`:\r\n\r\n```jsonc\r\n{\r\n  \"$schema\": \"node_modules/wrangler/config-schema.json\",\r\n  \"name\": \"my-worker\",\r\n  \"main\": \"src/index.ts\",\r\n  \"account_id\": \"YOUR_ACCOUNT_ID\",\r\n  \"compatibility_date\": \"2025-10-11\",\r\n  \"observability\": {\r\n    \"enabled\": true\r\n  },\r\n  \"assets\": {\r\n    \"directory\": \"./public/\",\r\n    \"binding\": \"ASSETS\",\r\n    \"not_found_handling\": \"single-page-application\",\r\n    \"run_worker_first\": [\"/api/*\"]\r\n  }\r\n}\r\n```\r\n\r\n**CRITICAL: `run_worker_first` Configuration**\r\n- Without this, SPA fallback intercepts API routes\r\n- API routes return `index.html` instead of JSON\r\n- Source: [workers-sdk #8879](https://github.com/cloudflare/workers-sdk/issues/8879)\r\n\r\n### 4. Configure Vite\r\n\r\nCreate `vite.config.ts`:\r\n\r\n```typescript\r\nimport { defineConfig } from 'vite'\r\nimport { cloudflare } from '@cloudflare/vite-plugin'\r\n\r\nexport default defineConfig({\r\n  plugins: [\r\n    cloudflare({\r\n      // Optional: Configure the plugin if needed\r\n    }),\r\n  ],\r\n})\r\n```\r\n\r\n**Why @cloudflare/vite-plugin:**\r\n- Official plugin from Cloudflare\r\n- Supports HMR with Workers\r\n- Enables local development with Miniflare\r\n- Version 1.13.13 fixes \"A hanging Promise was canceled\" error\r\n\r\n---",
    "Known Issues Prevention": "This skill prevents **6 documented issues**:\r\n\r\n### Issue #1: Export Syntax Error\r\n**Error**: \"Cannot read properties of undefined (reading 'map')\"\r\n**Source**: [honojs/hono #3955](https://github.com/honojs/hono/issues/3955)\r\n**Prevention**: Use `export default app` (NOT `{ fetch: app.fetch }`)\r\n\r\n### Issue #2: Static Assets Routing Conflicts\r\n**Error**: API routes return `index.html` instead of JSON\r\n**Source**: [workers-sdk #8879](https://github.com/cloudflare/workers-sdk/issues/8879)\r\n**Prevention**: Add `\"run_worker_first\": [\"/api/*\"]` to wrangler.jsonc\r\n\r\n### Issue #3: Scheduled/Cron Not Exported\r\n**Error**: \"Handler does not export a scheduled() function\"\r\n**Source**: [honojs/vite-plugins #275](https://github.com/honojs/vite-plugins/issues/275)\r\n**Prevention**: Use Module Worker format when needed:\r\n```typescript\r\nexport default {\r\n  fetch: app.fetch,\r\n  scheduled: async (event, env, ctx) => { /* ... */ }\r\n}\r\n```\r\n\r\n### Issue #4: HMR Race Condition\r\n**Error**: \"A hanging Promise was canceled\" during development\r\n**Source**: [workers-sdk #9518](https://github.com/cloudflare/workers-sdk/issues/9518)\r\n**Prevention**: Use `@cloudflare/vite-plugin@1.13.13` or later\r\n\r\n### Issue #5: Static Assets Upload Race\r\n**Error**: Non-deterministic deployment failures in CI/CD\r\n**Source**: [workers-sdk #7555](https://github.com/cloudflare/workers-sdk/issues/7555)\r\n**Prevention**: Use Wrangler 4.x+ with retry logic (fixed in recent versions)\r\n\r\n### Issue #6: Service Worker Format Confusion\r\n**Error**: Using deprecated Service Worker format\r\n**Source**: Cloudflare migration guide\r\n**Prevention**: Always use ES Module format (shown in Step 1)\r\n\r\n---",
    "The Four-Step Setup Process": "npm run deploy\r\n```\r\n\r\n---",
    "Production Example": "This skill is based on the cloudflare-worker-base-test project:\r\n- **Live**: https://cloudflare-worker-base-test.webfonts.workers.dev\r\n- **Build Time**: ~45 minutes (actual)\r\n- **Errors**: 0 (all 6 known issues prevented)\r\n- **Validation**: ✅ Local dev, HMR, production deployment all successful\r\n\r\nAll patterns in this skill have been validated in production.\r\n\r\n---\r\n\r\n**Questions? Issues?**\r\n\r\n1. Check `reference/common-issues.md` first\r\n2. Verify all steps in the 4-step setup process\r\n3. Ensure `export default app` (not `{ fetch: app.fetch }`)\r\n4. Ensure `run_worker_first` is configured\r\n5. Check official docs: https://developers.cloudflare.com/workers/",
    "Reference Documentation": "For deeper understanding, see:\r\n\r\n- **architecture.md** - Deep dive into export patterns, routing, and Static Assets\r\n- **common-issues.md** - All 6 issues with detailed troubleshooting\r\n- **deployment.md** - Wrangler commands, CI/CD patterns, and production tips\r\n\r\n---",
    "Complete Setup Checklist": "- [ ] Project scaffolded with `npm create cloudflare@latest`\r\n- [ ] Dependencies installed: `hono@4.10.1`, `@cloudflare/vite-plugin@1.13.13`\r\n- [ ] `wrangler.jsonc` created with:\r\n  - [ ] `account_id` set to your Cloudflare account\r\n  - [ ] `assets.directory` pointing to `./public/`\r\n  - [ ] `assets.run_worker_first` includes `/api/*`\r\n  - [ ] `compatibility_date` set to recent date\r\n- [ ] `vite.config.ts` created with `@cloudflare/vite-plugin`\r\n- [ ] `src/index.ts` created with Hono app\r\n  - [ ] Uses `export default app` (NOT `{ fetch: app.fetch }`)\r\n  - [ ] Includes ASSETS binding type\r\n  - [ ] Has fallback route: `app.all('*', (c) => c.env.ASSETS.fetch(c.req.raw))`\r\n- [ ] `public/` directory created with static files\r\n- [ ] `npm run cf-typegen` executed successfully\r\n- [ ] `npm run dev` starts without errors\r\n- [ ] API routes tested in browser/curl\r\n- [ ] Static assets serve correctly\r\n- [ ] HMR works without crashes\r\n- [ ] Ready to deploy with `npm run deploy`\r\n\r\n---",
    "Development Workflow": "wrangler deployments list\r\n```\r\n\r\n---",
    "API Route Patterns": "### Basic JSON Response\r\n\r\n```typescript\r\napp.get('/api/users', (c) => {\r\n  return c.json({\r\n    users: [\r\n      { id: 1, name: 'Alice' },\r\n      { id: 2, name: 'Bob' }\r\n    ]\r\n  })\r\n})\r\n```\r\n\r\n### POST with Request Body\r\n\r\n```typescript\r\napp.post('/api/users', async (c) => {\r\n  const body = await c.req.json()\r\n\r\n  // Validate and process body\r\n  return c.json({ success: true, data: body }, 201)\r\n})\r\n```\r\n\r\n### Route Parameters\r\n\r\n```typescript\r\napp.get('/api/users/:id', (c) => {\r\n  const id = c.req.param('id')\r\n  return c.json({ id, name: 'User' })\r\n})\r\n```\r\n\r\n### Query Parameters\r\n\r\n```typescript\r\napp.get('/api/search', (c) => {\r\n  const query = c.req.query('q')\r\n  return c.json({ query, results: [] })\r\n})\r\n```\r\n\r\n### Error Handling\r\n\r\n```typescript\r\napp.get('/api/data', async (c) => {\r\n  try {\r\n    // Your logic here\r\n    return c.json({ success: true })\r\n  } catch (error) {\r\n    return c.json({ error: error.message }, 500)\r\n  }\r\n})\r\n```\r\n\r\n### Using Bindings (KV, D1, R2)\r\n\r\n```typescript\r\ntype Bindings = {\r\n  ASSETS: Fetcher\r\n  MY_KV: KVNamespace\r\n  DB: D1Database\r\n  MY_BUCKET: R2Bucket\r\n}\r\n\r\nconst app = new Hono<{ Bindings: Bindings }>()\r\n\r\napp.get('/api/data', async (c) => {\r\n  // KV\r\n  const value = await c.env.MY_KV.get('key')\r\n\r\n  // D1\r\n  const result = await c.env.DB.prepare('SELECT * FROM users').all()\r\n\r\n  // R2\r\n  const object = await c.env.MY_BUCKET.get('file.txt')\r\n\r\n  return c.json({ value, result, object })\r\n})\r\n```\r\n\r\n---",
    "Static Assets Best Practices": "### Directory Structure\r\n\r\n```\r\npublic/\r\n├── index.html          # Main entry point\r\n├── styles.css          # Global styles\r\n├── script.js           # Client-side JavaScript\r\n├── favicon.ico         # Favicon\r\n└── assets/             # Images, fonts, etc.\r\n    ├── logo.png\r\n    └── fonts/\r\n```\r\n\r\n### SPA Fallback\r\n\r\nThe `\"not_found_handling\": \"single-page-application\"` configuration means:\r\n- Unknown routes return `index.html`\r\n- Useful for React Router, Vue Router, etc.\r\n- BUT requires `run_worker_first` for API routes!\r\n\r\n### Route Priority\r\n\r\nWith `\"run_worker_first\": [\"/api/*\"]`:\r\n\r\n1. `/api/hello` → Worker handles it (returns JSON)\r\n2. `/` → Static Assets serve `index.html`\r\n3. `/styles.css` → Static Assets serve `styles.css`\r\n4. `/unknown` → Static Assets serve `index.html` (SPA fallback)\r\n\r\n### Caching Static Assets\r\n\r\nStatic Assets are automatically cached at the edge. To bust cache:\r\n```html\r\n<link rel=\"stylesheet\" href=\"/styles.css?v=1.0.0\">\r\n<script src=\"/script.js?v=1.0.0\"></script>\r\n```\r\n\r\n---",
    "File Templates": "All templates are available in the `templates/` directory:\r\n\r\n- **wrangler.jsonc** - Complete Worker configuration\r\n- **vite.config.ts** - Vite + Cloudflare plugin setup\r\n- **package.json** - Dependencies and scripts\r\n- **tsconfig.json** - TypeScript configuration\r\n- **src/index.ts** - Hono app with API routes\r\n- **public/index.html** - Static frontend example\r\n- **public/styles.css** - Example styling\r\n- **public/script.js** - API test functions\r\n\r\nCopy these files to your project and customize as needed.\r\n\r\n---",
    "Advanced Topics": "### Adding Middleware\r\n\r\n```typescript\r\nimport { Hono } from 'hono'\r\nimport { logger } from 'hono/logger'\r\nimport { cors } from 'hono/cors'\r\n\r\nconst app = new Hono<{ Bindings: Bindings }>()\r\n\r\n// Global middleware\r\napp.use('*', logger())\r\napp.use('/api/*', cors())\r\n\r\n// Route-specific middleware\r\napp.use('/admin/*', async (c, next) => {\r\n  // Auth check\r\n  await next()\r\n})\r\n```\r\n\r\n### Environment-Specific Configuration\r\n\r\n```jsonc\r\n// wrangler.jsonc\r\n{\r\n  \"name\": \"my-worker\",\r\n  \"env\": {\r\n    \"staging\": {\r\n      \"vars\": { \"ENV\": \"staging\" }\r\n    },\r\n    \"production\": {\r\n      \"vars\": { \"ENV\": \"production\" }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nDeploy: `wrangler deploy --env staging`\r\n\r\n### Custom Error Pages\r\n\r\n```typescript\r\napp.onError((err, c) => {\r\n  console.error(err)\r\n  return c.json({ error: 'Internal Server Error' }, 500)\r\n})\r\n\r\napp.notFound((c) => {\r\n  return c.json({ error: 'Not Found' }, 404)\r\n})\r\n```\r\n\r\n### Testing with Vitest\r\n\r\n```bash\r\nnpm install -D vitest @cloudflare/vitest-pool-workers\r\n```\r\n\r\nCreate `vitest.config.ts`:\r\n\r\n```typescript\r\nimport { defineConfig } from 'vitest/config'\r\n\r\nexport default defineConfig({\r\n  test: {\r\n    poolOptions: {\r\n      workers: {\r\n        wrangler: { configPath: './wrangler.jsonc' },\r\n      },\r\n    },\r\n  },\r\n})\r\n```\r\n\r\nSee `reference/testing.md` for complete testing guide.\r\n\r\n---",
    "Dependencies (Latest Verified 2025-10-20)": "```json\r\n{\r\n  \"dependencies\": {\r\n    \"hono\": \"^4.10.1\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@cloudflare/vite-plugin\": \"^1.13.13\",\r\n    \"@cloudflare/workers-types\": \"^4.20251011.0\",\r\n    \"vite\": \"^7.0.0\",\r\n    \"wrangler\": \"^4.43.0\",\r\n    \"typescript\": \"^5.9.0\"\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Official Documentation": "- **Cloudflare Workers**: https://developers.cloudflare.com/workers/\r\n- **Static Assets**: https://developers.cloudflare.com/workers/static-assets/\r\n- **Vite Plugin**: https://developers.cloudflare.com/workers/vite-plugin/\r\n- **Wrangler Configuration**: https://developers.cloudflare.com/workers/wrangler/configuration/\r\n- **Hono**: https://hono.dev/docs/getting-started/cloudflare-workers\r\n- **Context7 Library ID**: `/websites/developers_cloudflare-workers`\r\n\r\n---",
    "Configuration Files Reference": "### wrangler.jsonc (Full Example)\r\n\r\n```jsonc\r\n{\r\n  \"$schema\": \"node_modules/wrangler/config-schema.json\",\r\n  \"name\": \"my-worker\",\r\n  \"main\": \"src/index.ts\",\r\n  \"account_id\": \"YOUR_ACCOUNT_ID\",\r\n  \"compatibility_date\": \"2025-10-11\",\r\n  \"observability\": {\r\n    \"enabled\": true\r\n  },\r\n  \"assets\": {\r\n    \"directory\": \"./public/\",\r\n    \"binding\": \"ASSETS\",\r\n    \"not_found_handling\": \"single-page-application\",\r\n    \"run_worker_first\": [\"/api/*\"]\r\n  }\r\n  /* Optional: Environment Variables */\r\n  // \"vars\": { \"MY_VARIABLE\": \"production_value\" }\r\n\r\n  /* Optional: KV Namespace Bindings */\r\n  // \"kv_namespaces\": [\r\n  //   { \"binding\": \"MY_KV\", \"id\": \"YOUR_KV_ID\" }\r\n  // ]\r\n\r\n  /* Optional: D1 Database Bindings */\r\n  // \"d1_databases\": [\r\n  //   { \"binding\": \"DB\", \"database_name\": \"my-db\", \"database_id\": \"YOUR_DB_ID\" }\r\n  // ]\r\n\r\n  /* Optional: R2 Bucket Bindings */\r\n  // \"r2_buckets\": [\r\n  //   { \"binding\": \"MY_BUCKET\", \"bucket_name\": \"my-bucket\" }\r\n  // ]\r\n}\r\n```\r\n\r\n**Why wrangler.jsonc over wrangler.toml:**\r\n- JSON format preferred since Wrangler v3.91.0\r\n- Better IDE support with JSON schema\r\n- Comments allowed with JSONC\r\n\r\n### vite.config.ts (Full Example)\r\n\r\n```typescript\r\nimport { defineConfig } from 'vite'\r\nimport { cloudflare } from '@cloudflare/vite-plugin'\r\n\r\nexport default defineConfig({\r\n  plugins: [\r\n    cloudflare({\r\n      // Persist state between HMR updates\r\n      persist: true,\r\n    }),\r\n  ],\r\n\r\n  // Optional: Configure server\r\n  server: {\r\n    port: 8787,\r\n  },\r\n\r\n  // Optional: Build optimizations\r\n  build: {\r\n    target: 'esnext',\r\n    minify: true,\r\n  },\r\n})\r\n```\r\n\r\n### tsconfig.json\r\n\r\n```json\r\n{\r\n  \"compilerOptions\": {\r\n    \"target\": \"ES2022\",\r\n    \"module\": \"ES2022\",\r\n    \"lib\": [\"ES2022\"],\r\n    \"moduleResolution\": \"bundler\",\r\n    \"types\": [\"@cloudflare/workers-types/2023-07-01\"],\r\n    \"resolveJsonModule\": true,\r\n    \"allowJs\": true,\r\n    \"checkJs\": false,\r\n    \"strict\": true,\r\n    \"esModuleInterop\": true,\r\n    \"skipLibCheck\": true,\r\n    \"forceConsistentCasingInFileNames\": true,\r\n    \"isolatedModules\": true,\r\n    \"noEmit\": true\r\n  },\r\n  \"include\": [\"src/**/*\"],\r\n  \"exclude\": [\"node_modules\"]\r\n}\r\n```\r\n\r\n---"
  }
}